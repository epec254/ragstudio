

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how to perform distributed training of machine learning models using HorovodRunner to launch Horovod training jobs as Spark jobs on Databricks." name="description" />
<meta content="false" name="lint" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="HorovodRunner: distributed deep learning with Horovod">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>HorovodRunner: distributed deep learning with Horovod &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/machine-learning/train-model/distributed-training/horovod-runner.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/machine-learning/train-model/distributed-training/horovod-runner.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/machine-learning/train-model/distributed-training/horovod-runner.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../../../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../../../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../../../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../../../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" />
  <link rel="top" title="Databricks on AWS" href="../../../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../../../en/machine-learning/train-model/distributed-training/horovod-runner.html" class="notranslate">English</option>
    <option value="../../../../ja/machine-learning/train-model/distributed-training/horovod-runner.html" class="notranslate">日本語</option>
    <option value="../../../../pt/machine-learning/train-model/distributed-training/horovod-runner.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>HorovodRunner: distributed deep learning with Horovod</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="horovodrunner-distributed-deep-learning-with-horovod">
<h1>HorovodRunner: distributed deep learning with Horovod<a class="headerlink" href="#horovodrunner-distributed-deep-learning-with-horovod" title="Permalink to this headline"> </a></h1>
<p>Learn how to perform distributed training of machine learning models using HorovodRunner to launch Horovod training jobs as Spark jobs on Databricks.</p>
<div class="section" id="what-is-horovodrunner">
<h2>What is HorovodRunner?<a class="headerlink" href="#what-is-horovodrunner" title="Permalink to this headline"> </a></h2>
<p>HorovodRunner is a general API to run distributed deep learning workloads on Databricks using the <a class="reference external" href="https://github.com/horovod/horovod">Horovod</a> framework. By integrating Horovod with Spark’s <a class="reference external" href="https://jira.apache.org/jira/browse/SPARK-24374">barrier mode</a>, Databricks is able to provide higher stability for long-running deep learning training jobs on Spark. HorovodRunner takes a Python method that contains deep learning training code with Horovod hooks. HorovodRunner pickles the method on the driver and distributes it to Spark workers. A Horovod MPI job is embedded as a Spark job using the barrier execution mode. The first executor collects the IP addresses of all task executors using <code class="docutils literal notranslate"><span class="pre">BarrierTaskContext</span></code> and triggers a Horovod job using <code class="docutils literal notranslate"><span class="pre">mpirun</span></code>. Each Python MPI process loads the pickled user program, deserializes it, and runs it.</p>
<div class="figure align-default">
<img alt="HorovodRunner" src="../../../_images/horovod-runner.png" />
</div>
</div>
<div class="section" id="distributed-training-with-horovodrunner">
<h2>Distributed training with HorovodRunner<a class="headerlink" href="#distributed-training-with-horovodrunner" title="Permalink to this headline"> </a></h2>
<p>HorovodRunner lets you launch Horovod training jobs as Spark jobs. The HorovodRunner API supports the methods shown in the table. For details, see the <a class="reference external" href="https://databricks.github.io/spark-deep-learning/#sparkdl.HorovodRunner">HorovodRunner API documentation</a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method and signature</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> <strong><code class="docutils literal notranslate"><span class="pre">init(self,</span> <span class="pre">np)</span></code></strong></p></td>
<td><p> Create an instance of HorovodRunner.</p></td>
</tr>
<tr class="row-odd"><td><p> <strong><code class="docutils literal notranslate"><span class="pre">run(self,</span> <span class="pre">main,</span> <span class="pre">**kwargs)</span></code></strong></p></td>
<td><p> Run a Horovod training job invoking <code class="docutils literal notranslate"><span class="pre">main(**kwargs)</span></code>. The main function and the keyword arguments are serialized using cloudpickle and distributed to cluster workers.</p></td>
</tr>
</tbody>
</table>
<p>The general approach to developing a distributed training program using HorovodRunner is:</p>
<ol class="arabic simple">
<li><p>Create a <code class="docutils literal notranslate"><span class="pre">HorovodRunner</span></code> instance initialized with the number of nodes.</p></li>
<li><p>Define a Horovod training method according to the methods described in <a class="reference external" href="https://github.com/horovod/horovod#usage">Horovod usage</a>, making sure to add any import statements inside the method.</p></li>
<li><p>Pass the training method to the <code class="docutils literal notranslate"><span class="pre">HorovodRunner</span></code> instance.</p></li>
</ol>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hr</span> <span class="o">=</span> <span class="n">HorovodRunner</span><span class="p">(</span><span class="n">np</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">():</span>
  <span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
  <span class="n">hvd</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="n">hr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</pre></div>
</div>
<p>To run HorovodRunner on the driver only with <code class="docutils literal notranslate"><span class="pre">n</span></code> subprocesses, use <code class="docutils literal notranslate"><span class="pre">hr</span> <span class="pre">=</span> <span class="pre">HorovodRunner(np=-n)</span></code>. For example, if there are 4 GPUs on the driver node, you can choose <code class="docutils literal notranslate"><span class="pre">n</span></code> up to <code class="docutils literal notranslate"><span class="pre">4</span></code>. For details about the parameter <code class="docutils literal notranslate"><span class="pre">np</span></code>, see the <a class="reference external" href="https://databricks.github.io/spark-deep-learning/#api-documentation">HorovodRunner API documentation</a>. For details about how to pin one GPU per subprocess, see the <a class="reference external" href="https://github.com/horovod/horovod#usage">Horovod usage guide</a>.</p>
<p>A common error is that TensorFlow objects cannot be found or pickled. This happens when the library import statements are not distributed to other executors. To avoid this issue, include all import statements (for example, <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">tensorflow</span> <span class="pre">as</span> <span class="pre">tf</span></code>) <em>both</em> at the top of the Horovod training method and inside any other user-defined functions called in the Horovod training method.</p>
</div>
<div class="section" id="record-horovod-training-with-horovod-timeline">
<span id="horovod-timeline"></span><h2>Record Horovod training with Horovod Timeline<a class="headerlink" href="#record-horovod-training-with-horovod-timeline" title="Permalink to this headline"> </a></h2>
<p>Horovod has the ability to record the timeline of its activity, called <a class="reference external" href="https://horovod.readthedocs.io/en/latest/timeline.html">Horovod Timeline</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Horovod Timeline has a significant impact on performance. Inception3 throughput can decrease by ~40% when Horovod Timeline is enabled. To speed up HorovodRunner jobs, do not use Horovod Timeline.</p>
<p>You cannot view the Horovod Timeline while training is in progress.</p>
</div>
<p>To record a Horovod Timeline, set the <code class="docutils literal notranslate"><span class="pre">HOROVOD_TIMELINE</span></code> environment variable to the location where you want to save the timeline file. Databricks recommends using a location on shared storage so that the timeline file can be easily retrieved. For example, you can use <a class="reference internal" href="../../../dbfs/index.html"><span class="doc">DBFS local file APIs</span></a> as shown:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">timeline_dir</span> <span class="o">=</span> <span class="s2">&quot;/dbfs/ml/horovod-timeline/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">timeline_dir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOROVOD_TIMELINE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeline_dir</span> <span class="o">+</span> <span class="s2">&quot;/horovod_timeline.json&quot;</span>
<span class="n">hr</span> <span class="o">=</span> <span class="n">HorovodRunner</span><span class="p">(</span><span class="n">np</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">hr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">run_training_horovod</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, add timeline specific code to the beginning and end of the training function. The following example notebook includes example code that you can use as a workaround to view training progress.</p>
<div class="embedded-notebook-section section" id="horovod-timeline-example-notebook">
<span id="horovod-runner-example"></span><h3>Horovod timeline example notebook<a class="headerlink" href="#horovod-timeline-example-notebook" title="Permalink to this headline"> </a></h3>
<div class="embedded-notebook">
    <p class="notebook-import-help">
        <a href="/_extras/notebooks/source/machine-learning/horovod-runner-example.html"            target="_blank">Open notebook in new tab</a>
        <button class="embedded-notebook-copy-to-clipboard"                copy-path-to-clipboard-on-click="/_extras/notebooks/source/machine-learning/horovod-runner-example.html">            <img src="/_static/clippy.svg"                alt="Copy to clipboard">            Copy link for import        </button>    <div class="embedded-notebook-container">        <div class="loading-spinner"></div>        <iframe data-src="/_extras/notebooks/source/machine-learning/horovod-runner-example.html"            id="746193280d645e8452c7c9f8dc10932c0e478b5d226caf6300210f77ff47b2a3" height="1000px" width="100%"            style="overflow-y:hidden;" scrolling="no"></iframe>    </div></div></div>
<p>To download the timeline file, use <a class="reference internal" href="../../../archive/dev-tools/cli/index.html"><span class="doc">Databricks CLI (legacy)</span></a> or <a class="reference internal" href="../../../dbfs/filestore.html"><span class="doc">FileStore</span></a>, and then use the Chrome browser’s <code class="docutils literal notranslate"><span class="pre">chrome://tracing</span></code> facility to view it. For example:</p>
<div class="figure align-default">
<img alt="Horovod timeline" src="../../../_images/mnist-timeline.png" />
</div>
</div>
<div class="section" id="development-workflow">
<h2>Development workflow<a class="headerlink" href="#development-workflow" title="Permalink to this headline"> </a></h2>
<p>These are the general steps in migrating single node deep learning code to distributed training. The <a class="reference internal" href="#examples"><span class="std std-ref">Examples: Migrate to distributed deep learning with HorovodRunner</span></a> in this section illustrate these steps.</p>
<ol class="arabic simple">
<li><p><strong>Prepare single node code:</strong> Prepare and test the single node code with TensorFlow, Keras, or PyTorch.</p></li>
<li><p><strong>Migrate to Horovod:</strong> Follow the instructions from <a class="reference external" href="https://github.com/horovod/horovod#usage">Horovod usage</a> to migrate the code with Horovod and test it on the driver:</p>
<ol class="loweralpha simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">hvd.init()</span></code> to initialize Horovod.</p></li>
<li><p>Pin a server GPU to be used by this process using <code class="docutils literal notranslate"><span class="pre">config.gpu_options.visible_device_list</span></code>. With the typical setup of one GPU per process, this can be set to local rank. In that case, the first process on the server will be allocated the first GPU, second process will be allocated the second GPU and so forth.</p></li>
<li><p>Include a shard of the dataset. This dataset operator is very useful when running distributed training, as it allows each worker to read a unique subset.</p></li>
<li><p>Scale the learning rate by number of workers. The effective batch size in synchronous distributed training is scaled by the number of workers. Increasing the learning rate compensates for the increased batch size.</p></li>
<li><p>Wrap the optimizer in <code class="docutils literal notranslate"><span class="pre">hvd.DistributedOptimizer</span></code>. The distributed optimizer delegates gradient computation to the original optimizer, averages gradients using allreduce or allgather, and then applies the averaged gradients.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">hvd.BroadcastGlobalVariablesHook(0)</span></code> to broadcast initial variable states from rank 0 to all other processes. This is necessary to ensure consistent initialization of all workers when training is started with random weights or restored from a checkpoint. Alternatively, if you’re not using <code class="docutils literal notranslate"><span class="pre">MonitoredTrainingSession</span></code>, you can execute the <code class="docutils literal notranslate"><span class="pre">hvd.broadcast_global_variables</span></code> operation after global variables have been initialized.</p></li>
<li><p>Modify your code to save checkpoints only on worker 0 to prevent other workers from corrupting them.</p></li>
</ol>
</li>
<li><p><strong>Migrate to HorovodRunner:</strong> HorovodRunner runs the Horovod training job by invoking a Python function. You must wrap the main training procedure into a single Python function. Then you can test HorovodRunner in local mode and distributed mode.</p></li>
</ol>
</div>
<div class="section" id="update-the-deep-learning-libraries">
<h2>Update the deep learning libraries<a class="headerlink" href="#update-the-deep-learning-libraries" title="Permalink to this headline"> </a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This article contains references to the term <em>slave</em>, a term that Databricks does not use. When the term is removed from the software, we’ll remove it from this article.</p>
</div>
<p>If you upgrade or downgrade TensorFlow, Keras, or PyTorch, you must reinstall Horovod so that it is compiled against the newly installed library. For example, if you want to upgrade TensorFlow, Databricks recommends using the init script from the <a class="reference internal" href="../tensorflow.html"><span class="doc">TensorFlow installation instructions</span></a> and appending the following TensorFlow specific Horovod installation code to the end of it.  See <a class="reference external" href="https://github.com/horovod/horovod#install">Horovod installation instructions</a> to work with different combinations, such as upgrading or downgrading PyTorch and other libraries.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>add-apt-repository<span class="w"> </span>-y<span class="w"> </span>ppa:ubuntu-toolchain-r/test
apt<span class="w"> </span>update
<span class="c1"># Using the same compiler that TensorFlow was built to compile Horovod</span>
apt<span class="w"> </span>install<span class="w"> </span>g++-7<span class="w"> </span>-y
update-alternatives<span class="w"> </span>--install<span class="w"> </span>/usr/bin/gcc<span class="w"> </span>gcc<span class="w"> </span>/usr/bin/gcc-7<span class="w"> </span><span class="m">60</span><span class="w"> </span>--slave<span class="w"> </span>/usr/bin/g++<span class="w"> </span>g++<span class="w"> </span>/usr/bin/g++-7

<span class="nv">HOROVOD_GPU_ALLREDUCE</span><span class="o">=</span>NCCL<span class="w"> </span><span class="nv">HOROVOD_CUDA_HOME</span><span class="o">=</span>/usr/local/cuda<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">horovod</span><span class="o">==</span><span class="m">0</span>.18.1<span class="w"> </span>--force-reinstall<span class="w"> </span>--no-deps<span class="w"> </span>--no-cache-dir
</pre></div>
</div>
</div>
<div class="section" id="examples-migrate-to-distributed-deep-learning-with-horovodrunner">
<span id="examples"></span><h2>Examples: Migrate to distributed deep learning with HorovodRunner<a class="headerlink" href="#examples-migrate-to-distributed-deep-learning-with-horovodrunner" title="Permalink to this headline"> </a></h2>
<p>The following examples, based on the <a class="reference external" href="https://en.wikipedia.org/wiki/MNIST_database">MNIST</a> dataset, demonstrate how to migrate a single-node deep learning program to distributed deep learning with HorovodRunner.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="mnist-tensorflow-keras.html">Deep learning using TensorFlow with HorovodRunner for MNIST</a></li>
<li class="toctree-l1"><a class="reference internal" href="mnist-pytorch.html">Adapt single node PyTorch to distributed deep learning</a></li>
</ul>
</div>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline"> </a></h2>
<ul class="simple">
<li><p>When working with workspace files, HorovodRunner will not work if <code class="docutils literal notranslate"><span class="pre">np</span></code> is set to greater than 1 and the notebook imports from other relative files. Consider using <a class="reference internal" href="horovod-spark.html"><span class="doc">horovod.spark</span></a> instead of <code class="docutils literal notranslate"><span class="pre">HorovodRunner</span></code>.</p></li>
</ul>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../../../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../../../_static/js/localized.js"></script>
  <script type="text/javascript" src="../../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../../../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>