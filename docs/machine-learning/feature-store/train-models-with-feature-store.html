

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how to train models and perform batch inference using features from the Databricks Feature Store." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Use features to train models">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Use features to train models &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/machine-learning/feature-store/train-models-with-feature-store.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/machine-learning/feature-store/train-models-with-feature-store.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/machine-learning/feature-store/train-models-with-feature-store.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" />
  <link rel="top" title="Databricks on AWS" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../../en/machine-learning/feature-store/train-models-with-feature-store.html" class="notranslate">English</option>
    <option value="../../../ja/machine-learning/feature-store/train-models-with-feature-store.html" class="notranslate">日本語</option>
    <option value="../../../pt/machine-learning/feature-store/train-models-with-feature-store.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Use features to train models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="use-features-to-train-models">
<h1>Use features to train models<a class="headerlink" href="#use-features-to-train-models" title="Permalink to this headline"> </a></h1>
<p>This article describes how you can train models using Feature Engineering in Unity Catalog or the local Workspace Feature Store. You must first create a training dataset, which defines the features to use and how to join them. Then, when you train a model, the model retains references to the features.</p>
<p>When you use the model for inference, you can choose to have it retrieve feature values from the feature store. You can also serve the model with <a class="reference internal" href="../model-serving/index.html"><span class="doc">Model Serving</span></a> and it will automatically lookup features <a class="reference internal" href="online-feature-stores.html"><span class="doc">published to online stores</span></a>.</p>
<div class="section" id="create-a-training-dataset">
<h2>Create a training dataset<a class="headerlink" href="#create-a-training-dataset" title="Permalink to this headline"> </a></h2>
<p>To select specific features from a feature table for model training, you create a training dataset using the <code class="docutils literal notranslate"><span class="pre">FeatureEngineeringClient.create_training_set</span></code> (for Feature Engineering in Unity Catalog) or <code class="docutils literal notranslate"><span class="pre">FeatureStoreClient.create_training_set</span></code> (for Workspace Feature Store) API and an object called a <code class="docutils literal notranslate"><span class="pre">FeatureLookup</span></code>. A <code class="docutils literal notranslate"><span class="pre">FeatureLookup</span></code> specifies each feature to use in the training set, including the name of the feature table, the name(s) of the features, and the key(s) to use when joining the feature table with the DataFrame passed to <code class="docutils literal notranslate"><span class="pre">create_training_set</span></code>. See <a class="reference internal" href="concepts.html#feature-lookup"><span class="std std-ref">Feature Lookup</span></a> for more information.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">feature_names</span></code> parameter when you create a <code class="docutils literal notranslate"><span class="pre">FeatureLookup</span></code>.
<code class="docutils literal notranslate"><span class="pre">feature_names</span></code> takes a single feature name, a list of feature names, or None to look up all features (excluding primary keys) in the feature table at the time that the training set is created.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The type and order of <code class="docutils literal notranslate"><span class="pre">lookup_key</span></code> columns in the DataFrame must match the type and order of the primary keys (excluding timestamp keys) of the reference feature table.</p>
</div>
<p>This article includes code examples for both versions of the syntax.</p>
<p>In this example, the DataFrame returned by <code class="docutils literal notranslate"><span class="pre">trainingSet.load_df</span></code> contains a column for each feature in <code class="docutils literal notranslate"><span class="pre">feature_lookups</span></code>. It preserves all columns of the DataFrame provided to <code class="docutils literal notranslate"><span class="pre">create_training_set</span></code> except those excluded using <code class="docutils literal notranslate"><span class="pre">exclude_columns</span></code>.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">databricks.feature_engineering</span> <span class="kn">import</span> <span class="n">FeatureEngineeringClient</span><span class="p">,</span> <span class="n">FeatureLookup</span>

<span class="c1"># The model training uses two features from the &#39;customer_features&#39; feature table and</span>
<span class="c1"># a single feature from &#39;product_features&#39;</span>
<span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">,</span> <span class="s1">&#39;total_purchases_7d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>

<span class="c1"># Create a training set using training DataFrame and features from Feature Store</span>
<span class="c1"># The training DataFrame must contain all lookup keys from the set of feature lookups,</span>
<span class="c1"># in this case &#39;customer_id&#39; and &#39;product_id&#39;. It must also contain all labels used</span>
<span class="c1"># for training, in this case &#39;rating&#39;.</span>
<span class="n">training_set</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
  <span class="n">df</span><span class="o">=</span><span class="n">training_df</span><span class="p">,</span>
  <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
  <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">databricks.feature_store</span> <span class="kn">import</span> <span class="n">FeatureLookup</span><span class="p">,</span> <span class="n">FeatureStoreClient</span>

<span class="c1"># The model training uses two features from the &#39;customer_features&#39; feature table and</span>
<span class="c1"># a single feature from &#39;product_features&#39;</span>
<span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">,</span> <span class="s1">&#39;total_purchases_7d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>

<span class="c1"># Create a training set using training DataFrame and features from Feature Store</span>
<span class="c1"># The training DataFrame must contain all lookup keys from the set of feature lookups,</span>
<span class="c1"># in this case &#39;customer_id&#39; and &#39;product_id&#39;. It must also contain all labels used</span>
<span class="c1"># for training, in this case &#39;rating&#39;.</span>
<span class="n">training_set</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
  <span class="n">df</span><span class="o">=</span><span class="n">training_df</span><span class="p">,</span>
  <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
  <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-a-trainingset-when-lookup-keys-do-not-match-the-primary-keys">
<h3>Create a TrainingSet when lookup keys do not match the primary keys<a class="headerlink" href="#create-a-trainingset-when-lookup-keys-do-not-match-the-primary-keys" title="Permalink to this headline"> </a></h3>
<p>Use the argument <code class="docutils literal notranslate"><span class="pre">lookup_key</span></code> in the <code class="docutils literal notranslate"><span class="pre">FeatureLookup</span></code> for the column name in the training set. <code class="docutils literal notranslate"><span class="pre">create_training_set</span></code> performs an ordered join between the columns from the training set specified in the <code class="docutils literal notranslate"><span class="pre">lookup_key</span></code> argument using the order in which the primary keys were specified when the feature table was created.</p>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">recommender_system.customer_features</span></code> has the following primary keys: <code class="docutils literal notranslate"><span class="pre">customer_id</span></code>, <code class="docutils literal notranslate"><span class="pre">dt</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">recommender_system.product_features</span></code> feature table has primary key <code class="docutils literal notranslate"><span class="pre">product_id</span></code>.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">training_df</span></code> has the following columns:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cid</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transaction_dt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">product_id</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rating</span></code></p></li>
</ul>
<p>the following code will create the correct feature lookups for the <code class="docutils literal notranslate"><span class="pre">TrainingSet</span></code>:</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">,</span> <span class="s1">&#39;total_purchases_7d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span> <span class="s1">&#39;transaction_dt&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">,</span> <span class="s1">&#39;total_purchases_7d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span> <span class="s1">&#39;transaction_dt&#39;</span><span class="p">]</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">create_training_set</span></code> is called, it creates a training dataset by performing a left join, joining the tables <code class="docutils literal notranslate"><span class="pre">recommender_system.customer_features</span></code> and <code class="docutils literal notranslate"><span class="pre">training_df</span></code> using the keys (<code class="docutils literal notranslate"><span class="pre">customer_id</span></code>,<code class="docutils literal notranslate"><span class="pre">dt</span></code>) corresponding to (<code class="docutils literal notranslate"><span class="pre">cid</span></code>,<code class="docutils literal notranslate"><span class="pre">transaction_dt</span></code>), as shown in the following code:</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">customer_features_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ml.recommender_system.customer_features&quot;</span><span class="p">)</span>
<span class="n">product_features_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM ml.recommender_system.product_features&quot;</span><span class="p">)</span>

<span class="n">training_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
  <span class="n">customer_features_df</span><span class="p">,</span>
  <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">training_df</span><span class="o">.</span><span class="n">cid</span> <span class="o">==</span> <span class="n">customer_features_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
      <span class="n">training_df</span><span class="o">.</span><span class="n">transaction_dt</span> <span class="o">==</span> <span class="n">customer_features_df</span><span class="o">.</span><span class="n">dt</span><span class="p">],</span>
  <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
  <span class="n">product_features_df</span><span class="p">,</span>
  <span class="n">on</span><span class="o">=</span><span class="s2">&quot;product_id&quot;</span><span class="p">,</span>
  <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">customer_features_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM recommender_system.customer_features&quot;</span><span class="p">)</span>
<span class="n">product_features_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM recommender_system.product_features&quot;</span><span class="p">)</span>

<span class="n">training_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
  <span class="n">customer_features_df</span><span class="p">,</span>
  <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">training_df</span><span class="o">.</span><span class="n">cid</span> <span class="o">==</span> <span class="n">customer_features_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
      <span class="n">training_df</span><span class="o">.</span><span class="n">transaction_dt</span> <span class="o">==</span> <span class="n">customer_features_df</span><span class="o">.</span><span class="n">dt</span><span class="p">],</span>
  <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
  <span class="n">product_features_df</span><span class="p">,</span>
  <span class="n">on</span><span class="o">=</span><span class="s2">&quot;product_id&quot;</span><span class="p">,</span>
  <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-a-trainingset-containing-two-features-with-the-same-name-from-different-feature-tables">
<h3>Create a TrainingSet containing two features with the same name from different feature tables<a class="headerlink" href="#create-a-trainingset-containing-two-features-with-the-same-name-from-different-feature-tables" title="Permalink to this headline"> </a></h3>
<p>Use the optional argument <code class="docutils literal notranslate"><span class="pre">output_name</span></code> in the <code class="docutils literal notranslate"><span class="pre">FeatureLookup</span></code>. The name provided is used in place of the feature name in the DataFrame returned by <code class="docutils literal notranslate"><span class="pre">TrainingSet.load_df</span></code>. For example, with the following code, the DataFrame returned by <code class="docutils literal notranslate"><span class="pre">training_set.load_df</span></code> includes columns <code class="docutils literal notranslate"><span class="pre">customer_height</span></code> and <code class="docutils literal notranslate"><span class="pre">product_height</span></code>.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;customer_height&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;product_height&#39;</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>
  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;customer_height&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;product_height&#39;</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>
  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-a-trainingset-using-the-same-feature-multiple-times">
<h3>Create a TrainingSet using the same feature multiple times<a class="headerlink" href="#create-a-trainingset-using-the-same-feature-multiple-times" title="Permalink to this headline"> </a></h3>
<p>To create a TrainingSet using the same feature joined by different lookup keys, use multiple FeatureLookups.
Use a unique <code class="docutils literal notranslate"><span class="pre">output_name</span></code> for each FeatureLookup output.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.taxi_data.zip_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pickup_zip&#39;</span><span class="p">],</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;pickup_temp&#39;</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.taxi_data.zip_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dropoff_zip&#39;</span><span class="p">],</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;dropoff_temp&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;taxi_data.zip_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pickup_zip&#39;</span><span class="p">],</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;pickup_temp&#39;</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;taxi_data.zip_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dropoff_zip&#39;</span><span class="p">],</span>
      <span class="n">output_name</span><span class="o">=</span><span class="s1">&#39;dropoff_temp&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-a-trainingset-for-unsupervised-machine-learning-models">
<h3>Create a TrainingSet for unsupervised machine learning models<a class="headerlink" href="#create-a-trainingset-for-unsupervised-machine-learning-models" title="Permalink to this headline"> </a></h3>
<p>Set <code class="docutils literal notranslate"><span class="pre">label=None</span></code> when creating a TrainingSet for unsupervised learning models. For example, the following TrainingSet can
be used to cluster different customers into groups based on their interests:</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interests&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>

  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;interests&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>

  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="train-models-and-perform-batch-inference-with-feature-tables">
<h2>Train models and perform batch inference with feature tables<a class="headerlink" href="#train-models-and-perform-batch-inference-with-feature-tables" title="Permalink to this headline"> </a></h2>
<p>When you train a model using features from Feature Store, the model retains references to the features. When you use the model for inference, you can choose to have it retrieve feature values from Feature Store. You must provide the primary key(s) of the features used in the model. The model retrieves the features it requires from Feature Store in your workspace. It then joins the feature values as needed during scoring.</p>
<p>To support feature lookup at inference time:</p>
<ul class="simple">
<li><p>You must log the model using the <code class="docutils literal notranslate"><span class="pre">log_model</span></code> method of <code class="docutils literal notranslate"><span class="pre">FeatureEngineeringClient</span></code> (for Feature Engineering in Unity Catalog) or <code class="docutils literal notranslate"><span class="pre">FeatureStoreClient</span></code> (for Workspace Feature Store).</p></li>
<li><p>You must use the DataFrame returned by <code class="docutils literal notranslate"><span class="pre">TrainingSet.load_df</span></code> to train the model. If you modify this DataFrame in any way before using it to train the model, the modifications are not applied when you use the model for inference. This decreases the performance of the model.</p></li>
<li><p>The model type must have a corresponding <code class="docutils literal notranslate"><span class="pre">python_flavor</span></code> in MLflow. MLflow supports most Python model training frameworks, including:</p>
<ul>
<li><p>scikit-learn</p></li>
<li><p>keras</p></li>
<li><p>PyTorch</p></li>
<li><p>SparkML</p></li>
<li><p>LightGBM</p></li>
<li><p>XGBoost</p></li>
<li><p>TensorFlow Keras (using the <code class="docutils literal notranslate"><span class="pre">python_flavor</span></code> <code class="docutils literal notranslate"><span class="pre">mlflow.keras</span></code>)</p></li>
</ul>
</li>
<li><p>Custom MLflow pyfunc models</p></li>
</ul>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train model</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>

<span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>

  <span class="c1"># df has columns [&#39;customer_id&#39;, &#39;product_id&#39;, &#39;rating&#39;]</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>

  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

  <span class="c1"># &quot;training_df&quot; columns [&#39;total_purchases_30d&#39;, &#39;category&#39;, &#39;rating&#39;]</span>
  <span class="n">X_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">y_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">rating</span>

  <span class="n">model</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

  <span class="n">fe</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;recommendation_model&quot;</span><span class="p">,</span>
    <span class="n">flavor</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="p">,</span>
    <span class="n">training_set</span><span class="o">=</span><span class="n">training_set</span><span class="p">,</span>
    <span class="n">registered_model_name</span><span class="o">=</span><span class="s2">&quot;recommendation_model&quot;</span>
  <span class="p">)</span>

<span class="c1"># Batch inference</span>

<span class="c1"># If the model at model_uri is packaged with the features, the FeatureStoreClient.score_batch()</span>
<span class="c1"># call automatically retrieves the required features from Feature Store before scoring the model.</span>
<span class="c1"># The DataFrame returned by score_batch() augments batch_df with</span>
<span class="c1"># columns containing the feature values and a column containing model predictions.</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>

<span class="c1"># batch_df has columns ‘customer_id’ and ‘product_id’</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>

<span class="c1"># The ‘predictions’ DataFrame has these columns:</span>
<span class="c1"># ‘customer_id’, ‘product_id’, ‘total_purchases_30d’, ‘category’, ‘prediction’</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Train model</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>

<span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.product_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span>
    <span class="p">)</span>
  <span class="p">]</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>

  <span class="c1"># df has columns [&#39;customer_id&#39;, &#39;product_id&#39;, &#39;rating&#39;]</span>
  <span class="n">training_set</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
    <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">]</span>
  <span class="p">)</span>

  <span class="n">training_df</span> <span class="o">=</span> <span class="n">training_set</span><span class="o">.</span><span class="n">load_df</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>

  <span class="c1"># &quot;training_df&quot; columns [&#39;total_purchases_30d&#39;, &#39;category&#39;, &#39;rating&#39;]</span>
  <span class="n">X_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;rating&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">y_train</span> <span class="o">=</span> <span class="n">training_df</span><span class="o">.</span><span class="n">rating</span>

  <span class="n">model</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

  <span class="n">fs</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">artifact_path</span><span class="o">=</span><span class="s2">&quot;recommendation_model&quot;</span><span class="p">,</span>
    <span class="n">flavor</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="p">,</span>
    <span class="n">training_set</span><span class="o">=</span><span class="n">training_set</span><span class="p">,</span>
    <span class="n">registered_model_name</span><span class="o">=</span><span class="s2">&quot;recommendation_model&quot;</span>
  <span class="p">)</span>

<span class="c1"># Batch inference</span>

<span class="c1"># If the model at model_uri is packaged with the features, the FeatureStoreClient.score_batch()</span>
<span class="c1"># call automatically retrieves the required features from Feature Store before scoring the model.</span>
<span class="c1"># The DataFrame returned by score_batch() augments batch_df with</span>
<span class="c1"># columns containing the feature values and a column containing model predictions.</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>

<span class="c1"># batch_df has columns ‘customer_id’ and ‘product_id’</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
    <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
    <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>

<span class="c1"># The ‘predictions’ DataFrame has these columns:</span>
<span class="c1"># ‘customer_id’, ‘product_id’, ‘total_purchases_30d’, ‘category’, ‘prediction’</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="use-custom-feature-values-when-scoring-a-model-packaged-with-feature-metadata">
<h3>Use custom feature values when scoring a model packaged with feature metadata<a class="headerlink" href="#use-custom-feature-values-when-scoring-a-model-packaged-with-feature-metadata" title="Permalink to this headline"> </a></h3>
<p>By default, a model packaged with feature metadata looks up features from feature tables at inference. To use custom feature values for scoring, include them in the DataFrame passed to <code class="docutils literal notranslate"><span class="pre">FeatureEngineeringClient.score_batch</span></code> (for Feature Engineering in Unity Catalog) or <code class="docutils literal notranslate"><span class="pre">FeatureStoreClient.score_batch</span></code> (for Workspace Feature Store).</p>
<p>For example, suppose you package a model with these two features:</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;account_creation_date&#39;</span><span class="p">,</span> <span class="s1">&#39;num_lifetime_purchases&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;account_creation_date&#39;</span><span class="p">,</span> <span class="s1">&#39;num_lifetime_purchases&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>At inference, you can provide custom values for the feature <code class="docutils literal notranslate"><span class="pre">account_creation_date</span></code> by calling <code class="docutils literal notranslate"><span class="pre">score_batch</span></code> on a DataFrame that includes a column named <code class="docutils literal notranslate"><span class="pre">account_creation_date</span></code>. In this case the API looks up only the <code class="docutils literal notranslate"><span class="pre">num_lifetime_purchases</span></code> feature from Feature Store and uses the provided custom <code class="docutils literal notranslate"><span class="pre">account_creation_date</span></code> column values for model scoring.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># batch_df has columns [&#39;customer_id&#39;, &#39;account_creation_date&#39;]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
  <span class="n">model_uri</span><span class="o">=</span><span class="s1">&#39;models:/ban_prediction_model/1&#39;</span><span class="p">,</span>
  <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># batch_df has columns [&#39;customer_id&#39;, &#39;account_creation_date&#39;]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
  <span class="n">model_uri</span><span class="o">=</span><span class="s1">&#39;models:/ban_prediction_model/1&#39;</span><span class="p">,</span>
  <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-and-score-a-model-using-a-combination-of-feature-store-features-and-data-residing-outside-feature-store">
<h3>Train and score a model using a combination of Feature Store features and data residing outside Feature Store<a class="headerlink" href="#train-and-score-a-model-using-a-combination-of-feature-store-features-and-data-residing-outside-feature-store" title="Permalink to this headline"> </a></h3>
<p>You can train a model using a combination of Feature Store features and data from outside Feature Store. When you package the model with feature metadata, the model retrieves feature values from Feature Store for inference.</p>
<p>To train a model, include the extra data as columns in the DataFrame passed to <code class="docutils literal notranslate"><span class="pre">FeatureEngineeringClient.create_training_set</span></code> (for Feature Engineering in Unity Catalog) or <code class="docutils literal notranslate"><span class="pre">FeatureStoreClient.create_training_set</span></code> (for Workspace Feature Store). This example uses the feature <code class="docutils literal notranslate"><span class="pre">total_purchases_30d</span></code> from Feature Store and the external column <code class="docutils literal notranslate"><span class="pre">browser</span></code>.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;ml.recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineeringClient</span><span class="p">()</span>

<span class="c1"># df has columns [&#39;customer_id&#39;, &#39;browser&#39;, &#39;rating&#39;]</span>
<span class="n">training_set</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
  <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
  <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
  <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>  <span class="c1"># &#39;browser&#39; is not excluded</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feature_lookups</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FeatureLookup</span><span class="p">(</span>
      <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;recommender_system.customer_features&#39;</span><span class="p">,</span>
      <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;total_purchases_30d&#39;</span><span class="p">],</span>
      <span class="n">lookup_key</span><span class="o">=</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">]</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">FeatureStoreClient</span><span class="p">()</span>

<span class="c1"># df has columns [&#39;customer_id&#39;, &#39;browser&#39;, &#39;rating&#39;]</span>
<span class="n">training_set</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_set</span><span class="p">(</span>
  <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
  <span class="n">feature_lookups</span><span class="o">=</span><span class="n">feature_lookups</span><span class="p">,</span>
  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span>
  <span class="n">exclude_columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;customer_id&#39;</span><span class="p">]</span>  <span class="c1"># &#39;browser&#39; is not excluded</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>At inference, the DataFrame used in <code class="docutils literal notranslate"><span class="pre">FeatureStoreClient.score_batch</span></code> must include the <code class="docutils literal notranslate"><span class="pre">browser</span></code> column.</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="Feature&amp;nbsp;Engineering&amp;nbsp;in&amp;nbsp;Unity&amp;nbsp;Catalog">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># At inference, &#39;browser&#39; must be provided</span>
<span class="c1"># batch_df has columns [&#39;customer_id&#39;, &#39;browser&#39;]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
  <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
  <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="Workspace&amp;nbsp;Feature&amp;nbsp;Store">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># At inference, &#39;browser&#39; must be provided</span>
<span class="c1"># batch_df has columns [&#39;customer_id&#39;, &#39;browser&#39;]</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">score_batch</span><span class="p">(</span>
  <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
  <span class="n">df</span><span class="o">=</span><span class="n">batch_df</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../../_static/js/localized.js"></script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>