

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Upsert data into a Delta Lake table using merge on Databricks." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Upsert into a Delta Lake table using merge">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Upsert into a Delta Lake table using merge &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/delta/merge.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/delta/merge.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/delta/merge.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="top" title="Databricks on AWS" href="../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../en/delta/merge.html" class="notranslate">English</option>
    <option value="../../ja/delta/merge.html" class="notranslate">日本語</option>
    <option value="../../pt/delta/merge.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Upsert into a Delta Lake table using merge</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="upsert-into-a-delta-lake-table-using-merge">
<span id="upsert-into-a-delta-table-using-merge"></span><h1>Upsert into a Delta Lake table using merge<a class="headerlink" href="#upsert-into-a-delta-lake-table-using-merge" title="Permalink to this headline"> </a></h1>
<p>You can upsert data from a source table, view, or DataFrame into a target Delta table by using the <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> SQL operation. Delta Lake supports inserts, updates, and deletes in <code class="docutils literal notranslate"><span class="pre">MERGE</span></code>, and it supports extended syntax beyond the SQL standards to facilitate advanced use cases.</p>
<p>Suppose you have a source table named <code class="docutils literal notranslate"><span class="pre">people10mupdates</span></code> or a source path at <code class="docutils literal notranslate"><span class="pre">/tmp/delta/people-10m-updates</span></code> that contains new data for a target table named <code class="docutils literal notranslate"><span class="pre">people10m</span></code> or a target path at <code class="docutils literal notranslate"><span class="pre">/tmp/delta/people-10m</span></code>. Some of these new records may already be present in the target data. To merge the new data, you want to update rows where the person’s <code class="docutils literal notranslate"><span class="pre">id</span></code> is already present and insert the new rows where no matching <code class="docutils literal notranslate"><span class="pre">id</span></code> is present. You can run the following query:</p>
<div class="js-code-language-tabs compound">
<div class="compound-first compound" lang="sql">
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">people10m</span>
<span class="k">USING</span><span class="w"> </span><span class="n">people10mupdates</span>
<span class="k">ON</span><span class="w"> </span><span class="n">people10m</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">    </span><span class="n">firstName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">firstName</span><span class="p">,</span>
<span class="w">    </span><span class="n">middleName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">middleName</span><span class="p">,</span>
<span class="w">    </span><span class="n">lastName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">lastName</span><span class="p">,</span>
<span class="w">    </span><span class="n">gender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span>
<span class="w">    </span><span class="n">birthDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">birthDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">ssn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">ssn</span><span class="p">,</span>
<span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">salary</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span>
<span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="p">,</span>
<span class="w">    </span><span class="n">firstName</span><span class="p">,</span>
<span class="w">    </span><span class="n">middleName</span><span class="p">,</span>
<span class="w">    </span><span class="n">lastName</span><span class="p">,</span>
<span class="w">    </span><span class="n">gender</span><span class="p">,</span>
<span class="w">    </span><span class="n">birthDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">ssn</span><span class="p">,</span>
<span class="w">    </span><span class="n">salary</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">firstName</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">middleName</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">lastName</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">birthDate</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">ssn</span><span class="p">,</span>
<span class="w">    </span><span class="n">people10mupdates</span><span class="p">.</span><span class="n">salary</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="compound-middle compound" lang="python">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">delta.tables</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">deltaTablePeople</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">&#39;/tmp/delta/people-10m&#39;</span><span class="p">)</span>
<span class="n">deltaTablePeopleUpdates</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="s1">&#39;/tmp/delta/people-10m-updates&#39;</span><span class="p">)</span>

<span class="n">dfUpdates</span> <span class="o">=</span> <span class="n">deltaTablePeopleUpdates</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span>

<span class="n">deltaTablePeople</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;people&#39;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">dfUpdates</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;updates&#39;</span><span class="p">),</span>
    <span class="s1">&#39;people.id = updates.id&#39;</span>
  <span class="p">)</span> \
  <span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span><span class="nb">set</span> <span class="o">=</span>
    <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.id&quot;</span><span class="p">,</span>
      <span class="s2">&quot;firstName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.firstName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;middleName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.middleName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;lastName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.lastName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.gender&quot;</span><span class="p">,</span>
      <span class="s2">&quot;birthDate&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.birthDate&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ssn&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.ssn&quot;</span><span class="p">,</span>
      <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.salary&quot;</span>
    <span class="p">}</span>
  <span class="p">)</span> \
  <span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span>
    <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.id&quot;</span><span class="p">,</span>
      <span class="s2">&quot;firstName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.firstName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;middleName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.middleName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;lastName&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.lastName&quot;</span><span class="p">,</span>
      <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.gender&quot;</span><span class="p">,</span>
      <span class="s2">&quot;birthDate&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.birthDate&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ssn&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.ssn&quot;</span><span class="p">,</span>
      <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;updates.salary&quot;</span>
    <span class="p">}</span>
  <span class="p">)</span> \
  <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="compound-last compound" lang="scala">
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">io</span><span class="p">.</span><span class="nn">delta</span><span class="p">.</span><span class="nn">tables</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">functions</span><span class="p">.</span><span class="n">_</span>

<span class="kd">val</span><span class="w"> </span><span class="n">deltaTablePeople</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DeltaTable</span><span class="p">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/tmp/delta/people-10m&quot;</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">deltaTablePeopleUpdates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DeltaTable</span><span class="p">.</span><span class="n">forPath</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tmp/delta/people-10m-updates&quot;</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">dfUpdates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deltaTablePeopleUpdates</span><span class="p">.</span><span class="n">toDF</span><span class="p">()</span>

<span class="n">deltaTablePeople</span>
<span class="w">  </span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;people&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">dfUpdates</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;updates&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;people.id = updates.id&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenMatched</span>
<span class="w">  </span><span class="p">.</span><span class="n">updateExpr</span><span class="p">(</span>
<span class="w">    </span><span class="nc">Map</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;firstName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.firstName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;middleName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.middleName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;lastName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.lastName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;gender&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.gender&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;birthDate&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.birthDate&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;ssn&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.ssn&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;salary&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.salary&quot;</span>
<span class="w">    </span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span>
<span class="w">  </span><span class="p">.</span><span class="n">insertExpr</span><span class="p">(</span>
<span class="w">    </span><span class="nc">Map</span><span class="p">(</span>
<span class="w">      </span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.id&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;firstName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.firstName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;middleName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.middleName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;lastName&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.lastName&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;gender&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.gender&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;birthDate&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.birthDate&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;ssn&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.ssn&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;salary&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;updates.salary&quot;</span>
<span class="w">    </span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>See the <a class="reference internal" href="index.html#delta-api"><span class="std std-ref">Delta Lake API documentation</span></a> for Scala and Python syntax details. For SQL syntax details, see <a class="reference internal" href="../sql/language-manual/delta-merge-into.html"><span class="doc">MERGE INTO</span></a></p>
<div class="section" id="modify-all-unmatched-rows-using-merge">
<span id="not-matched-by-source"></span><h2>Modify all unmatched rows using merge<a class="headerlink" href="#modify-all-unmatched-rows-using-merge" title="Permalink to this headline"> </a></h2>
<p>In Databricks SQL and Databricks Runtime 12.1 and above, you can use the <code class="docutils literal notranslate"><span class="pre">WHEN</span> <span class="pre">NOT</span> <span class="pre">MATCHED</span> <span class="pre">BY</span> <span class="pre">SOURCE</span></code> clause to <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> or <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> records in the target table that do not have corresponding records in the source table. Databricks recommends adding an optional conditional clause to avoid fully rewriting the target table.</p>
<p>The following code example shows the basic syntax of using this for deletes, overwriting the target table with the contents of the source table and deleting unmatched records in the target table. For a more scalable pattern for tables where source updates and deletes are time-bound, see <a class="reference internal" href="#incremental-sync"><span class="std std-ref">Incrementally sync Delta table with source</span></a>.</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">targetDF</span>
  <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sourceDF</span><span class="p">,</span> <span class="s2">&quot;source.key = target.key&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">whenMatchedUpdateAll</span><span class="p">()</span>
  <span class="o">.</span><span class="n">whenNotMatchedInsertAll</span><span class="p">()</span>
  <span class="o">.</span><span class="n">whenNotMatchedBySourceDelete</span><span class="p">()</span>
  <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="compound-middle highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">targetDF</span>
<span class="w">  </span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sourceDF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;source.key = target.key&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">updateAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatchedBySource</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">delete</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">target</span>
<span class="k">USING</span><span class="w"> </span><span class="k">source</span>
<span class="k">ON</span><span class="w"> </span><span class="k">source</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="k">key</span>
<span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">*</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="o">*</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">SOURCE</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">DELETE</span>
</pre></div>
</div>
</div>
<p>The following example adds conditions to the <code class="docutils literal notranslate"><span class="pre">WHEN</span> <span class="pre">NOT</span> <span class="pre">MATCHED</span> <span class="pre">BY</span> <span class="pre">SOURCE</span></code> clause and specifies values to update in unmatched target rows.</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">targetDF</span>
  <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sourceDF</span><span class="p">,</span> <span class="s2">&quot;source.key = target.key&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">whenMatchedUpdate</span><span class="p">(</span>
    <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;target.lastSeen&quot;</span><span class="p">:</span> <span class="s2">&quot;source.timestamp&quot;</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="o">.</span><span class="n">whenNotMatchedInsert</span><span class="p">(</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;target.key&quot;</span><span class="p">:</span> <span class="s2">&quot;source.key&quot;</span><span class="p">,</span>
      <span class="s2">&quot;target.lastSeen&quot;</span><span class="p">:</span> <span class="s2">&quot;source.timestamp&quot;</span><span class="p">,</span>
      <span class="s2">&quot;target.status&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;active&#39;&quot;</span>
    <span class="p">}</span>
  <span class="p">)</span>
  <span class="o">.</span><span class="n">whenNotMatchedBySourceUpdate</span><span class="p">(</span>
    <span class="n">condition</span><span class="o">=</span><span class="s2">&quot;target.lastSeen &gt;= (current_date() - INTERVAL &#39;5&#39; DAY)&quot;</span><span class="p">,</span>
    <span class="nb">set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;target.status&quot;</span><span class="p">:</span> <span class="s2">&quot;&#39;inactive&#39;&quot;</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="compound-middle highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">targetDF</span>
<span class="w">  </span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sourceDF</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;source.key = target.key&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">updateExpr</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;target.lastSeen&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.timestamp&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">insertExpr</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;target.key&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.key&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;target.lastSeen&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.timestamp&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;target.status&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;&#39;active&#39;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatchedBySource</span><span class="p">(</span><span class="s">&quot;target.lastSeen &gt;= (current_date() - INTERVAL &#39;5&#39; DAY)&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">updateExpr</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;target.status&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;&#39;inactive&#39;&quot;</span><span class="p">))</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">target</span>
<span class="k">USING</span><span class="w"> </span><span class="k">source</span>
<span class="k">ON</span><span class="w"> </span><span class="k">source</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="k">key</span>
<span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">lastSeen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">source</span><span class="p">.</span><span class="k">timestamp</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">INSERT</span><span class="w"> </span><span class="p">(</span><span class="k">key</span><span class="p">,</span><span class="w"> </span><span class="n">lastSeen</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="k">source</span><span class="p">.</span><span class="k">key</span><span class="p">,</span><span class="w">  </span><span class="k">source</span><span class="p">.</span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">SOURCE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">lastSeen</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">current_date</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="k">DAY</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;inactive&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="merge-operation-semantics">
<h2>Merge operation semantics<a class="headerlink" href="#merge-operation-semantics" title="Permalink to this headline"> </a></h2>
<p>The following is a detailed description of the <code class="docutils literal notranslate"><span class="pre">merge</span></code> programmatic operation semantics.</p>
<ul>
<li><p>There can be any number of <code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> and <code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clauses.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> clauses are executed when a source row matches a target table row based on the match condition. These clauses have the following semantics.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> clauses can have at most one <code class="docutils literal notranslate"><span class="pre">update</span></code> and one <code class="docutils literal notranslate"><span class="pre">delete</span></code> action. The <code class="docutils literal notranslate"><span class="pre">update</span></code> action in <code class="docutils literal notranslate"><span class="pre">merge</span></code> only updates the specified columns (similar to the <code class="docutils literal notranslate"><span class="pre">update</span></code> <a class="reference internal" href="tutorial.html#update"><span class="std std-ref">operation</span></a>) of the matched target row. The <code class="docutils literal notranslate"><span class="pre">delete</span></code> action deletes the matched row.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> clause can have an optional condition. If this clause condition exists, the <code class="docutils literal notranslate"><span class="pre">update</span></code> or <code class="docutils literal notranslate"><span class="pre">delete</span></code> action is executed for any matching source-target row pair only when the clause condition is true.</p></li>
<li><p>If there are multiple <code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> clauses, then they are evaluated in the order they are specified. All <code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> clauses, except the last one, must have conditions.</p></li>
<li><p>If none of the <code class="docutils literal notranslate"><span class="pre">whenMatched</span></code> conditions evaluate to true for a source and target row pair that matches the merge condition, then the target row is left unchanged.</p></li>
<li><p>To update all the columns of the target Delta table with the corresponding columns of the source dataset, use <code class="docutils literal notranslate"><span class="pre">whenMatched(...).updateAll()</span></code>. This is equivalent to:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">whenMatched</span><span class="p">(...).</span><span class="n">updateExpr</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;col1&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.col1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;col2&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.col2&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...))</span>
</pre></div>
</div>
<p>for all the columns of the target Delta table. Therefore, this action assumes that the source table has the same columns as those in the target table, otherwise the query throws an analysis error.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This behavior changes when automatic schema migration is enabled. See <a class="reference internal" href="update-schema.html#merge-schema-evolution"><span class="std std-ref">automatic schema evolution</span></a> for details.</p>
</div>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clauses are executed when a source row does not match any target row based on the match condition. These clauses have the following semantics.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clauses can have only the <code class="docutils literal notranslate"><span class="pre">insert</span></code> action. The new row is generated based on the specified column and corresponding expressions. You do not need to specify all the columns in the target table. For unspecified target columns, <code class="docutils literal notranslate"><span class="pre">NULL</span></code> is inserted.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clause can have an optional condition. If the clause condition is present, a source row is inserted only if that condition is true for that row. Otherwise, the source column is ignored.</p></li>
<li><p>If there are multiple <code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clauses, then they are evaluated in the order they are specified. All <code class="docutils literal notranslate"><span class="pre">whenNotMatched</span></code> clauses, except the last one, must have conditions.</p></li>
<li><p>To insert all the columns of the target Delta table with the corresponding columns of the source dataset, use <code class="docutils literal notranslate"><span class="pre">whenNotMatched(...).insertAll()</span></code>. This is equivalent to:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">whenNotMatched</span><span class="p">(...).</span><span class="n">insertExpr</span><span class="p">(</span><span class="nc">Map</span><span class="p">(</span><span class="s">&quot;col1&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.col1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;col2&quot;</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;source.col2&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...))</span>
</pre></div>
</div>
<p>for all the columns of the target Delta table. Therefore, this action assumes that the source table has the same columns as those in the target table, otherwise the query throws an analysis error.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This behavior changes when automatic schema migration is enabled. See <a class="reference internal" href="update-schema.html#merge-schema-evolution"><span class="std std-ref">automatic schema evolution</span></a> for details.</p>
</div>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clauses are executed when a target row does not match any source row based on the merge condition. These clauses have the following semantics.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clauses can specify <code class="docutils literal notranslate"><span class="pre">delete</span></code> and <code class="docutils literal notranslate"><span class="pre">update</span></code> actions.</p></li>
<li><p>Each <code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clause can have an optional condition. If the clause condition is present, a target row is modified only if that condition is true for that row. Otherwise, the target row is left unchanged.</p></li>
<li><p>If there are multiple <code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clauses, then they are evaluated in the order they are specified. All <code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clauses, except the last one, must have conditions.</p></li>
<li><p>By definition, <code class="docutils literal notranslate"><span class="pre">whenNotMatchedBySource</span></code> clauses do not have a source row to pull column values from, and so source columns can’t be referenced. For each column to be modified, you can either specify a literal or perform an action on the target column, such as <code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">target.deleted_count</span> <span class="pre">=</span> <span class="pre">target.deleted_count</span> <span class="pre">+</span> <span class="pre">1</span></code>.</p></li>
</ul>
</li>
</ul>
<div class="admonition important" id="merge-error">
<p class="admonition-title">Important</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">merge</span></code> operation can fail if multiple rows of the source dataset match and the merge attempts to update the same rows of the target Delta table. According to the SQL semantics of merge, such an update operation is ambiguous as it is unclear which source row should be used to update the matched target row. You can preprocess the source table to eliminate the possibility of multiple matches.</p></li>
<li><p>You can apply a SQL <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> operation on a SQL VIEW only if the view has been defined as <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">VIEW</span> <span class="pre">viewName</span> <span class="pre">AS</span> <span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">deltaTable</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="data-deduplication-when-writing-into-delta-tables">
<span id="dedupe"></span><h2>Data deduplication when writing into Delta tables<a class="headerlink" href="#data-deduplication-when-writing-into-delta-tables" title="Permalink to this headline"> </a></h2>
<p>A common ETL use case is to collect logs into Delta table by appending them to a table. However, often the sources can generate duplicate log records and downstream deduplication steps are needed to take care of them. With <code class="docutils literal notranslate"><span class="pre">merge</span></code>, you can avoid inserting the duplicate records.</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">logs</span>
<span class="k">USING</span><span class="w"> </span><span class="n">newDedupedLogs</span>
<span class="k">ON</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="n">uniqueId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="n">uniqueId</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span>
<span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="o">*</span>
</pre></div>
</div>
<div class="compound-middle highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">newDedupedLogs</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
    <span class="s2">&quot;logs.uniqueId = newDedupedLogs.uniqueId&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">whenNotMatchedInsertAll</span><span class="p">()</span> \
  <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-middle highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span>
<span class="w">  </span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;logs&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;logs.uniqueId = newDedupedLogs.uniqueId&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-last highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span>
<span class="w">  </span><span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="s">&quot;logs&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="na">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="s">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;logs.uniqueId = newDedupedLogs.uniqueId&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="na">whenNotMatched</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="na">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The dataset containing the new logs needs to be deduplicated within itself. By the SQL semantics of merge, it matches and deduplicates the new data with the existing data in the table, but if there is duplicate data within the new dataset, it is inserted. Hence, deduplicate the new data before merging into the table.</p>
</div>
<p>If you know that you may get duplicate records only for a few days, you can optimize your query further by partitioning the table by date, and then specifying the date range of the target table to match on.</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">logs</span>
<span class="k">USING</span><span class="w"> </span><span class="n">newDedupedLogs</span>
<span class="k">ON</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="n">uniqueId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="n">uniqueId</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">logs</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">current_date</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">DAYS</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="nb">date</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">current_date</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">DAYS</span>
<span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="o">*</span>
</pre></div>
</div>
<div class="compound-middle highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">newDedupedLogs</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
    <span class="s2">&quot;logs.uniqueId = newDedupedLogs.uniqueId AND logs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">whenNotMatchedInsertAll</span><span class="p">(</span><span class="s2">&quot;newDedupedLogs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-middle highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;logs&quot;</span><span class="p">).</span><span class="n">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;logs.uniqueId = newDedupedLogs.uniqueId AND logs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">(</span><span class="s">&quot;newDedupedLogs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<div class="compound-last highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">deltaTable</span><span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="s">&quot;logs&quot;</span><span class="p">).</span><span class="na">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">newDedupedLogs</span><span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="s">&quot;newDedupedLogs&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;logs.uniqueId = newDedupedLogs.uniqueId AND logs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="na">whenNotMatched</span><span class="p">(</span><span class="s">&quot;newDedupedLogs.date &gt; current_date() - INTERVAL 7 DAYS&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="na">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="na">execute</span><span class="p">();</span>
</pre></div>
</div>
</div>
<p>This is more efficient than the previous command as it looks for duplicates only in the last 7 days of logs, not the entire table. Furthermore, you can use this insert-only merge with Structured Streaming to perform continuous deduplication of the logs.</p>
<ul class="simple">
<li><p>In a streaming query, you can use merge operation in <code class="docutils literal notranslate"><span class="pre">foreachBatch</span></code> to continuously write any streaming data to a Delta table with deduplication. See the following <a class="reference internal" href="../structured-streaming/delta-lake.html#merge-in-streaming"><span class="std std-ref">streaming example</span></a> for more information on <code class="docutils literal notranslate"><span class="pre">foreachBatch</span></code>.</p></li>
<li><p>In another streaming query, you can continuously read deduplicated data from this Delta table. This is possible because an insert-only merge only appends new data to the Delta table.</p></li>
</ul>
</div>
<div class="section" id="slowly-changing-data-scd-and-change-data-capture-cdc-with-delta-lake">
<span id="slowly-changing-data-scd-and-change-data-capture-cdc-with-delta"></span><span id="merge-in-cdc"></span><h2>Slowly changing data (SCD) and change data capture (CDC) with Delta Lake<a class="headerlink" href="#slowly-changing-data-scd-and-change-data-capture-cdc-with-delta-lake" title="Permalink to this headline"> </a></h2>
<p>Delta Live Tables has native support for tracking and applying SCD Type 1 and Type 2. Use <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span> <span class="pre">INTO</span></code> with Delta Live Tables to ensure that out of order records are handled correctly when processing CDC feeds. See <a class="reference internal" href="../delta-live-tables/cdc.html"><span class="doc">Simplified change data capture with the APPLY CHANGES API in Delta Live Tables</span></a>.</p>
</div>
<div class="section" id="incrementally-sync-delta-table-with-source">
<span id="incremental-sync"></span><h2>Incrementally sync Delta table with source<a class="headerlink" href="#incrementally-sync-delta-table-with-source" title="Permalink to this headline"> </a></h2>
<p>In Databricks SQL and Databricks Runtime 12.1 and above, you can use <code class="docutils literal notranslate"><span class="pre">WHEN</span> <span class="pre">NOT</span> <span class="pre">MATCHED</span> <span class="pre">BY</span> <span class="pre">SOURCE</span></code> to create arbitrary conditions to atomically delete and replace a portion of a table. This can be especially useful when you have a source table where records may change or be deleted for several days after initial data entry, but eventually settle to a final state.</p>
<p>The following query shows using this pattern to select 5 days of records from the source, update matching records in the target, insert new records from the source to the target, and delete all unmatched records from the past 5 days in the target.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MERGE</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span>
<span class="k">USING</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">source</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">current_date</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="k">DAY</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span>
<span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="k">key</span>
<span class="k">WHEN</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">*</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="o">*</span>
<span class="k">WHEN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="n">MATCHED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">SOURCE</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="k">current_date</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="w"> </span><span class="k">DAY</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">DELETE</span>
</pre></div>
</div>
<p>By providing the same boolean filter on the source and target tables, you are able to dynamically propagate changes from your source to target tables, including deletes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While this pattern can be used without any conditional clauses, this would lead to fully rewriting the target table which can be expensive.</p>
</div>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../_static/js/localized.js"></script>
  <script type="text/javascript" src="../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>