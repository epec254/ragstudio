

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn about the isolation levels and potential conflicts when performing concurrent transactions on tables on Databricks." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Isolation levels and write conflicts on Databricks">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Isolation levels and write conflicts on Databricks &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/optimizations/isolation-level.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/optimizations/isolation-level.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/optimizations/isolation-level.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="top" title="Databricks on AWS" href="../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../en/optimizations/isolation-level.html" class="notranslate">English</option>
    <option value="../../ja/optimizations/isolation-level.html" class="notranslate">日本語</option>
    <option value="../../pt/optimizations/isolation-level.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Isolation levels and write conflicts on Databricks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="isolation-levels-and-write-conflicts-on-databricks">
<h1>Isolation levels and write conflicts on Databricks<a class="headerlink" href="#isolation-levels-and-write-conflicts-on-databricks" title="Permalink to this headline"> </a></h1>
<p>The isolation level of a table defines the degree to which a transaction must be isolated from modifications made by concurrent operations. Write conflicts on Databricks depend on the isolation level.</p>
<p>Delta Lake provides ACID transaction guarantees between reads and writes. This means that:</p>
<ul class="simple">
<li><p>Multiple writers across multiple clusters can simultaneously modify a table partition. Writers see a consistent snapshot view of the table and writes occur in a serial order.</p>
<ul>
<li><p>Readers continue to see a consistent snapshot view of the table that the Databricks job started with, even when a table is modified during a job.</p></li>
</ul>
</li>
</ul>
<p>See <a class="reference internal" href="../lakehouse/acid.html"><span class="doc">What are ACID guarantees on Databricks?</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Databricks use Delta Lake for all tables by default. This article describes behavior for Delta Lake on Databricks.</p>
</div>
<div class="section" id="write-conflicts-with-row-level-concurrency">
<span id="rlc-conflicts"></span><h2>Write conflicts with row-level concurrency<a class="headerlink" href="#write-conflicts-with-row-level-concurrency" title="Permalink to this headline"> </a></h2>
<p>Row-level concurrency reduces conflicts between concurrent write operations by detecting changes at the row-level and automatically resolving conflicts that occur when concurrent writes update or delete different rows in the same data file.</p>
<p>Row-level concurrency is Generally Available on Databricks Runtime 14.2 and above. Row-level concurrency is supported by default on tables with deletion vectors enabled and without partitioning, including tables with liquid clustering. Tables with partitions do not support row-level concurrency but can still avoid conflicts between <code class="docutils literal notranslate"><span class="pre">OPTIMIZE</span></code> and all other write operations when deletion vectors are enabled. See <a class="reference internal" href="#rlc-limitations"><span class="std std-ref">Limitations for row-level concurrency</span></a>.</p>
<p>For other Databricks Runtime versions, see <a class="reference internal" href="#rlc-preview"><span class="std std-ref">(Legacy) Row-level concurrency preview behavior</span></a>.</p>
<p>The following table describes which pairs of write operations can conflict in each <a class="reference internal" href="#isolation-levels"><span class="std std-ref">isolation level</span></a> with row-level concurrency enabled.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Tables with identity columns do not support concurrent transactions. See <a class="reference internal" href="../delta/generated-columns.html#identity"><span class="std std-ref">Use identity columns in Delta Lake</span></a>.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>INSERT (1)</p></th>
<th class="head"><p>UPDATE, DELETE, MERGE INTO</p></th>
<th class="head"><p>OPTIMIZE</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>INSERT</strong></p></td>
<td><p>Cannot conflict</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>UPDATE, DELETE, MERGE INTO</strong></p></td>
<td><p>Cannot conflict in WriteSerializable. Can conflict in Serializable when modifying the same row; see <a class="reference internal" href="#rlc-limitations"><span class="std std-ref">Limitations for row-level concurrency</span></a>.</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">MERGE</span> <span class="pre">INTO</span></code> requires Photon for row-level conflict resolution. Can conflict when modifying the same row; see <a class="reference internal" href="#rlc-limitations"><span class="std std-ref">Limitations for row-level concurrency</span></a>.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><strong>OPTIMIZE</strong></p></td>
<td><p>Cannot conflict</p></td>
<td><p>Cannot conflict</p></td>
<td><p>Cannot conflict</p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>(1)</strong> All <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> operations in the tables above describe append operations that do not read any data from the same table before committing. <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> operations that contain subqueries reading the same table support the same concurrency as <code class="docutils literal notranslate"><span class="pre">MERGE</span></code>.</p>
</div>
</div>
<div class="section" id="write-conflicts-without-row-level-concurrency">
<span id="write-conflicts"></span><h2>Write conflicts without row-level concurrency<a class="headerlink" href="#write-conflicts-without-row-level-concurrency" title="Permalink to this headline"> </a></h2>
<p>The following table describes which pairs of write operations can conflict in each <a class="reference internal" href="#isolation-levels"><span class="std std-ref">isolation level</span></a>.</p>
<p>Tables do not support row-level concurrency if they have partitions defined or do not have deletion vectors enabled. Databricks Runtime 14.2 or above is required for row-level concurrency.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Tables with identity columns do not support concurrent transactions. See <a class="reference internal" href="../delta/generated-columns.html#identity"><span class="std std-ref">Use identity columns in Delta Lake</span></a>.</p>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>INSERT (1)</p></th>
<th class="head"><p>UPDATE, DELETE, MERGE INTO</p></th>
<th class="head"><p>OPTIMIZE</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>INSERT</strong></p></td>
<td><p>Cannot conflict</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><strong>UPDATE, DELETE, MERGE INTO</strong></p></td>
<td><p>Cannot conflict in WriteSerializable. Can conflict in Serializable; see <a class="reference internal" href="#conflicts"><span class="std std-ref">avoid conflicts with partitions</span></a>.</p></td>
<td><p>Can conflict in Serializable and WriteSerializable; see <a class="reference internal" href="#conflicts"><span class="std std-ref">avoid conflicts with partitions</span></a>.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><strong>OPTIMIZE</strong></p></td>
<td><p>Cannot conflict</p></td>
<td><p>Cannot conflict with in tables with deletion vectors enabled. Can conflict otherwise.</p></td>
<td><p>Cannot conflict with in tables with deletion vectors enabled. Can conflict otherwise.</p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><strong>(1)</strong> All <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> operations in the tables above describe append operations that do not read any data from the same table before committing. <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> operations that contain subqueries reading the same table support the same concurrency as <code class="docutils literal notranslate"><span class="pre">MERGE</span></code>.</p>
</div>
</div>
<div class="section" id="limitations-for-row-level-concurrency">
<span id="rlc-limitations"></span><h2>Limitations for row-level concurrency<a class="headerlink" href="#limitations-for-row-level-concurrency" title="Permalink to this headline"> </a></h2>
<p>Some limitations apply for row-level concurrency. For the following operations, conflict resolution follows normal concurrency for write conflicts on Databricks. See <a class="reference internal" href="#write-conflicts"><span class="std std-ref">Write conflicts without row-level concurrency</span></a>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">OPTIMIZE</span></code> commands with <code class="docutils literal notranslate"><span class="pre">ZORDER</span> <span class="pre">BY</span></code>.</p></li>
<li><p>Commands with complex conditional clauses, including the following:</p>
<ul>
<li><p>Conditions on complex data types such as structs, arrays, or maps.</p></li>
<li><p>Conditions using non-deterministic expressions and subqueries.</p></li>
<li><p>Conditions that contain correlated subqueries.</p></li>
</ul>
</li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> commands, you must use an explicit predicate on the target table to filter rows matching the source table. For merge resolution, the filter is used to only scan rows that might conflict based on filter conditions in concurrent operations.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Row-level conflict detection can increase the total execution time. In the case of many concurrent transactions, the writer prioritizes latency over conflict resolution and conflicts may occur.</p>
</div>
<p>All limitations for deletion vectors also apply. See <a class="reference internal" href="../delta/deletion-vectors.html#limitations"><span class="std std-ref">Limitations</span></a>.</p>
</div>
<div class="section" id="when-does-delta-lake-commit-without-reading-the-table">
<span id="when-does-delta-commit-without-reading-the-table"></span><h2>When does Delta Lake commit without reading the table?<a class="headerlink" href="#when-does-delta-lake-commit-without-reading-the-table" title="Permalink to this headline"> </a></h2>
<p>Delta Lake <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> or append operations do not read the table state before committing if the following conditions are satisfied:</p>
<ol class="arabic simple">
<li><p>Logic is expressed using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> SQL logic or append mode.</p></li>
<li><p>Logic contains no subqueries or conditionals that reference the table targeted by the write operation.</p></li>
</ol>
<p>As in other commits, Delta Lake validates and resolves the table versions on commit using metadata in the transaction log, but no version of the table is actually read.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many common patterns use <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> operations to insert data based on table conditions. Although it might be possible to rewrite this logic using <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> statements, if any conditional expression references a column in the target table, these statements have the same concurrency limitations as <code class="docutils literal notranslate"><span class="pre">MERGE</span></code>.</p>
</div>
</div>
<div class="section" id="write-serializable-vs-serializable-isolation-levels">
<span id="isolation-levels"></span><h2>Write serializable vs. serializable isolation levels<a class="headerlink" href="#write-serializable-vs-serializable-isolation-levels" title="Permalink to this headline"> </a></h2>
<p>The isolation level of a table defines the degree to which a transaction must be isolated from modifications made by concurrent transactions. Delta Lake on Databricks supports two isolation levels: Serializable and WriteSerializable.</p>
<ul>
<li><p><strong>Serializable</strong>: The strongest isolation level. It ensures that committed write operations and all reads are <a class="reference external" href="https://en.wikipedia.org/wiki/Serializability">Serializable</a>. Operations are allowed as long as there exists a serial sequence of executing them one-at-a-time that generates the same outcome as that seen in the table. For the write operations, the serial sequence is exactly the same as that seen in the table’s history.</p></li>
<li><p><strong>WriteSerializable (Default)</strong>: A weaker isolation level than Serializable. It ensures only that the write operations (that is, not reads) are serializable. However, this is still stronger than <a class="reference external" href="https://en.wikipedia.org/wiki/Snapshot_isolation">Snapshot</a> isolation. WriteSerializable is the default isolation level because it provides great balance of data consistency and availability for most common operations.</p>
<p>In this mode, the content of the Delta table may be different from that which is expected from the sequence of operations seen in the table history. This is because this mode allows certain pairs of concurrent writes (say, operations X and Y) to proceed such that the result would be as if Y was performed before X (that is, serializable between them) even though the history would show that Y was committed after X. To disallow this reordering, <a class="reference internal" href="#setting-isolation-level"><span class="std std-ref">set the table isolation level</span></a> to be Serializable to cause these transactions to fail.</p>
</li>
</ul>
<p>Read operations always use snapshot isolation. The write isolation level determines whether or not it is possible for a reader to see a snapshot of a table, that according to the history, “never existed”.</p>
<p>For the Serializable level, a reader always sees only tables that conform to the history. For the WriteSerializable level, a reader could see a table that does not exist in the Delta log.</p>
<p>For example, consider txn1, a long running delete and txn2, which inserts data deleted by txn1. txn2 and txn1 complete and they are recorded in that order in the history. According to the history, the data inserted in txn2 should not exist in the table. For Serializable level, a reader would never see data inserted by txn2. However, for the WriteSerializable level, a reader could at some point see the data inserted by txn2.</p>
<p>For more information on which types of operations can conflict with each other in each isolation level and the possible errors, see <a class="reference internal" href="#conflicts"><span class="std std-ref">Avoid conflicts using partitioning and disjoint command conditions</span></a>.</p>
</div>
<div class="section" id="set-the-isolation-level">
<span id="setting-isolation-level"></span><h2>Set the isolation level<a class="headerlink" href="#set-the-isolation-level" title="Permalink to this headline"> </a></h2>
<p>You set the isolation level using the <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> command.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">TBLPROPERTIES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;delta.isolationLevel&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="k">level</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;level-name&gt;</span></code> is <code class="docutils literal notranslate"><span class="pre">Serializable</span></code> or <code class="docutils literal notranslate"><span class="pre">WriteSerializable</span></code>.</p>
<p>For example, to change the isolation level from the default <code class="docutils literal notranslate"><span class="pre">WriteSerializable</span></code> to <code class="docutils literal notranslate"><span class="pre">Serializable</span></code>, run:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">&lt;</span><span class="k">table</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">TBLPROPERTIES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;delta.isolationLevel&#39;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Serializable&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="avoid-conflicts-using-partitioning-and-disjoint-command-conditions">
<span id="conflicts"></span><h2>Avoid conflicts using partitioning and disjoint command conditions<a class="headerlink" href="#avoid-conflicts-using-partitioning-and-disjoint-command-conditions" title="Permalink to this headline"> </a></h2>
<p>In all cases marked “can conflict”, whether the two operations will conflict depends on whether they operate on the same set of files. You can make the two sets of files disjoint by partitioning the table by the same columns as those used in the conditions of the operations. For example, the two commands <code class="docutils literal notranslate"><span class="pre">UPDATE</span> <span class="pre">table</span> <span class="pre">WHERE</span> <span class="pre">date</span> <span class="pre">&gt;</span> <span class="pre">'2010-01-01'</span> <span class="pre">...</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span> <span class="pre">table</span> <span class="pre">WHERE</span> <span class="pre">date</span> <span class="pre">&lt;</span> <span class="pre">'2010-01-01'</span></code> will conflict if the table is not partitioned by date, as both can attempt to modify the same set of files. Partitioning the table by <code class="docutils literal notranslate"><span class="pre">date</span></code> will avoid the conflict. Therefore, partitioning a table according to the conditions commonly used on the command can reduce conflicts significantly. However, partitioning a table by a column that has high cardinality can lead to other performance issues due to the large number of subdirectories.</p>
</div>
<div class="section" id="conflict-exceptions">
<h2>Conflict exceptions<a class="headerlink" href="#conflict-exceptions" title="Permalink to this headline"> </a></h2>
<p>When a transaction conflict occurs, you will observe one of the following exceptions:</p>
<div class="section" id="concurrentappendexception">
<h3>ConcurrentAppendException<a class="headerlink" href="#concurrentappendexception" title="Permalink to this headline"> </a></h3>
<p>This exception occurs when a concurrent operation adds files in the same partition (or anywhere in an unpartitioned table) that your operation reads. The file additions can be caused by <code class="docutils literal notranslate"><span class="pre">INSERT</span></code>, <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, or <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> operations.</p>
<p>With the default <a class="reference internal" href="#isolation-levels"><span class="std std-ref">isolation level</span></a> of <code class="docutils literal notranslate"><span class="pre">WriteSerializable</span></code>, files added by <em>blind</em> <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> operations (that is, operations that blindly append data without reading any data) do not conflict with any operation, even if they touch the same partition (or anywhere in an unpartitioned table). If the isolation level is set to <code class="docutils literal notranslate"><span class="pre">Serializable</span></code>, then blind appends may conflict.</p>
<p>This exception is often thrown during concurrent <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, or <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> operations. While the concurrent operations may be physically updating different partition directories, one of them may read the same partition that the other one concurrently updates, thus causing a conflict. You can avoid this by making the separation explicit in the operation condition. Consider the following example.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Target &#39;deltaTable&#39; is partitioned by date and country</span>
<span class="n">deltaTable</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">).</span><span class="n">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">source</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;s.user_id = t.user_id AND s.date = t.date AND s.country = t.country&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenMatched</span><span class="p">().</span><span class="n">updateAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">().</span><span class="n">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>Suppose you run the above code concurrently for different dates or countries. Since each job is working on an independent partition on the target Delta table, you don’t expect any conflicts. However, the condition is not explicit enough and can scan the entire table and can conflict with concurrent operations updating any other partitions. Instead, you can rewrite your statement to add specific date and country to the merge condition, as shown in the following example.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// Target &#39;deltaTable&#39; is partitioned by date and country</span>
<span class="n">deltaTable</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">).</span><span class="n">merge</span><span class="p">(</span>
<span class="w">    </span><span class="n">source</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="s">&quot;s.user_id = t.user_id AND s.date = t.date AND s.country = t.country AND t.date = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39; AND t.country = &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&lt;</span><span class="n">country</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenMatched</span><span class="p">().</span><span class="n">updateAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">whenNotMatched</span><span class="p">().</span><span class="n">insertAll</span><span class="p">()</span>
<span class="w">  </span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>This operation is now safe to run concurrently on different dates and countries.</p>
</div>
<div class="section" id="concurrentdeletereadexception">
<h3>ConcurrentDeleteReadException<a class="headerlink" href="#concurrentdeletereadexception" title="Permalink to this headline"> </a></h3>
<p>This exception occurs when a concurrent operation deleted a file that your operation read. Common causes are a <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>, or <code class="docutils literal notranslate"><span class="pre">MERGE</span></code> operation that rewrites files.</p>
</div>
<div class="section" id="concurrentdeletedeleteexception">
<h3>ConcurrentDeleteDeleteException<a class="headerlink" href="#concurrentdeletedeleteexception" title="Permalink to this headline"> </a></h3>
<p>This exception occurs when a concurrent operation deleted a file that your operation also deletes. This could be caused by two concurrent compaction operations rewriting the same files.</p>
</div>
<div class="section" id="metadatachangedexception">
<h3>MetadataChangedException<a class="headerlink" href="#metadatachangedexception" title="Permalink to this headline"> </a></h3>
<p>This exception occurs when a concurrent transaction updates the metadata of a Delta table. Common causes are <code class="docutils literal notranslate"><span class="pre">ALTER</span> <span class="pre">TABLE</span></code> operations or writes to your Delta table that update the schema of the table.</p>
</div>
<div class="section" id="concurrenttransactionexception">
<h3>ConcurrentTransactionException<a class="headerlink" href="#concurrenttransactionexception" title="Permalink to this headline"> </a></h3>
<p>If a streaming query using the same checkpoint location is started multiple times concurrently and tries to write to the Delta table at the same time. You should never have two streaming queries use the same checkpoint location and run at the same time.</p>
</div>
<div class="section" id="protocolchangedexception">
<h3>ProtocolChangedException<a class="headerlink" href="#protocolchangedexception" title="Permalink to this headline"> </a></h3>
<p>This exception can occur in the following cases:</p>
<ul class="simple">
<li><p>When your Delta table is upgraded to a new protocol version. For future operations to succeed you may need to upgrade your Databricks Runtime.</p></li>
<li><p>When multiple writers are creating or replacing a table at the same time.</p></li>
<li><p>When multiple writers are writing to an empty path at the same time.</p></li>
</ul>
<p>See <a class="reference internal" href="../delta/feature-compatibility.html"><span class="doc">How does Databricks manage Delta Lake feature compatibility?</span></a> for more details.</p>
</div>
</div>
<div class="section" id="legacy-row-level-concurrency-preview-behavior">
<span id="rlc-preview"></span><h2>(Legacy) Row-level concurrency preview behavior<a class="headerlink" href="#legacy-row-level-concurrency-preview-behavior" title="Permalink to this headline"> </a></h2>
<p>This section describes preview behaviors for row-level concurrency in Databricks Runtime 14.1 and below. Row-level concurrency always requires deletion vectors.</p>
<p>In Databricks Runtime 13.3 LTS and above, tables with liquid clustering enabled automatically enable row-level concurrency.</p>
<p>In Databricks Runtime 14.0 and 14.1, you can enable row-level concurrency for tables with deletion vectors by setting the following configuration for the cluster or SparkSession:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">spark.databricks.delta.rowLevelConcurrencyPreview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</pre></div>
</div>
<p>In Databricks Runtime 14.1 and below, non-Photon compute only supports row-level concurrency for <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> operations.</p>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../_static/js/localized.js"></script>
  <script type="text/javascript" src="../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>