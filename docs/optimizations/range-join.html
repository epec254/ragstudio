

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how Databricks optimizes join performance when two relations are joined using a point in interval or interval overlap condition." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Range join optimization">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Range join optimization &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/optimizations/range-join.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/optimizations/range-join.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/optimizations/range-join.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="top" title="Databricks on AWS" href="../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../en/optimizations/range-join.html" class="notranslate">English</option>
    <option value="../../ja/optimizations/range-join.html" class="notranslate">日本語</option>
    <option value="../../pt/optimizations/range-join.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Range join optimization</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="range-join-optimization">
<h1>Range join optimization<a class="headerlink" href="#range-join-optimization" title="Permalink to this headline"> </a></h1>
<p>A <em>range join</em> occurs when two relations are joined using a point in interval or interval overlap condition.
The range join optimization support in Databricks Runtime can bring orders of magnitude improvement in query performance, but requires careful manual tuning.</p>
<div class="section" id="point-in-interval-range-join">
<h2>Point in interval range join<a class="headerlink" href="#point-in-interval-range-join" title="Permalink to this headline"> </a></h2>
<p>A <em>point in interval range join</em> is a join in which the condition contains predicates specifying that a value from one relation is between two values from the other relation. For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- using BETWEEN expressions</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">end</span><span class="p">;</span>

<span class="c1">-- using inequality expressions</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">end</span><span class="p">;</span>

<span class="c1">-- with fixed length interval</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="c1">-- join two sets of point values within a fixed distance from each other</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points1</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">points2</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">p1</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">p2</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="c1">-- a range condition together with other join conditions</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points</span><span class="p">,</span><span class="w"> </span><span class="n">ranges</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="n">symbol</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">end</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="interval-overlap-range-join">
<h2>Interval overlap range join<a class="headerlink" href="#interval-overlap-range-join" title="Permalink to this headline"> </a></h2>
<p>An <em>interval overlap range join</em> is a join in which the condition contains predicates specifying an overlap of intervals between two values from each relation. For example:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- overlap of [r1.start, r1.end] with [r2.start, r2.end]</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">end</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">end</span><span class="p">;</span>

<span class="c1">-- overlap of fixed length intervals</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="c1">-- a range condition together with other join conditions</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="n">symbol</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">end</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">end</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="range-join-optimization">
<h2>Range join optimization<a class="headerlink" href="#range-join-optimization" title="Permalink to this headline"> </a></h2>
<p>The range join optimization is performed for joins that:</p>
<ul class="simple">
<li><p>Have a condition that can be interpreted as a point in interval or interval overlap range join.</p></li>
<li><p>All values involved in the range join condition are of a numeric type (integral, floating point, decimal), <code class="docutils literal notranslate"><span class="pre">DATE</span></code>, or <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span></code>.</p></li>
<li><p>All values involved in the range join condition are of the same type. In the case of the decimal type, the values also need to be of the same scale and precision.</p></li>
<li><p>It is an <code class="docutils literal notranslate"><span class="pre">INNER</span> <span class="pre">JOIN</span></code>, or in case of point in interval range join, a <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> with point value on the left side, or <code class="docutils literal notranslate"><span class="pre">RIGHT</span> <span class="pre">OUTER</span> <span class="pre">JOIN</span></code> with point value on the right side.</p></li>
<li><p>Have a bin size tuning parameter.</p></li>
</ul>
<div class="section" id="bin-size">
<h3>Bin size<a class="headerlink" href="#bin-size" title="Permalink to this headline"> </a></h3>
<p>The <em>bin size</em> is a numeric tuning parameter that splits the values domain of the range condition into multiple <em>bins</em> of equal size. For example, with a bin size of 10, the optimization splits the domain into bins that are intervals of length 10.
If you have a point in range condition of <code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">BETWEEN</span> <span class="pre">start</span> <span class="pre">AND</span> <span class="pre">end</span></code>, and <code class="docutils literal notranslate"><span class="pre">start</span></code> is 8 and <code class="docutils literal notranslate"><span class="pre">end</span></code> is 22, this value interval overlaps with three bins of length 10 – the first bin from 0 to 10, the second bin from 10 to 20, and the third bin from 20 to 30. Only the points that fall within the same three bins need to be considered as possible join matches for that interval. For example, if <code class="docutils literal notranslate"><span class="pre">p</span></code> is 32, it can be ruled out as falling between <code class="docutils literal notranslate"><span class="pre">start</span></code> of 8 and <code class="docutils literal notranslate"><span class="pre">end</span></code> of 22, because it falls in the bin from 30 to 40.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>For <code class="docutils literal notranslate"><span class="pre">DATE</span></code> values, the value of the bin size is interpreted as days. For example, a bin size value of 7 represents a week.</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span></code> values, the value of the bin size is interpreted as seconds. If a sub-second value is required, fractional values can be used. For example, a bin size value of 60 represents a minute, and a bin size value of 0.1 represents 100 milliseconds.</p></li>
</ul>
</div>
<p>You can specify the bin size either by using a range join hint in the query or by setting a session configuration parameter.
The range join optimization is applied <em>only if</em> you manually specify the bin size. Section <a class="reference internal" href="#id2"><span class="std std-ref">Choose the bin size</span></a> describes how to choose an optimal bin size.</p>
</div>
</div>
<div class="section" id="enable-range-join-using-a-range-join-hint">
<h2>Enable range join using a range join hint<a class="headerlink" href="#enable-range-join-using-a-range-join-hint" title="Permalink to this headline"> </a></h2>
<p>To enable the range join optimization in a SQL query, you can use a <em>range join hint</em> to specify the bin size.
The hint must contain the relation name of one of the joined relations and the numeric bin size parameter.
The relation name can be a table, a view, or a subquery.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="cm">/*+ RANGE_JOIN(points, 10) */</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">points</span><span class="p">.</span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="k">end</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="cm">/*+ RANGE_JOIN(r1, 0.1) */</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ranges</span><span class="p">.</span><span class="n">amount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">ranges</span><span class="w"> </span><span class="n">r2</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">r2</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="k">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="k">SELECT</span><span class="w"> </span><span class="cm">/*+ RANGE_JOIN(c, 500) */</span><span class="w"> </span><span class="o">*</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span>
<span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">b_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">ts</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">start_time</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">end_time</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the third example, you <em>must</em> place the hint on <code class="docutils literal notranslate"><span class="pre">c</span></code>.
This is because joins are left associative, so the query is interpreted as <code class="docutils literal notranslate"><span class="pre">(a</span> <span class="pre">JOIN</span> <span class="pre">b)</span> <span class="pre">JOIN</span> <span class="pre">c</span></code>,
and the hint on <code class="docutils literal notranslate"><span class="pre">a</span></code> applies to the join of <code class="docutils literal notranslate"><span class="pre">a</span></code> with <code class="docutils literal notranslate"><span class="pre">b</span></code> and not the join with <code class="docutils literal notranslate"><span class="pre">c</span></code>.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1">#create minute table</span>
<span class="n">minutes</span> <span class="o">=</span> <span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
  <span class="o">.</span><span class="n">parallelize</span><span class="p">(((</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">)))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;minute_start&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;minute_end&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span>
  <span class="p">]))</span>
<span class="p">)</span>

<span class="c1">#create events table</span>
<span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
  <span class="o">.</span><span class="n">parallelize</span><span class="p">(((</span><span class="mi">12</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">120</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="mi">72</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">178</span><span class="p">)))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;event_start&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;event_end&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">())</span>
    <span class="p">]))</span>
<span class="p">)</span>

<span class="c1">#Range_Join with &quot;hint&quot; on the from table</span>
<span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">hint</span><span class="p">(</span><span class="s2">&quot;range_join&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
  <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">minutes</span><span class="p">,</span>
    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">event_start</span> <span class="o">&lt;</span> <span class="n">minutes</span><span class="o">.</span><span class="n">minute_end</span><span class="p">,</span>
    <span class="n">minutes</span><span class="o">.</span><span class="n">minute_start</span> <span class="o">&lt;</span> <span class="n">events</span><span class="o">.</span><span class="n">event_end</span><span class="p">])</span>
  <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">event_start</span><span class="p">,</span>
    <span class="n">events</span><span class="o">.</span><span class="n">event_end</span><span class="p">,</span>
    <span class="n">minutes</span><span class="o">.</span><span class="n">minute_start</span><span class="p">)</span>
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1">#Range_Join with &quot;hint&quot; on the join table</span>
<span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">minutes</span><span class="o">.</span><span class="n">hint</span><span class="p">(</span><span class="s2">&quot;range_join&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span>
  <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">events</span><span class="o">.</span><span class="n">event_start</span> <span class="o">&lt;</span> <span class="n">minutes</span><span class="o">.</span><span class="n">minute_end</span><span class="p">,</span>
    <span class="n">minutes</span><span class="o">.</span><span class="n">minute_start</span> <span class="o">&lt;</span> <span class="n">events</span><span class="o">.</span><span class="n">event_end</span><span class="p">])</span>
  <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">event_start</span><span class="p">,</span>
    <span class="n">events</span><span class="o">.</span><span class="n">event_end</span><span class="p">,</span>
    <span class="n">minutes</span><span class="o">.</span><span class="n">minute_start</span><span class="p">)</span>
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can also place a range join hint on one of the joined DataFrames. In that case, the hint contains just the numeric bin size parameter.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">df1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s">&quot;ranges&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;left&quot;</span><span class="p">)</span>
<span class="kd">val</span><span class="w"> </span><span class="n">df2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s">&quot;ranges&quot;</span><span class="p">).</span><span class="n">as</span><span class="p">(</span><span class="s">&quot;right&quot;</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">joined</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df1</span><span class="p">.</span><span class="n">hint</span><span class="p">(</span><span class="s">&quot;range_join&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">  </span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;left.type&quot;</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.type&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="n">$</span><span class="s">&quot;left.end&quot;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.start&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="n">$</span><span class="s">&quot;left.start&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.end&quot;</span><span class="p">)</span>

<span class="kd">val</span><span class="w"> </span><span class="n">joined2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df1</span>
<span class="w">  </span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">df2</span><span class="p">.</span><span class="n">hint</span><span class="p">(</span><span class="s">&quot;range_join&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;left.type&quot;</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.type&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="n">$</span><span class="s">&quot;left.end&quot;</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.start&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">     </span><span class="n">$</span><span class="s">&quot;left.start&quot;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$</span><span class="s">&quot;right.end&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="enable-range-join-using-session-configuration">
<h2>Enable range join using session configuration<a class="headerlink" href="#enable-range-join-using-session-configuration" title="Permalink to this headline"> </a></h2>
<p>If you don’t want to modify the query, you can specify the bin size as a configuration parameter.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SET</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">databricks</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">rangeJoin</span><span class="p">.</span><span class="n">binSize</span><span class="o">=</span><span class="mi">5</span>
</pre></div>
</div>
<p>This configuration parameter applies to any join with a range condition. However, a different bin size set through a range join hint always overrides the one set through the parameter.</p>
</div>
<div class="section" id="choose-the-bin-size">
<span id="id2"></span><h2>Choose the bin size<a class="headerlink" href="#choose-the-bin-size" title="Permalink to this headline"> </a></h2>
<p>The effectiveness of the range join optimization depends on choosing the appropriate bin size.</p>
<p>A small bin size results in a larger number of bins, which helps in filtering the potential matches.
However, it becomes inefficient if the bin size is significantly smaller than the encountered value intervals, and the value intervals overlap multiple <em>bin</em> intervals. For example, with a condition <code class="docutils literal notranslate"><span class="pre">p</span> <span class="pre">BETWEEN</span> <span class="pre">start</span> <span class="pre">AND</span> <span class="pre">end</span></code>, where <code class="docutils literal notranslate"><span class="pre">start</span></code> is 1,000,000 and <code class="docutils literal notranslate"><span class="pre">end</span></code> is 1,999,999, and a bin size of 10, the value interval overlaps with 100,000 bins.</p>
<p>If the length of the interval is fairly uniform and known, we recommend that you set the bin size to the typical expected length of the value interval. However, if the length of the interval is varying and skewed, a balance must be found to set a bin size that filters the short intervals efficiently, while preventing the long intervals from overlapping too many bins. Assuming a table <code class="docutils literal notranslate"><span class="pre">ranges</span></code>, with intervals that are between columns <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code>, you can determine different percentiles of the skewed interval length value with the following query:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">APPROX_PERCENTILE</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="k">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">DOUBLE</span><span class="p">),</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">99</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">999</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">9999</span><span class="p">))</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">ranges</span>
</pre></div>
</div>
<p>A recommended setting of bin size would be the maximum of the value at the 90th percentile, or the value at the 99th percentile divided by 10, or the value at the 99.9th percentile divided by 100 and so on. The rationale is:</p>
<ul class="simple">
<li><p>If the value at the 90th percentile is the bin size, only 10% of the value interval lengths are longer than the bin interval, so span more than 2 adjacent bin intervals.</p></li>
<li><p>If the value at the 99th percentile is the bin size, only 1% of the value interval lengths span more than 11 adjacent bin intervals.</p></li>
<li><p>If the value at the 99.9th percentile is the bin size, only 0.1% of the value interval lengths span more than 101 adjacent bin intervals.</p></li>
<li><p>The same can be repeated for the values at the 99.99th, the 99.999th percentile, and so on if needed.</p></li>
</ul>
<p>The described method limits the amount of skewed long value intervals that overlap multiple bin intervals.
The bin size value obtained this way is only a starting point for fine tuning; actual results may depend on the specific workload.</p>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../_static/js/localized.js"></script>
  <script type="text/javascript" src="../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>