

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how to apply software engineering best practices to your Databricks notebooks, including version control, code sharing, testing, and CI/CD." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Software engineering best practices for notebooks">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Software engineering best practices for notebooks &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/notebooks/best-practices.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/notebooks/best-practices.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/notebooks/best-practices.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="top" title="Databricks on AWS" href="../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../en/notebooks/best-practices.html" class="notranslate">English</option>
    <option value="../../ja/notebooks/best-practices.html" class="notranslate">日本語</option>
    <option value="../../pt/notebooks/best-practices.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Software engineering best practices for notebooks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="software-engineering-best-practices-for-notebooks">
<h1>Software engineering best practices for notebooks<a class="headerlink" href="#software-engineering-best-practices-for-notebooks" title="Permalink to this headline"> </a></h1>
<p>This article provides a hands-on walkthrough that demonstrates how to apply software engineering best practices to your Databricks notebooks, including version control, code sharing, testing, and optionally continuous integration and continuous delivery or deployment (CI/CD).</p>
<p>In this walkthrough, you will:</p>
<ul class="simple">
<li><p>Add notebooks to Databricks Repos for version control.</p></li>
<li><p>Extract portions of code from one of the notebooks into a shareable module.</p></li>
<li><p>Test the shared code.</p></li>
<li><p>Run the notebooks from a Databricks job.</p></li>
<li><p>Optionally apply CI/CD to the shared code.</p></li>
</ul>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline"> </a></h2>
<p>To complete this walkthrough, you must provide the following resources:</p>
<ul>
<li><p>A remote repository with a <a class="reference internal" href="../repos/index.html#supported-git-providers"><span class="std std-ref">Git provider</span></a> that Databricks supports. This article’s walkthrough uses GitHub. This walkthrough assumes that you have a GitHub repository named <code class="docutils literal notranslate"><span class="pre">best-notebooks</span></code> available. (You can give your repository a different name. If you do, replace <code class="docutils literal notranslate"><span class="pre">best-notebooks</span></code> with your repo’s name throughout this walkthrough.) <a class="reference external" href="https://docs.github.com/get-started/quickstart/create-a-repo#create-a-repository">Create a GitHub repo</a> if you do not already have one.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you create a new repo, be sure to initialize the repository with at least one file, for example a <code class="docutils literal notranslate"><span class="pre">README</span></code> file.</p>
</div>
</li>
<li><p>A Databricks <a class="reference internal" href="../workspace/index.html"><span class="doc">workspace</span></a>. <a class="reference external" href="https://docs.databricks.com/administration-guide/account-settings-e2/workspaces.html">Create a workspace</a> if you do not already have one.</p></li>
<li><p>A Databricks <a class="reference internal" href="../compute/index.html"><span class="doc">all-purpose cluster</span></a> in the workspace. To run notebooks during the design phase, you <a class="reference internal" href="notebook-ui.html#attach"><span class="std std-ref">attach the notebooks to a running all-purpose cluster</span></a>. Later on, this walkthrough uses a Databricks <a class="reference internal" href="../workflows/jobs/create-run-jobs.html"><span class="doc">job</span></a> to automate running the notebooks on this cluster. (You can also run jobs on <a class="reference internal" href="../compute/index.html"><span class="doc">job clusters</span></a> that exist only for the jobs’ lifetimes.) <a class="reference internal" href="../compute/configure.html"><span class="doc">Create an all-purpose cluster</span></a> if you do not already have one.</p></li>
</ul>
</div>
<div class="section" id="step-1-set-up-databricks-repos">
<h2>Step 1: Set up Databricks Repos<a class="headerlink" href="#step-1-set-up-databricks-repos" title="Permalink to this headline"> </a></h2>
<p>In this step, you connect your existing GitHub repo to Databricks Repos in your existing Databricks workspace.</p>
<p>To enable your workspace to connect to your GitHub repo, you must first provide your workspace with your GitHub credentials, if you have not done so already.</p>
<div class="section" id="step-11-provide-your-github-credentials">
<h3>Step 1.1: Provide your GitHub credentials<a class="headerlink" href="#step-11-provide-your-github-credentials" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>Click your username at the top right of the workspace, and then click <strong>User Settings</strong> in the dropdown list.</p></li>
<li><p>On the <strong>User Settings</strong> page, click <strong>Linked accounts</strong>.</p></li>
<li><p>Under <strong>Git integration</strong>, for <strong>Git provider</strong>, select <strong>GitHub</strong>.</p></li>
<li><p>Click <strong>Personal access token</strong>.</p></li>
<li><p>For <strong>Git provider username or email</strong>, enter your GitHub username.</p></li>
<li><p>For <strong>Token</strong>, enter your <a class="reference external" href="https://docs.github.com/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token">GitHub personal access token (classic)</a>. This personal access token (classic) must have the <strong>repo</strong> and <strong>workflow</strong> permissions.</p></li>
<li><p>Click <strong>Save</strong>.</p></li>
</ol>
</div>
<div class="section" id="step-12-connect-to-your-github-repo">
<h3>Step 1.2: Connect to your GitHub repo<a class="headerlink" href="#step-12-connect-to-your-github-repo" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>On the sidebar in the <strong>Data Science &amp; Engineering</strong> or <strong>Databricks Machine Learning</strong> environment, click <strong>Repos</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane, click <strong>Add Repo</strong>.</p></li>
<li><p>In the <strong>Add Repo</strong> dialog:</p>
<ol class="loweralpha simple">
<li><p>Click <strong>Clone remote Git repo</strong>.</p></li>
<li><p>For <strong>Git repository URL</strong>, enter the GitHub <a class="reference external" href="https://docs.github.com/repositories/creating-and-managing-repositories/cloning-a-repository">Clone with HTTPS</a> URL for your GitHub repo. This article assumes that your URL ends with <code class="docutils literal notranslate"><span class="pre">best-notebooks.git</span></code>, for example <code class="docutils literal notranslate"><span class="pre">https://github.com/&lt;your-GitHub-username&gt;/best-notebooks.git</span></code>.</p></li>
<li><p>In the drop-down list next to <strong>Git repository URL</strong>, select <strong>GitHub</strong>.</p></li>
<li><p>Leave <strong>Repo name</strong> set to the name of your repo, for example <code class="docutils literal notranslate"><span class="pre">best-notebooks</span></code>.</p></li>
<li><p>Click <strong>Create</strong>.</p></li>
</ol>
</li>
</ol>
</div>
</div>
<div class="section" id="step-2-import-and-run-the-notebook">
<h2>Step 2: Import and run the notebook<a class="headerlink" href="#step-2-import-and-run-the-notebook" title="Permalink to this headline"> </a></h2>
<p>In this step, you import an existing external notebook into your repo. You could create your own notebooks for this walkthrough, but to speed things up we provide them for you here.</p>
<div class="section" id="step-21-create-a-working-branch-in-the-repo">
<h3>Step 2.1: Create a working branch in the repo<a class="headerlink" href="#step-21-create-a-working-branch-in-the-repo" title="Permalink to this headline"> </a></h3>
<p>In this substep, you create a branch named <code class="docutils literal notranslate"><span class="pre">eda</span></code> in your repo. This branch enables you to work on files and code independently from your repo’s <code class="docutils literal notranslate"><span class="pre">main</span></code> branch, which is a software engineering best practice. (You can give your branch a different name.)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In some repos, the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch may be named <code class="docutils literal notranslate"><span class="pre">master</span></code> instead. If so, replace <code class="docutils literal notranslate"><span class="pre">main</span></code> with <code class="docutils literal notranslate"><span class="pre">master</span></code> throughout this walkthrough.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you’re not familiar with working in Git branches, see <a class="reference external" href="https://git-scm.com/book/en/v2/Git-Branching-Branches-in-a-Nutshell">Git Branches - Branches in a Nutshell</a> on the Git website.</p>
</div>
<ol class="arabic">
<li><p>If the <strong>Repos</strong> pane is not showing, then on the sidebar in the <strong>Data Science &amp; Engineering</strong> or <strong>Databricks Machine Learning</strong> environment, click <strong>Repos</strong>.</p></li>
<li><p>If the repo that you connected to in the previous step is not showing in the <strong>Repos</strong> pane, then select your workspace username, and select the name of the repo that you connected to in the previous step.</p></li>
<li><p>Click the drop-down arrow next to your repo’s name, and then click <strong>Git</strong>.</p></li>
<li><p>In the <strong>best-notebooks</strong> dialog, click the <strong>+</strong> (<strong>Create branch</strong>) button.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your repo has a name other than <code class="docutils literal notranslate"><span class="pre">best-notebooks</span></code>, this dialog’s title will be different, here and throughout this walkthrough.</p>
</div>
</li>
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">eda</span></code> and then press Enter.</p></li>
<li><p>Close this dialog.</p></li>
</ol>
</div>
<div class="section" id="step-22-import-the-notebook-into-the-repo">
<h3>Step 2.2: Import the notebook into the repo<a class="headerlink" href="#step-22-import-the-notebook-into-the-repo" title="Permalink to this headline"> </a></h3>
<p>In this substep, you import an existing notebook from another repo into your repo. This notebook does the following:</p>
<ol class="arabic simple">
<li><p>Copies a CSV file from the <a class="reference external" href="https://github.com/owid/covid-19-data">owid/covid-19-data</a> GitHub repository onto a cluster in your workspace. This CSV file contains public data about COVID-19 hospitalizations and intensive care metrics from around the world.</p></li>
<li><p>Reads the CSV file’s contents into a <a class="reference external" href="https://pandas.pydata.org/">pandas</a> <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html">DataFrame</a>.</p></li>
<li><p>Filters the data to contain metrics from only the United States.</p></li>
<li><p>Displays a plot of the data.</p></li>
<li><p>Saves the pandas DataFrame as a <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/user_guide/pandas_on_spark/index.html">Pandas API on Spark</a> <a class="reference external" href="https://api-docs.databricks.com/python/pyspark/latest/pyspark.pandas/frame.html">DataFrame</a>.</p></li>
<li><p>Performs data cleansing on the Pandas API on Spark DataFrame.</p></li>
<li><p>Writes the Pandas API on Spark DataFrame as a <a class="reference internal" href="../delta/tutorial.html#create"><span class="std std-ref">Delta table</span></a> in your workspace.</p></li>
<li><p>Displays the Delta table’s contents.</p></li>
</ol>
<p>While you could create your own notebook in your repo here, importing an existing notebook here instead helps to speed up this walkthrough. To create a notebook in this branch or move an existing notebook into this branch instead of importing a notebook, see <a class="reference internal" href="../files/workspace-basics.html"><span class="doc">Workspace files basic usage</span></a>.</p>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to your repo’s name, and then click <strong>Create &gt; Folder</strong>.</p></li>
<li><p>In the <strong>New Folder Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">notebooks</span></code>, and then click <strong>Create Folder</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane, click the name of your repo, click the drop-down arrow next to the <strong>notebooks</strong> folder, and then click <strong>Import</strong>.</p></li>
<li><p>In the <strong>Import Notebooks</strong> dialog:</p>
<ol class="loweralpha">
<li><p>For <strong>Import from</strong>, select <strong>URL</strong>.</p></li>
<li><p>Enter the URL to the raw contents of the <code class="docutils literal notranslate"><span class="pre">covid_eda_raw</span></code> notebook in the <code class="docutils literal notranslate"><span class="pre">databricks/notebook-best-practices</span></code> repo in GitHub. To get this URL:</p>
<ol class="lowerroman">
<li><p>Go to <a class="reference external" href="https://github.com/databricks/notebook-best-practices">https://github.com/databricks/notebook-best-practices</a>.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">notebooks</span></code> folder.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">covid_eda_raw.py</span></code> file.</p></li>
<li><p>Click <strong>Raw</strong>.</p></li>
<li><p>Copy the full URL from your web browser’s address bar over into the <strong>Import Notebooks</strong> dialog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>Import Notebooks</strong> dialog works with Git URLs for public repositories only.</p>
</div>
</li>
</ol>
</li>
<li><p>Click <strong>Import</strong>.</p></li>
</ol>
</li>
</ol>
</div>
<div class="section" id="step-23-run-the-notebook">
<h3>Step 2.3: Run the notebook<a class="headerlink" href="#step-23-run-the-notebook" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>If the notebook is not already showing, in the <strong>Repos</strong> pane for your repo, double-click the <strong>covid_eda_raw</strong> notebook inside of the <strong>notebooks</strong> folder to open it.</p></li>
<li><p>In the notebook, in the drop-down list next to <strong>File</strong>, <a class="reference internal" href="notebook-ui.html#attach"><span class="std std-ref">select the cluster to attach this notebook to</span></a>. For instructions on creating a cluster, see <a class="reference internal" href="../compute/configure.html"><span class="doc">Create a cluster</span></a>.</p></li>
<li><p>Click <strong>Run All</strong>.</p></li>
<li><p>If prompted, click <strong>Attach &amp; Run</strong> or <strong>Start, Attach &amp; Run</strong>.</p></li>
<li><p>Wait while the notebook runs.</p></li>
</ol>
<p>After the notebook finishes running, in the notebook you should see a plot of the data as well as over 600 rows of raw data in the Delta table. If the cluster was not already running when you started running this notebook, it could take several minutes for the cluster to start up before displaying the results.</p>
</div>
<div class="section" id="step-24-check-in-and-merge-the-notebook">
<h3>Step 2.4: Check in and merge the notebook<a class="headerlink" href="#step-24-check-in-and-merge-the-notebook" title="Permalink to this headline"> </a></h3>
<p>In this substep, you save your work so far to your GitHub repo. You then merge the notebook from your working branch into your repo’s <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p>
<ol class="arabic simple">
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>eda</strong> branch.</p></li>
<li><p>In the <strong>best-notebooks</strong> dialog, on the <strong>Changes</strong> tab, make sure the <strong>notebooks/covid_eda_raw.py</strong> file is selected.</p></li>
<li><p>For <strong>Summary (required)</strong>, enter <code class="docutils literal notranslate"><span class="pre">Added</span> <span class="pre">raw</span> <span class="pre">notebook</span></code>.</p></li>
<li><p>For <strong>Description (optional)</strong>, enter <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">first</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">notebook.</span></code></p></li>
<li><p>Click <strong>Commit &amp; Push</strong>.</p></li>
<li><p>Click <strong>History</strong>, or click <strong>Create a pull request on your git provider</strong> link in the popup.</p></li>
<li><p>In GitHub, click the <strong>Pull requests</strong> tab, create the pull request, and then merge the pull request into the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p></li>
<li><p>Back in your Databricks workspace, close the <strong>best-notebooks</strong> dialog if it is still showing.</p></li>
</ol>
</div>
</div>
<div class="section" id="step-3-move-code-into-a-shared-module">
<h2>Step 3: Move code into a shared module<a class="headerlink" href="#step-3-move-code-into-a-shared-module" title="Permalink to this headline"> </a></h2>
<p>In this step, you move some of the code in your notebook into a set of shared functions outside of your notebook. This enables you to use these functions with other similar notebooks, which can speed up future coding and help ensure more predictable and consistent notebook results. Sharing this code also enables you to more easily test these functions, which as a software engineering best practice can raise the overall quality of your code as you go.</p>
<div class="section" id="step-31-create-another-working-branch-in-the-repo">
<h3>Step 3.1: Create another working branch in the repo<a class="headerlink" href="#step-31-create-another-working-branch-in-the-repo" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In your workspace, in the <strong>Repos</strong> pane for your repo, click the <strong>eda</strong> branch.</p></li>
<li><p>in the <strong>best-notebooks</strong> dialog, click the drop-down arrow next to the <strong>eda</strong> branch, and select <strong>main</strong>.</p></li>
<li><p>Click the <strong>Pull</strong> button. If prompted to proceed with pulling, click <strong>Confirm</strong>.</p></li>
<li><p>Click the <strong>+</strong> (<strong>Create branch</strong>) button.</p></li>
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">first_modules</span></code>, and then press Enter. (You can give your branch a different name.)</p></li>
<li><p>Close this dialog.</p></li>
</ol>
</div>
<div class="section" id="step-32-import-the-notebook-into-the-repo">
<h3>Step 3.2: Import the notebook into the repo<a class="headerlink" href="#step-32-import-the-notebook-into-the-repo" title="Permalink to this headline"> </a></h3>
<p>To speed up this walkthrough, in this substep you import another existing notebook into your repo. This notebook does the same things as the previous notebook, except this notebook will call shared code functions that are stored outside of the notebook. Again, you could create your own notebook in your repo here and do the actual code sharing yourself.</p>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to the <code class="docutils literal notranslate"><span class="pre">notebooks</span></code> folder, and then click <strong>Import</strong>.</p></li>
<li><p>In the <strong>Import Notebooks</strong> dialog:</p>
<ol class="loweralpha">
<li><p>For <strong>Import from</strong>, select <strong>URL</strong>.</p></li>
<li><p>Enter the URL to the raw contents of the <code class="docutils literal notranslate"><span class="pre">covid_eda_modular</span></code> notebook in the <code class="docutils literal notranslate"><span class="pre">databricks/notebook-best-practices</span></code> repo in GitHub. To get this URL:</p>
<ol class="lowerroman">
<li><p>Go to <a class="reference external" href="https://github.com/databricks/notebook-best-practices">https://github.com/databricks/notebook-best-practices</a>.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">notebooks</span></code> folder.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">covid_eda_modular.py</span></code> file.</p></li>
<li><p>Click <strong>Raw</strong>.</p></li>
<li><p>Copy the full URL from your web browser’s address bar over into the <strong>Import Notebooks</strong> dialog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>Import Notebooks</strong> dialog works with Git URLs for public repositories only.</p>
</div>
</li>
</ol>
</li>
<li><p>Click <strong>Import</strong>.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You could delete the existing <code class="docutils literal notranslate"><span class="pre">covid_eda_raw</span></code> notebook at this point, because the new <code class="docutils literal notranslate"><span class="pre">covid_eda_modular</span></code> notebook is a shared version of the first notebook. However, you might still want to keep the previous notebook for comparison purposes, even though you will not use it anymore.</p>
</div>
</li>
</ol>
</div>
<div class="section" id="step-33-add-the-notebooks-supporting-shared-code-functions">
<h3>Step 3.3: Add the notebook’s supporting shared code functions<a class="headerlink" href="#step-33-add-the-notebooks-supporting-shared-code-functions" title="Permalink to this headline"> </a></h3>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to your repo’s name, and then click <strong>Create &gt; Folder</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not click the drop-down arrow next to the <strong>notebooks</strong> folder. Click the drop-down arrow next to your repo’s name instead. You want this to go into the root of the repo, not into the <code class="docutils literal notranslate"><span class="pre">notebooks</span></code> folder.</p>
</div>
</li>
<li><p>In the <strong>New Folder Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">covid_analysis</span></code>, and then click <strong>Create Folder</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to the <strong>covid_analysis</strong> folder, and then click <strong>Create &gt; File</strong>.</p></li>
<li><p>In the <strong>New File Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">transforms.py</span></code>, and then click <strong>Create File</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>covid_analysis</strong> folder, and then click <strong>transforms.py</strong>.</p></li>
<li><p>In the editor window, enter the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Filter by country code.</span>
<span class="k">def</span> <span class="nf">filter_country</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="s2">&quot;USA&quot;</span><span class="p">):</span>
  <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="p">[</span><span class="n">pdf</span><span class="o">.</span><span class="n">iso_code</span> <span class="o">==</span> <span class="n">country</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">pdf</span>

<span class="c1"># Pivot by indicator, and fill missing values.</span>
<span class="k">def</span> <span class="nf">pivot_and_clean</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">fillna</span><span class="p">):</span>
  <span class="n">pdf</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">pdf</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
  <span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fillna</span><span class="p">)</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;indicator&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s2">&quot;date&quot;</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">pdf</span>

<span class="c1"># Create column names that are compatible with Delta tables.</span>
<span class="k">def</span> <span class="nf">clean_spark_cols</span><span class="p">(</span><span class="n">pdf</span><span class="p">):</span>
  <span class="n">pdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">pdf</span>

<span class="c1"># Convert index to column (works with pandas API on Spark, too).</span>
<span class="k">def</span> <span class="nf">index_to_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">colname</span><span class="p">):</span>
  <span class="n">df</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
  <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For other code sharing techniques, see <a class="reference internal" href="share-code.html"><span class="doc">Share code between Databricks notebooks</span></a>.</p>
</div>
</div>
<div class="section" id="step-34-add-the-shared-codes-dependencies">
<h3>Step 3.4: Add the shared code’s dependencies<a class="headerlink" href="#step-34-add-the-shared-codes-dependencies" title="Permalink to this headline"> </a></h3>
<p>The preceding code has several Python package dependencies to enable the code to run properly. In this substep, you declare these package dependencies. Declaring dependencies improves reproducibility by using precisely defined versions of libraries.</p>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to your repo’s name, and then click <strong>Create &gt; File</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not click the drop-down arrow next to the <strong>notebooks</strong> or <strong>covid_analysis</strong> folders. You want the list of package dependencies to go into the repo’s root folder, not the <strong>notebooks</strong> or <strong>covid_analysis</strong> folders.</p>
</div>
</li>
<li><p>In the <strong>New File Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>, and then click <strong>Create File</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click <strong>requirements.txt</strong>, and enter the following code:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> file is not visible, you may need to refresh your web browser.</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-i https://pypi.org/simple
attrs==21.4.0
cycler==0.11.0
fonttools==4.33.3
iniconfig==1.1.1
kiwisolver==1.4.2
matplotlib==3.5.1
numpy==1.22.3
packaging==21.3
pandas==1.4.2
pillow==9.1.0
pluggy==1.0.0
py==1.11.0
py4j==0.10.9.3
pyarrow==7.0.0
pyparsing==3.0.8
pyspark==3.2.1
pytest==7.1.2
python-dateutil==2.8.2
pytz==2022.1
six==1.16.0
tomli==2.0.1
wget==3.2
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The preceding file lists specific package versions. For better compatibility, you can cross-reference these versions with the ones that are installed on your all-purpose cluster. See the “System environment” section for your cluster’s Databricks Runtime version in <a class="reference internal" href="../release-notes/runtime/index.html"><span class="doc">Databricks Runtime release notes versions and compatibility</span></a>.</p>
</div>
</li>
</ol>
<p>Your repo structure should now look like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>|-- covid_analysis
|   `-- transforms.py
|-- notebooks
|   |-- covid_eda_modular
|   `-- covid_eda_raw (optional)
`-- requirements.txt
</pre></div>
</div>
</div>
<div class="section" id="step-35-run-the-refactored-notebook">
<h3>Step 3.5: Run the refactored notebook<a class="headerlink" href="#step-35-run-the-refactored-notebook" title="Permalink to this headline"> </a></h3>
<p>In this substep, you run the <code class="docutils literal notranslate"><span class="pre">covid_eda_modular</span></code> notebook, which calls the shared code in <code class="docutils literal notranslate"><span class="pre">covid_analysis/transforms.py</span></code>.</p>
<ol class="arabic simple">
<li><p>In the <strong>Repos</strong> pane for your repo, double-click the <strong>covid_eda_modular</strong> notebook inside the <strong>notebooks</strong> folder.</p></li>
<li><p>In the drop-down list next to <strong>File</strong>, select the cluster to attach this notebook to.</p></li>
<li><p>Click <strong>Run All</strong>.</p></li>
<li><p>If prompted, click <strong>Attach &amp; Run</strong> or <strong>Start, Attach &amp; Run</strong>.</p></li>
<li><p>Wait while the notebook runs.</p></li>
</ol>
<p>After the notebook finishes running, in the notebook you should see similar results as the <code class="docutils literal notranslate"><span class="pre">covid_eda_raw</span></code> notebook: a plot of the data as well as over 600 rows of raw data in the Delta table. The main difference with this notebook is that a different filter is used (an <code class="docutils literal notranslate"><span class="pre">iso_code</span></code> of <code class="docutils literal notranslate"><span class="pre">DZA</span></code> instead of <code class="docutils literal notranslate"><span class="pre">USA</span></code>). If the cluster was not already running when you started running this notebook, it could take several minutes for the cluster to start up before displaying the results.</p>
</div>
<div class="section" id="step-36-check-in-the-notebook-and-its-related-code">
<h3>Step 3.6: Check in the notebook and its related code<a class="headerlink" href="#step-36-check-in-the-notebook-and-its-related-code" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>first_modules</strong> branch.</p></li>
<li><p>In the <strong>best-notebooks</strong> dialog, on the <strong>Changes</strong> tab, make sure the following are selected:</p>
<ul class="simple">
<li><p><strong>requirements.txt</strong></p></li>
<li><p><strong>covid_analysis/transforms.py</strong></p></li>
<li><p><strong>notebooks/covid_eda_modular.py</strong></p></li>
</ul>
</li>
<li><p>For <strong>Summary (required)</strong>, enter <code class="docutils literal notranslate"><span class="pre">Added</span> <span class="pre">refactored</span> <span class="pre">notebook</span></code>.</p></li>
<li><p>For <strong>Description (optional)</strong>, enter <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">is</span> <span class="pre">the</span> <span class="pre">second</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">notebook.</span></code></p></li>
<li><p>Click <strong>Commit &amp; Push</strong>.</p></li>
<li><p>Click <strong>History</strong>, or click <strong>Create a pull request on your git provider</strong> link in the popup.</p></li>
<li><p>In GitHub, click the <strong>Pull requests</strong> tab, create the pull request, and then merge the pull request into the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p></li>
<li><p>Back in your Databricks workspace, close the <strong>best-notebooks</strong> dialog if it is still showing.</p></li>
</ol>
</div>
</div>
<div class="section" id="step-4-test-the-shared-code">
<h2>Step 4: Test the shared code<a class="headerlink" href="#step-4-test-the-shared-code" title="Permalink to this headline"> </a></h2>
<p>In this step, you test the shared code from the last step. However, you want to test this code without running the <code class="docutils literal notranslate"><span class="pre">covid_eda_modular</span></code> notebook itself. This is because if the shared code fails to run, the notebook itself would likely fail to run as well. You want to catch failures in your shared code first before having your main notebook eventually fail later. This testing technique is a software engineering best practice.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For additional approaches to testing for notebooks, as well as testing for R and Scala notebooks, see <a class="reference internal" href="testing.html"><span class="doc">Unit testing for notebooks</span></a>.</p>
</div>
<div class="section" id="step-41-create-another-working-branch-in-the-repo">
<h3>Step 4.1: Create another working branch in the repo<a class="headerlink" href="#step-41-create-another-working-branch-in-the-repo" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In your workspace, in the <strong>Repos</strong> pane for your repo, click the <strong>first_modules</strong> branch.</p></li>
<li><p>in the <strong>best-notebooks</strong> dialog, click the drop-down arrow next to the <strong>first_modules</strong> branch, and select <strong>main</strong>.</p></li>
<li><p>Click the <strong>Pull</strong> button. If prompted to proceed with pulling, click <strong>Confirm</strong>.</p></li>
<li><p>Click the <strong>+</strong> (<strong>Create branch</strong>) button.</p></li>
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">first_tests</span></code>, and then press Enter. (You can give your branch a different name.)</p></li>
<li><p>Close this dialog.</p></li>
</ol>
</div>
<div class="section" id="step-42-add-the-tests">
<h3>Step 4.2: Add the tests<a class="headerlink" href="#step-42-add-the-tests" title="Permalink to this headline"> </a></h3>
<p>In this substep, you use the <a class="reference external" href="https://docs.pytest.org/">pytest</a> framework to test your shared code. In these tests, you <a class="reference external" href="https://docs.pytest.org/en/7.1.x/getting-started.html">assert</a> whether particular test results are achieved. If any test produces an unexpected result, that particular test fails the assertion and thus the test itself fails.</p>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to your repo’s name, and then click <strong>Create &gt; Folder</strong>.</p></li>
<li><p>In the <strong>New Folder Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">tests</span></code>, and then click <strong>Create Folder</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to the <strong>tests</strong> folder, and then click <strong>Create &gt; File</strong>.</p></li>
<li><p>In the <strong>New File Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">testdata.csv</span></code>, and then click <strong>Create File</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>tests</strong> folder, and then click <strong>testdata.csv</strong>.</p></li>
<li><p>In the editor window, enter the following test data:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>entity,iso_code,date,indicator,value
United States,USA,2022-04-17,Daily ICU occupancy,
United States,USA,2022-04-17,Daily ICU occupancy per million,4.1
United States,USA,2022-04-17,Daily hospital occupancy,10000
United States,USA,2022-04-17,Daily hospital occupancy per million,30.3
United States,USA,2022-04-17,Weekly new hospital admissions,11000
United States,USA,2022-04-17,Weekly new hospital admissions per million,32.8
Algeria,DZA,2022-04-18,Daily ICU occupancy,1010
Algeria,DZA,2022-04-18,Daily ICU occupancy per million,4.5
Algeria,DZA,2022-04-18,Daily hospital occupancy,11000
Algeria,DZA,2022-04-18,Daily hospital occupancy per million,30.9
Algeria,DZA,2022-04-18,Weekly new hospital admissions,10000
Algeria,DZA,2022-04-18,Weekly new hospital admissions per million,32.1
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using test data is a software engineering best practice. This enables you to run your tests faster, relying on a small portion of the data that has the same format as your real data. Of course, you want to always make sure that this test data accurately represents your real data before you run your tests.</p>
</div>
</li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to the <strong>tests</strong> folder, and then click <strong>Create &gt; File</strong>.</p></li>
<li><p>In the <strong>New File Name</strong> dialog, enter <code class="docutils literal notranslate"><span class="pre">transforms_test.py</span></code>, and then click <strong>Create File</strong>.</p></li>
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>tests</strong> folder, and then click <strong>transforms_test.py</strong>.</p></li>
<li><p>In the editor window, enter the following test code. These tests use standard <code class="docutils literal notranslate"><span class="pre">pytest</span></code> <a class="reference external" href="https://docs.pytest.org/en/7.1.x/explanation/fixtures.html#about-fixtures">fixtures</a> as well as a mocked in-memory pandas DataFrame:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test each of the transform functions.</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">fill</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">covid_analysis.transforms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">raw_input_df</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Create a basic version of the input dataset for testing, including NaNs.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;tests/testdata.csv&#39;</span><span class="p">)</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">colnames_df</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
  <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
      <span class="s2">&quot;Daily ICU occupancy&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Daily ICU occupancy per million&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Daily hospital occupancy&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Daily hospital occupancy per million&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Weekly new hospital admissions&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Weekly new hospital admissions per million&quot;</span>
    <span class="p">]</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="n">df</span>

<span class="c1"># Make sure the filter works as expected.</span>
<span class="k">def</span> <span class="nf">test_filter</span><span class="p">(</span><span class="n">raw_input_df</span><span class="p">):</span>
  <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_country</span><span class="p">(</span><span class="n">raw_input_df</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">filtered</span><span class="o">.</span><span class="n">iso_code</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;USA&quot;</span>

<span class="c1"># The test data has NaNs for Daily ICU occupancy; this should get filled to 0.</span>
<span class="k">def</span> <span class="nf">test_pivot</span><span class="p">(</span><span class="n">raw_input_df</span><span class="p">):</span>
  <span class="n">pivoted</span> <span class="o">=</span> <span class="n">pivot_and_clean</span><span class="p">(</span><span class="n">raw_input_df</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">pivoted</span><span class="p">[</span><span class="s2">&quot;Daily ICU occupancy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>

<span class="c1"># Test column cleaning.</span>
<span class="k">def</span> <span class="nf">test_clean_cols</span><span class="p">(</span><span class="n">colnames_df</span><span class="p">):</span>
  <span class="n">cleaned</span> <span class="o">=</span> <span class="n">clean_spark_cols</span><span class="p">(</span><span class="n">colnames_df</span><span class="p">)</span>
  <span class="n">cols_w_spaces</span> <span class="o">=</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>
  <span class="k">assert</span> <span class="n">cols_w_spaces</span><span class="o">.</span><span class="n">empty</span> <span class="o">==</span> <span class="kc">True</span>

<span class="c1"># Test column creation from index.</span>
<span class="k">def</span> <span class="nf">test_index_to_col</span><span class="p">(</span><span class="n">raw_input_df</span><span class="p">):</span>
  <span class="n">raw_input_df</span><span class="p">[</span><span class="s2">&quot;col_from_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_input_df</span><span class="o">.</span><span class="n">index</span>
  <span class="k">assert</span> <span class="p">(</span><span class="n">raw_input_df</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">raw_input_df</span><span class="o">.</span><span class="n">col_from_index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
<p>Your repo structure should now look like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>|-- covid_analysis
|   `-- transforms.py
|-- notebooks
|   |-- covid_eda_modular
|   `-- covid_eda_raw (optional)
|-- requirements.txt
`-- tests
    |-- testdata.csv
    `-- transforms_test.py
</pre></div>
</div>
</div>
<div class="section" id="step-43-run-the-tests">
<h3>Step 4.3: Run the tests<a class="headerlink" href="#step-43-run-the-tests" title="Permalink to this headline"> </a></h3>
<p>To speed up this walkthrough, in this substep you use an imported notebook to run the preceding tests. This notebook downloads and installs the tests’ dependent Python packages into your workspace, runs the tests, and reports the tests’ results. While you could run <code class="docutils literal notranslate"><span class="pre">pytest</span></code> from your cluster’s <a class="reference internal" href="../compute/web-terminal.html"><span class="doc">web terminal</span></a>, running <code class="docutils literal notranslate"><span class="pre">pytest</span></code> from a notebook can be more convenient.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">pytest</span></code> runs all files whose names follow the form <code class="docutils literal notranslate"><span class="pre">test_*.py</span></code> or <code class="docutils literal notranslate"><span class="pre">\*_test.py</span></code> in the current directory and its subdirectories.</p>
</div>
<ol class="arabic">
<li><p>In the <strong>Repos</strong> pane for your repo, click the drop-down arrow next to the <strong>notebooks</strong> folder, and then click <strong>Import</strong>.</p></li>
<li><p>In the <strong>Import Notebooks</strong> dialog:</p>
<ol class="loweralpha">
<li><p>For <strong>Import from</strong>, select <strong>URL</strong>.</p></li>
<li><p>Enter the URL to the raw contents of the <code class="docutils literal notranslate"><span class="pre">run_unit_tests</span></code> notebook in the <code class="docutils literal notranslate"><span class="pre">databricks/notebook-best-practices</span></code> repo in GitHub. To get this URL:</p>
<ol class="lowerroman">
<li><p>Go to <a class="reference external" href="https://github.com/databricks/notebook-best-practices">https://github.com/databricks/notebook-best-practices</a>.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">notebooks</span></code> folder.</p></li>
<li><p>Click the <code class="docutils literal notranslate"><span class="pre">run_unit_tests.py</span></code> file.</p></li>
<li><p>Click <strong>Raw</strong>.</p></li>
<li><p>Copy the full URL from your web browser’s address bar over into the <strong>Import Notebooks</strong> dialog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <strong>Import Notebooks</strong> dialog works with Git URLs for public repositories only.</p>
</div>
</li>
</ol>
</li>
<li><p>Click <strong>Import</strong>.</p></li>
</ol>
</li>
<li><p>If the notebook is not already showing, in the <strong>Repos</strong> pane for your repo, click the <strong>notebooks</strong> folder, and then double-click the <strong>run_unit_tests</strong> notebook.</p></li>
<li><p>In the drop-down list next to <strong>File</strong>, select the cluster to attach this notebook to.</p></li>
<li><p>Click <strong>Run All</strong>.</p></li>
<li><p>If prompted, click <strong>Attach &amp; Run</strong> or <strong>Start, Attach &amp; Run</strong>.</p></li>
<li><p>Wait while the notebook runs.</p></li>
</ol>
<p>After the notebook finishes running, in the notebook you should see information about the number of passing and failed tests, along with other related details. If the cluster was not already running when you started running this notebook, it could take several minutes for the cluster to start up before displaying the results.</p>
<p>Your repo structure should now look like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>|-- covid_analysis
|   `-- transforms.py
|-- notebooks
|   |-- covid_eda_modular
|   |-- covid_eda_raw (optional)
|   `-- run_unit_tests
|-- requirements.txt
`-- tests
    |-- testdata.csv
    `-- transforms_test.py
</pre></div>
</div>
</div>
<div class="section" id="step-44-check-in-the-notebook-and-related-tests">
<h3>Step 4.4: Check in the notebook and related tests<a class="headerlink" href="#step-44-check-in-the-notebook-and-related-tests" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>first_tests</strong> branch.</p></li>
<li><p>In the <strong>best-notebooks</strong> dialog, on the <strong>Changes</strong> tab, make sure the following are selected:</p>
<ul class="simple">
<li><p><strong>tests/transforms_test.py</strong></p></li>
<li><p><strong>notebooks/run_unit_tests.py</strong></p></li>
<li><p><strong>tests/testdata.csv</strong></p></li>
</ul>
</li>
<li><p>For <strong>Summary (required)</strong>, enter <code class="docutils literal notranslate"><span class="pre">Added</span> <span class="pre">tests</span></code>.</p></li>
<li><p>For <strong>Description (optional)</strong>, enter <code class="docutils literal notranslate"><span class="pre">These</span> <span class="pre">are</span> <span class="pre">the</span> <span class="pre">unit</span> <span class="pre">tests</span> <span class="pre">for</span> <span class="pre">the</span> <span class="pre">shared</span> <span class="pre">code.</span></code>.</p></li>
<li><p>Click <strong>Commit &amp; Push</strong>.</p></li>
<li><p>Click <strong>History</strong>, or click <strong>Create a pull request on your git provider</strong> link in the popup.</p></li>
<li><p>In GitHub, click the <strong>Pull requests</strong> tab, create the pull request, and then merge the pull request into the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p></li>
<li><p>Back in your Databricks workspace, close the <strong>best-notebooks</strong> dialog if it is still showing.</p></li>
</ol>
</div>
</div>
<div class="section" id="step-5-create-a-job-to-run-the-notebooks">
<h2>Step 5: Create a job to run the notebooks<a class="headerlink" href="#step-5-create-a-job-to-run-the-notebooks" title="Permalink to this headline"> </a></h2>
<p>In previous steps, you tested your shared code manually and ran your notebooks manually. In this step, you use a Databricks job to test your shared code and run your notebooks automatically, either on-demand or on a regular schedule.</p>
<div class="section" id="step-51-create-a-job-task-to-run-the-testing-notebook">
<h3>Step 5.1: Create a job task to run the testing notebook<a class="headerlink" href="#step-51-create-a-job-task-to-run-the-testing-notebook" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>On the sidebar in the <strong>Data Science &amp; Engineering</strong> or <strong>Databricks Machine Learning</strong> environment, click <strong>Workflows</strong>.</p></li>
<li><p>On the <strong>Jobs</strong> tab, click <strong>Create Job</strong>.</p></li>
<li><p>For <strong>Add a name for your job</strong> (which is next to the <strong>Runs</strong> and <strong>Tasks</strong> tabs), enter <code class="docutils literal notranslate"><span class="pre">covid_report</span></code>.</p></li>
<li><p>For <strong>Task name</strong>, enter <code class="docutils literal notranslate"><span class="pre">run_notebook_tests</span></code>.</p></li>
<li><p>For <strong>Type</strong>, select <strong>Notebook</strong>.</p></li>
<li><p>For <strong>Source</strong>, select <strong>Git</strong>.</p></li>
<li><p>Click <strong>Add a git reference</strong>.</p></li>
<li><p>In the <strong>Git information</strong> dialog:</p>
<ol class="loweralpha simple">
<li><p>For <strong>Git repository URL</strong>, enter the GitHub <a class="reference external" href="https://docs.github.com/repositories/creating-and-managing-repositories/cloning-a-repository">Clone with HTTPS</a> URL for your GitHub repo. This article assumes that your URL ends with <code class="docutils literal notranslate"><span class="pre">best-notebooks.git</span></code>, for example <code class="docutils literal notranslate"><span class="pre">https://github.com/&lt;your-GitHub-username&gt;/best-notebooks.git</span></code>.</p></li>
<li><p>For <strong>Git provider</strong>, select <strong>GitHub</strong>.</p></li>
<li><p>For <strong>Git reference (branch / tag / commit)</strong>, enter <code class="docutils literal notranslate"><span class="pre">main</span></code>.</p></li>
<li><p>Next to <strong>Git reference (branch / tag / commit)</strong>, select <strong>branch</strong>.</p></li>
<li><p>Click <strong>Confirm</strong>.</p></li>
</ol>
</li>
<li><p>For <strong>Path</strong>, enter <code class="docutils literal notranslate"><span class="pre">notebooks/run_unit_tests</span></code>. Do not add the <code class="docutils literal notranslate"><span class="pre">.py</span></code> file extension.</p></li>
<li><p>For <strong>Cluster</strong>, select the cluster from the previous step.</p></li>
<li><p>Click <strong>Create</strong>.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this scenario, Databricks does not recommend that you use the schedule button in the notebook as described in <a class="reference internal" href="schedule-notebook-jobs.html"><span class="doc">Create and manage scheduled notebook jobs</span></a> to schedule a job to run this notebook periodically. This is because the schedule button creates a job by using the latest <em>working</em> copy of the notebook in the workspace repo. Instead, Databricks recommends that you follow the preceding instructions to create a job that uses the latest <em>committed</em> version of the notebook in the repo.</p>
</div>
</div>
<div class="section" id="step-52-create-a-job-task-to-run-the-main-notebook">
<h3>Step 5.2: Create a job task to run the main notebook<a class="headerlink" href="#step-52-create-a-job-task-to-run-the-main-notebook" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>Click the <strong>+ Add task</strong> icon.</p></li>
<li><p>A pop-up menu appears. Select <strong>Notebook</strong>.</p></li>
<li><p>For <strong>Task name</strong>, enter <code class="docutils literal notranslate"><span class="pre">run_main_notebook</span></code>.</p></li>
<li><p>For <strong>Type</strong>, select <strong>Notebook</strong>.</p></li>
<li><p>For <strong>Path</strong>, enter <code class="docutils literal notranslate"><span class="pre">notebooks/covid_eda_modular</span></code>. Do not add the <code class="docutils literal notranslate"><span class="pre">.py</span></code> file extension.</p></li>
<li><p>For <strong>Cluster</strong>, select the cluster from the previous step.</p></li>
<li><p>Click <strong>Create task</strong>.</p></li>
</ol>
</div>
<div class="section" id="step-53-run-the-job">
<h3>Step 5.3 Run the job<a class="headerlink" href="#step-53-run-the-job" title="Permalink to this headline"> </a></h3>
<ol class="arabic">
<li><p>Click <strong>Run now</strong>.</p></li>
<li><p>In the pop-up, click <strong>View run</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the pop-up disappears too quickly, then do the following:</p>
<ol class="loweralpha simple">
<li><p>On the sidebar in the <strong>Data Science &amp; Engineering</strong> or <strong>Databricks Machine Learning</strong> environment, click <strong>Workflows</strong>.</p></li>
<li><p>On the <strong>Job runs</strong> tab, click the <strong>Start time</strong> value for the latest job with <strong>covid_report</strong> in the <strong>Jobs</strong> column.</p></li>
</ol>
</div>
</li>
<li><p>To see the job results, click on the <strong>run_notebook_tests</strong> tile, the <strong>run_main_notebook</strong> tile, or both. The results on each tile are the same as if you ran the notebooks yourself, one by one.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This job ran on-demand. To set up this job to run on a regular basis, see <a class="reference internal" href="../workflows/jobs/schedule-jobs.html#job-schedule"><span class="std std-ref">Add a job schedule</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="optional-step-6-set-up-the-repo-to-test-the-code-and-run-the-notebook-automatically-whenever-the-code-changes">
<h2>(Optional) Step 6: Set up the repo to test the code and run the notebook automatically whenever the code changes<a class="headerlink" href="#optional-step-6-set-up-the-repo-to-test-the-code-and-run-the-notebook-automatically-whenever-the-code-changes" title="Permalink to this headline"> </a></h2>
<p>In the previous step, you used a job to automatically test your shared code and run your notebooks at a point in time or on a recurring basis. However, you may prefer to trigger tests automatically when changes are merged into your GitHub repo. You can perform this automation by using a CI/CD platform such as <a class="reference external" href="https://docs.github.com/actions">GitHub Actions</a>.</p>
<div class="section" id="step-61-set-up-github-access-to-your-workspace">
<h3>Step 6.1: Set up GitHub access to your workspace<a class="headerlink" href="#step-61-set-up-github-access-to-your-workspace" title="Permalink to this headline"> </a></h3>
<p>In this substep, you set up a GitHub Actions workflow that run jobs in the workspace whenever changes are merged into your repository. You do this by giving GitHub a unique Databricks token for access.</p>
<p>For security reasons, Databricks discourages you from giving your Databricks workspace user’s personal access token to GitHub. Instead, Databricks recommends that you give GitHub a Databricks access token that is associated with a Databricks service principal. For instructions, see the <a class="reference external" href="https://github.com/marketplace/actions/run-databricks-notebook#aws">AWS</a> section of the <a class="reference external" href="https://github.com/marketplace/actions/run-databricks-notebook">Run Databricks Notebook GitHub Action</a> page in the GitHub Actions Marketplace.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Notebooks are run with all of the workspace permissions of the identity that is associated with the token, so Databricks recommends using a service principal. If you really want to give your Databricks workspace user’s personal access token to GitHub for personal exploration purposes only, and you understand that for security reasons Databricks discourages this practice, see the instructions to <a class="reference internal" href="../dev-tools/auth/pat.html"><span class="doc">create your workspace user’s personal access token</span></a>.</p>
</div>
</div>
<div class="section" id="step-62-add-the-github-actions-workflow">
<h3>Step 6.2: Add the GitHub Actions workflow<a class="headerlink" href="#step-62-add-the-github-actions-workflow" title="Permalink to this headline"> </a></h3>
<p>In this substep, you add a GitHub Actions workflow to run the <code class="docutils literal notranslate"><span class="pre">run_unit_tests</span></code> notebook whenever there is a pull request to the repo.</p>
<p>This substep stores the GitHub Actions workflow in a file that is stored within multiple folder levels in your GitHub repo. GitHub Actions requires a specific nested folder hierarchy to exist in your repo in order to work properly. To complete this step, you must use the website for your GitHub repo, because the Databricks Repos user interface does not support creating nested folder hierarchies.</p>
<ol class="arabic">
<li><p>In the website for your GitHub repo, click the <strong>Code</strong> tab.</p></li>
<li><p>In the <strong>Switch branches or tags</strong> drop-down list, select <strong>main</strong>, if it is not already selected.</p></li>
<li><p>If the <strong>Switch branches or tags</strong> drop-down list does not show the <strong>Find or create a branch</strong> box, click <strong>main</strong> again.</p></li>
<li><p>In the <strong>Find or create a branch</strong> box, enter <code class="docutils literal notranslate"><span class="pre">adding_github_actions</span></code>.</p></li>
<li><p>Click <strong>Create branch: adding_github_actions from ‘main’</strong>.</p></li>
<li><p>Click <strong>Add file &gt; Create new file</strong>.</p></li>
<li><p>For <strong>Name your file</strong>, enter <code class="docutils literal notranslate"><span class="pre">.github/workflows/databricks_pull_request_tests.yml</span></code>.</p></li>
<li><p>In the editor window, enter the following code. This code uses declares the pull_request hook to use the <a class="reference external" href="https://github.com/marketplace/actions/run-databricks-notebook">Run Databricks Notebook GitHub Action</a> to run the <code class="docutils literal notranslate"><span class="pre">run_unit_tests</span></code> notebook.</p>
<p>In the following code, replace:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;your-workspace-instance-URL&gt;</span></code> with your Databricks <a class="reference internal" href="../workspace/workspace-details.html#workspace-url"><span class="std std-ref">instance name</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;your-access-token&gt;</span></code> with the token that you generated earlier.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;your-cluster-id&gt;</span></code> with your target <a class="reference internal" href="../workspace/workspace-details.html#cluster-url-and-id"><span class="std std-ref">cluster ID</span></a>.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run pre-merge Databricks tests</span>

<span class="nt">on</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pull_request</span><span class="p">:</span>

<span class="nt">env</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Replace this value with your workspace instance name.</span>
<span class="w">  </span><span class="nt">DATABRICKS_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://&lt;your-workspace-instance-name&gt;</span>

<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">unit-test-notebook</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
<span class="w">    </span><span class="nt">timeout-minutes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>

<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout repo</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run test notebook</span>
<span class="w">        </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">databricks/run-notebook@main</span>
<span class="w">        </span><span class="nt">with</span><span class="p">:</span>
<span class="w">          </span><span class="nt">databricks-token</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;your-access-token&gt;</span>

<span class="w">          </span><span class="nt">local-notebook-path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">notebooks/run_unit_tests.py</span>

<span class="w">          </span><span class="nt">existing-cluster-id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;your-cluster-id&gt;</span>

<span class="w">          </span><span class="nt">git-commit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${{</span><span class="nv"> </span><span class="s">github.event.pull_request.head.sha</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">          </span><span class="c1"># Grant all users view permission on the notebook&#39;s results, so that they can</span>
<span class="w">          </span><span class="c1"># see the result of the notebook, if they have related access permissions.</span>
<span class="w">          </span><span class="nt">access-control-list-json</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;</span>
<span class="w">            </span><span class="no">[</span>
<span class="w">              </span><span class="no">{</span>
<span class="w">                </span><span class="no">&quot;group_name&quot;: &quot;users&quot;,</span>
<span class="w">                </span><span class="no">&quot;permission_level&quot;: &quot;CAN_VIEW&quot;</span>
<span class="w">              </span><span class="no">}</span>
<span class="w">            </span><span class="no">]</span>
<span class="w">          </span><span class="nt">run-name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;EDA</span><span class="nv"> </span><span class="s">transforms</span><span class="nv"> </span><span class="s">helper</span><span class="nv"> </span><span class="s">module</span><span class="nv"> </span><span class="s">unit</span><span class="nv"> </span><span class="s">tests&quot;</span>
</pre></div>
</div>
</li>
<li><p>Select <strong>Commit directly to the adding_github_actions branch</strong>.</p></li>
<li><p>Click <strong>Commit changes</strong>.</p></li>
<li><p>On the <strong>Code</strong> tab, click <strong>Compare &amp; pull request</strong>, and then create the pull request.</p></li>
<li><p>On the pull request page, wait for the icon next to <strong>Run pre-merge Databricks tests / unit-test-notebook (pull_request)</strong> to display a green check mark. (It may take a few moments for the icon to appear.) If there is a red X instead of a green check mark, click <strong>Details</strong> to find out why. If the icon or <strong>Details</strong> are no longer showing, click <strong>Show all checks</strong>.</p></li>
<li><p>If the green check mark appears, merge the pull request into the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p></li>
</ol>
</div>
</div>
<div class="section" id="optional-step-7-update-the-shared-code-in-github-to-trigger-tests">
<h2>(Optional) Step 7: Update the shared code in GitHub to trigger tests<a class="headerlink" href="#optional-step-7-update-the-shared-code-in-github-to-trigger-tests" title="Permalink to this headline"> </a></h2>
<p>In this step, you make a change to the shared code and then push the change into your GitHub repo, which immediately triggers the tests automatically, based on the GitHub Actions from the previous step.</p>
<div class="section" id="step-71-create-another-working-branch-in-the-repo">
<h3>Step 7.1: Create another working branch in the repo<a class="headerlink" href="#step-71-create-another-working-branch-in-the-repo" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In your workspace, in the <strong>Repos</strong> pane for your repo, click the <strong>first_tests</strong> branch and select <strong>main</strong>.</p></li>
<li><p>Click the <strong>Pull</strong> button. If prompted to proceed with pulling, click <strong>Confirm</strong>.</p></li>
<li><p>Click the <strong>+</strong> (<strong>Create branch</strong>) button.</p></li>
<li><p>Enter <code class="docutils literal notranslate"><span class="pre">trigger_tests</span></code>, and then press Enter. (You can give your branch a different name.)</p></li>
<li><p>Close this dialog.</p></li>
</ol>
</div>
<div class="section" id="step-72-change-the-shared-code">
<h3>Step 7.2: Change the shared code<a class="headerlink" href="#step-72-change-the-shared-code" title="Permalink to this headline"> </a></h3>
<ol class="arabic">
<li><p>In your workspace, in the <strong>Repos</strong> pane for your repo, double-click the <strong>covid_analysis/transforms.py</strong> file.</p></li>
<li><p>In the third line of this file, change this line of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter by country code.</span>
</pre></div>
</div>
<p>To this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter by country code. If not specified, use &quot;USA.&quot;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="step-73-check-in-the-change-to-trigger-the-tests">
<h3>Step 7.3: Check in the change to trigger the tests<a class="headerlink" href="#step-73-check-in-the-change-to-trigger-the-tests" title="Permalink to this headline"> </a></h3>
<ol class="arabic simple">
<li><p>In the <strong>Repos</strong> pane for your repo, click the <strong>trigger_tests</strong> branch.</p></li>
<li><p>In the <strong>best-notebooks</strong> dialog, on the <strong>Changes</strong> tab, make sure <strong>covid_analysis/transforms.py</strong> is selected.</p></li>
<li><p>For <strong>Summary (required)</strong>, enter <code class="docutils literal notranslate"><span class="pre">Updated</span> <span class="pre">comment</span></code>.</p></li>
<li><p>For <strong>Description (optional)</strong>, enter <code class="docutils literal notranslate"><span class="pre">This</span> <span class="pre">updates</span> <span class="pre">the</span> <span class="pre">comment</span> <span class="pre">for</span> <span class="pre">filter_country.</span></code></p></li>
<li><p>Click <strong>Commit &amp; Push</strong>.</p></li>
<li><p>Click <strong>History</strong>, or click <strong>Create a pull request</strong> link in the popup, and then create the pull request. Alternatively, in GitHub, click the <strong>Pull requests</strong> tab, and then create the pull request.</p></li>
<li><p>On the pull request page, wait for the icon next to <strong>Run pre-merge Databricks tests / unit-test-notebook (pull_request)</strong> to display a green check mark. (It may take a few moments for the icon to appear.) If there is a red X instead of a green check mark, click <strong>Details</strong> to find out why. If the icon or <strong>Details</strong> are no longer showing, click <strong>Show all checks</strong>.</p></li>
<li><p>If the green check mark appears, merge the pull request into the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch.</p></li>
</ol>
</div>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../_static/js/localized.js"></script>
  <script type="text/javascript" src="../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>