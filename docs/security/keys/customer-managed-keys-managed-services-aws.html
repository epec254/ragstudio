

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how to encrypt managed services with your own key, called a customer-managed key (CMK)." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Customer-managed keys for managed services">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Customer-managed keys for managed services &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/security/keys/customer-managed-keys-managed-services-aws.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/security/keys/customer-managed-keys-managed-services-aws.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/security/keys/customer-managed-keys-managed-services-aws.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" />
  <link rel="top" title="Databricks on AWS" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../../en/security/keys/customer-managed-keys-managed-services-aws.html" class="notranslate">English</option>
    <option value="../../../ja/security/keys/customer-managed-keys-managed-services-aws.html" class="notranslate">日本語</option>
    <option value="../../../pt/security/keys/customer-managed-keys-managed-services-aws.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Customer-managed keys for managed services</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="customer-managed-keys-for-managed-services">
<h1>Customer-managed keys for managed services<a class="headerlink" href="#customer-managed-keys-for-managed-services" title="Permalink to this headline"> </a></h1>
<p>To use customer-managed keys (CMK) for managed services, the workspace must be on the <a class="reference external" href="https://databricks.com/product/pricing/platform-addons">Enterprise pricing tier</a>. The workspace must also be on the <a class="reference internal" href="../../getting-started/overview.html#e2-architecture"><span class="std std-ref">E2 version of the Databricks platform</span></a> or on a custom plan that has been enabled by Databricks for this feature. All new Databricks accounts and most existing accounts are now E2.</p>
<p>For a list of regions that support customer-managed keys, see <a class="reference internal" href="../../resources/supported-regions.html"><span class="doc">Databricks clouds and regions</span></a>.</p>
<p>For support with serverless compute resources, see <a class="reference internal" href="customer-managed-keys.html#serverless"><span class="std std-ref">Serverless compute and customer-managed keys</span></a>.</p>
<div class="section" id="customer-managed-key-use-cases">
<h2>Customer-managed key use cases<a class="headerlink" href="#customer-managed-key-use-cases" title="Permalink to this headline"> </a></h2>
<p>For additional control of your data, you can add your own key to protect and control access to some types of data. Databricks has multiple customer-managed key features. To compare the related features, see <a class="reference internal" href="customer-managed-keys.html"><span class="doc">Customer-managed keys for encryption</span></a>.</p>
<p>Managed services data in the Databricks <a class="reference internal" href="../../getting-started/overview.html"><span class="doc">control plane</span></a> is encrypted at rest. You can add a customer-managed key for managed services to help protect and control access to the following types of encrypted data:</p>
<ul class="simple">
<li><p>Notebook source in the Databricks <a class="reference internal" href="../../getting-started/overview.html"><span class="doc">control plane</span></a>.</p></li>
<li><p>Notebook results for notebooks run interactively (not as jobs) that are stored in the control plane. By default, larger results are also stored in your workspace root bucket. You can configure Databricks to <a class="reference internal" href="../../administration-guide/workspace-settings/storage.html"><span class="doc">store all interactive notebook results in your cloud account</span></a>.</p></li>
<li><p>Secrets stored by the <a class="reference internal" href="../secrets/index.html"><span class="doc">secret manager APIs</span></a>.</p></li>
<li><p>Databricks SQL <a class="reference internal" href="sql-encryption.html"><span class="doc">queries and query history</span></a>.</p></li>
<li><p>Personal access tokens (PAT) or other credentials used to <a class="reference internal" href="../../repos/repos-setup.html"><span class="doc">set up Git integration with Databricks Repos</span></a>.</p></li>
</ul>
<p>After you add a customer-managed key encryption for a workspace, Databricks uses your key to control access to the key that encrypts future write operations to your workspace’s managed services data. Existing data is not re-encrypted. The data encryption key is cached in memory for several read and write operations and evicted from memory at a regular interval. New requests for that data require another request to your cloud service’s key management system. If you delete or revoke your key, reading or writing to the protected data fails at the end of the cache time interval.</p>
<p>You can rotate (update) the customer-managed key at a later time. See <a class="reference internal" href="#patch-workspace"><span class="std std-ref">Add or update a customer-managed key on a running workspace</span></a>.</p>
<p>You can optionally share a Databricks key configuration object (which references your key) between the two different encryption use cases: this feature (managed services) and <a class="reference internal" href="customer-managed-keys-storage-aws.html"><span class="doc">Customer-managed keys for workspace storage</span></a>. Note that in both cases you can add the key and its Databricks key configuration to your Databricks workspace during <a class="reference internal" href="../../administration-guide/workspace/create-workspace-api.html"><span class="doc">workspace creation</span></a> or add it later, but only managed services supports <a class="reference internal" href="#patch-workspace"><span class="std std-ref">rotating (updating) the key later</span></a>.</p>
<p>This feature does not encrypt data stored outside of the <a class="reference internal" href="../../getting-started/overview.html"><span class="doc">control plane</span></a>. Separately, you can <a class="reference internal" href="customer-managed-keys-storage-aws.html"><span class="doc">encrypt data in your root S3 bucket and cluster EBS volumes in the classic compute plane</span></a>.</p>
</div>
<div class="section" id="add-a-customer-managed-key-to-a-new-workspace">
<h2>Add a customer-managed key to a new workspace<a class="headerlink" href="#add-a-customer-managed-key-to-a-new-workspace" title="Permalink to this headline"> </a></h2>
<p>To add a customer-managed key for managed services, you must add the key when you create a workspace using the <a class="reference internal" href="../../administration-guide/workspace/create-workspace-api.html"><span class="doc">Account API</span></a>. You can also use the <a class="reference internal" href="../../dev-tools/terraform/index.html"><span class="doc">Databricks Terraform provider</span></a> and <a class="reference external" href="https://registry.terraform.io/providers/databricks/databricks/latest/docs/resources/mws_customer_managed_keys">databricks_mws_customer_managed_keys</a>.</p>
<div class="section" id="create-a-key">
<span id="key"></span><h3>Create a key<a class="headerlink" href="#create-a-key" title="Permalink to this headline"> </a></h3>
<p>To configure your customer-managed key:</p>
<ol class="arabic">
<li><p>Create or select a symmetric key in AWS KMS, following the instructions in <a class="reference external" href="https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html#create-symmetric-cmk">Creating symmetric CMKs</a> or <a class="reference external" href="https://docs.aws.amazon.com/kms/latest/developerguide/viewing-keys.html">Viewing keys</a>.</p></li>
<li><p>Copy these values. You will use them when you <a class="reference internal" href="../../administration-guide/workspace/create-workspace-api.html#cmk"><span class="std std-ref">create the workspace</span></a>:</p>
<ul class="simple">
<li><p><strong>Key ARN</strong> — Get the ARN from the console or the API (the <code class="docutils literal notranslate"><span class="pre">Arn</span></code> field in the JSON response).</p></li>
<li><p><strong>Key alias</strong> — An alias specifies a display name for the customer-managed key in AWS KMS. Use an alias to identify a customer-managed key in cryptographic operations. For more information, see the AWS documentation: <a class="reference external" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-kms-alias.html">AWS::KMS::Alias</a> and <a class="reference external" href="https://docs.aws.amazon.com/kms/latest/developerguide/programming-aliases.html">Working with aliases</a>.</p></li>
</ul>
</li>
<li><p>On the <strong>Key policy</strong> tab, switch to the policy view. Edit the key policy so that Databricks can use the key to perform encryption and decryption operations. Add the following to the key policy <code class="docutils literal notranslate"><span class="pre">&quot;Statement&quot;</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Sid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow Databricks to use KMS key for managed services in the control plane&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Effect&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Principal&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;AWS&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::414351767826:root&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;Action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;kms:Encrypt&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;kms:Decrypt&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;Resource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Condition&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;StringEquals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;aws:PrincipalTag/DatabricksAccountId&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;&lt;databricks-account-id&gt;(s)&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To retrieve your Databricks account ID, follow <a class="reference internal" href="../../administration-guide/account-settings/index.html#account-id"><span class="std std-ref">Locate your account ID</span></a>.</p>
</div>
<p>For more information, see the AWS article <a class="reference external" href="https://docs.aws.amazon.com/kms/latest/developerguide/editing-keys.html">Editing keys</a>.</p>
</li>
</ol>
</div>
<div class="section" id="register-a-key-for-a-new-workspace">
<span id="new-workspace"></span><h3>Register a key for a new workspace<a class="headerlink" href="#register-a-key-for-a-new-workspace" title="Permalink to this headline"> </a></h3>
<p>To register the key for a new workspace, follow the instructions in <a class="reference internal" href="../../administration-guide/workspace/create-workspace-api.html"><span class="doc">Create a workspace using the Account API</span></a>, specifically <a class="reference internal" href="../../administration-guide/workspace/create-workspace-api.html#cmk"><span class="std std-ref">Step 5: Configure customer-managed keys (optional)</span></a>.</p>
<p>Those instructions show how to optionally share this key for <a class="reference internal" href="customer-managed-keys-storage-aws.html"><span class="doc">encrypting workspace storage</span></a>.</p>
</div>
</div>
<div class="section" id="add-or-update-a-customer-managed-key-on-a-running-workspace">
<span id="patch-workspace"></span><h2>Add or update a customer-managed key on a running workspace<a class="headerlink" href="#add-or-update-a-customer-managed-key-on-a-running-workspace" title="Permalink to this headline"> </a></h2>
<p>You can add a customer-managed key or rotate (update) an existing customer-managed key for managed services on a running workspace by making a <code class="docutils literal notranslate"><span class="pre">PATCH</span></code> request to update the workspace with a new key configuration ID.</p>
<p>If you add a customer-managed key for managed services to a running workspace, Databricks uses it for future write operations to managed services data. Export and re-import a notebook to update its storage. Existing data is not re-encrypted.</p>
<p>There are two use cases for customer-managed encryption keys:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#"><span class="doc">Encrypt managed services</span></a>, which includes notebook and secret data in the control plane.</p></li>
<li><p><a class="reference internal" href="customer-managed-keys-storage-aws.html"><span class="doc">Encrypt workspace storage</span></a>, which includes the workspace’s root S3 bucket and optionally cluster EBS volumes.</p></li>
</ul>
<p>You can choose to configure neither, one, or both of these. If you choose to implement encryption for both uses cases, you can optionally share a key and optionally even the same configuration object for these uses cases.</p>
<p>There are important differences between these two use cases in when you can add the keys:</p>
<ul class="simple">
<li><p>For a customer-managed key for managed services, you can configure it during workspace creation, add the key to a running workspace, or rotate (update) the key later.</p></li>
<li><p>For a customer-managed key for storage, you can configure it during workspace creation or <a class="reference internal" href="customer-managed-keys-storage-aws.html#workspace-update"><span class="std std-ref">add the key to a running workspace</span></a>, but you <em>cannot</em> rotate (update) the key later.</p></li>
</ul>
<p>You can share a customer-managed key or its key configuration object across workspaces. When creating a new workspace, a key configuration can represent both encryption use cases by setting its <code class="docutils literal notranslate"><span class="pre">use_cases</span></code> field to include both enumeration values.</p>
<p>To implement one encryption use case or both encryption use cases with the same key, perform the following procedure exactly once. To add encryption for both encryption use cases with different keys, perform the procedure two times, once for each use case.</p>
<ol class="arabic">
<li><p>Create the AWS KMS key. Follow the instructions in either of the following sections, which differ only in the human-readable description field (<code class="docutils literal notranslate"><span class="pre">sid</span></code>) in the policy to identify the use case. Create the key for <a class="reference internal" href="#key"><span class="std std-ref">managed services</span></a> or <a class="reference internal" href="customer-managed-keys-storage-aws.html#key"><span class="std std-ref">workspace storage</span></a>. To share the key and configuration for both use cases, update the <code class="docutils literal notranslate"><span class="pre">sid</span></code> field accordingly.</p></li>
<li><p>To register your KMS key with Databricks, call the <a class="reference external" href="https://docs.databricks.com/api/account/introduction">create customer-managed key configuration API</a> (<code class="docutils literal notranslate"><span class="pre">POST</span> <span class="pre">/accounts/&lt;account-id&gt;/customer-managed-keys</span></code>).</p>
<p> Pass the following parameters:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">use_cases</span></code> — An array that specifies the uses cases for which to use the key, specify one or both of the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MANAGED_SERVICES</span></code>: This key encrypts managed services, which includes notebook, secret, and Databricks SQL query data in the control plane.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">STORAGE</span></code>: This key encrypts <a class="reference internal" href="customer-managed-keys-storage-aws.html"><span class="doc">workspace storage</span></a>, which includes the workspace’s DBFS root and cluster EBS volumes.</p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aws_key_info</span></code>: A JSON object with the following properties:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">key_arn</span></code>: AWS KMS key ARN. Note that Databricks infers the AWS region from the key ARN.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key_alias</span></code>: (<strong>Optional</strong>) AWS KMS key alias.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reuse_key_for_cluster_volumes</span></code>: (<strong>Optional</strong>) Used only if the <code class="docutils literal notranslate"><span class="pre">use_cases</span></code> array contains <code class="docutils literal notranslate"><span class="pre">STORAGE</span></code>, this specifies whether to also use the key to encrypt cluster EBS volumes. The default value is <code class="docutils literal notranslate"><span class="pre">true</span></code>,  which means Databricks also uses the key for cluster volumes. If you set this to <code class="docutils literal notranslate"><span class="pre">false</span></code>, Databricks does not encrypt the EBS volumes with your specified key. In that case, your Databricks EBS volumes are encrypted either with default AWS SSE encryption or if you enabled <a class="reference external" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html#encryption-by-default">AWS account-level EBS encryption by default</a>, AWS enforces account-level EBS encryption using a separate key that you provided to them. Note that if <code class="docutils literal notranslate"><span class="pre">reuse_key_for_cluster_volumes</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> and you revoke the permission for the key, it does not affect running clusters but affects new and restarted clusters.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Example request:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-n<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;https://accounts.cloud.databricks.com/api/2.0/accounts/&lt;databricks-account-id&gt;/customer-managed-keys&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">  &quot;use_cases&quot;: [&quot;MANAGED_SERVICES&quot;, &quot;STORAGE&quot;],</span>
<span class="s1">  &quot;aws_key_info&quot;: {</span>
<span class="s1">    &quot;key_arn&quot;: &quot;arn:aws:kms:&lt;region&gt;:&lt;aws-account-id&gt;:key/&lt;key-id&gt;&quot;,</span>
<span class="s1">    &quot;key_alias&quot;: &quot;my-example-key&quot;,</span>
<span class="s1">    &quot;reuse_key_for_cluster_volumes&quot;: true</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>Example response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;use_cases&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;MANAGED_SERVICES&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;STORAGE&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;customer_managed_key_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;databricks-key-config-id&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;creation_time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1586447506984</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;account_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;databricks-account-id&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;aws_key_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;key_arn&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:kms:&lt;region&gt;:&lt;aws-account-id&gt;:key/&lt;key-id&gt;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;key_alias&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my-example-key&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;reuse_key_for_cluster_volumes&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;key_region&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;region&gt;&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>From the response JSON, copy the <code class="docutils literal notranslate"><span class="pre">customer_managed_key_id</span></code>. You use that ID in the next step to set your workspace configuration object’s property <code class="docutils literal notranslate"><span class="pre">managed_services_customer_managed_key_id</span></code>, <code class="docutils literal notranslate"><span class="pre">storage_customer_managed_key_id</span></code>, or both, depending on which encryption use cases this object represents.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are planning to add the key for both CMK use cases, note that workspace storage encryption cannot be rotated (updated) after you have already set a key. Do not attempt to rotate an existing key for workspace storage.</p>
</div>
</li>
<li><p>Terminate all running clusters, pools, and SQL warehouses.</p></li>
<li><p>Update a workspace with your key configuration using the Account API. Use the Databricks <a class="reference external" href="https://docs.databricks.com/api/account/introduction">Account API</a> to update your workspace.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>After you run the key rotation command, you must keep your old KMS key available to Databricks for 24 hours.</p>
</div>
<p>Call the Account API operation to <a class="reference external" href="https://docs.databricks.com/api/account/introduction">update a workspace</a> (<code class="docutils literal notranslate"><span class="pre">PATCH</span> <span class="pre">/accounts/{account_id}/workspaces/{workspace_id}</span></code>).</p>
<p>To add the key for managed services, the only required argument is the <code class="docutils literal notranslate"><span class="pre">managed_services_customer_managed_key_id</span></code>. Set it to the JSON response when you <a class="reference internal" href="customer-managed-keys-storage-aws.html#key-config"><span class="std std-ref">registered your key configuration</span></a>.</p>
<p>For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-X<span class="w"> </span>PATCH<span class="w"> </span>-n<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;https://accounts.cloud.databricks.com/api/2.0/accounts/&lt;databricks-account-id&gt;/workspaces/&lt;workspace-id&gt;&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">  &quot;managed_services_customer_managed_key_id&quot;: &quot;&lt;databricks-key-config-id&gt;&quot;,</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you plan to add the key for both use cases, also set the <code class="docutils literal notranslate"><span class="pre">storage_customer_managed_key_id</span></code> variable to the same value.</p>
</div>
</li>
<li><p>If you are adding keys for both managed services and storage use cases, wait at least 20 mins after your API update before proceeding. During this time, you must not start any clusters or use the DBFS API. If you are only adding the key for managed services use case only, you can omit the 20 minute wait.</p></li>
<li><p>Restart any clusters, pools, and SQL warehouses that you terminated in a previous step.</p></li>
</ol>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../../_static/js/localized.js"></script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>