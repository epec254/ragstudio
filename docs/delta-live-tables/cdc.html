

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn how Databricks simplifies change data capture with Delta Live Tables and the APPLY CHANGES API" name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="Simplified change data capture with the APPLY CHANGES API in Delta Live Tables">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>Simplified change data capture with the APPLY CHANGES API in Delta Live Tables &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/delta-live-tables/cdc.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/delta-live-tables/cdc.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/delta-live-tables/cdc.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="top" title="Databricks on AWS" href="../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../en/delta-live-tables/cdc.html" class="notranslate">English</option>
    <option value="../../ja/delta-live-tables/cdc.html" class="notranslate">日本語</option>
    <option value="../../pt/delta-live-tables/cdc.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>Simplified change data capture with the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> API in Delta Live Tables</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="simplified-change-data-capture-with-the-apply-changes-api-in-delta-live-tables">
<span id="simplified-change-data-capture-with-the-apply-changes-api-in-dlt"></span><h1>Simplified change data capture with the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> API in Delta Live Tables<a class="headerlink" href="#simplified-change-data-capture-with-the-apply-changes-api-in-delta-live-tables" title="Permalink to this headline"> </a></h1>
<p>Delta Live Tables simplifies change data capture (CDC) with the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> API. Previously, the <code class="docutils literal notranslate"><span class="pre">MERGE</span> <span class="pre">INTO</span></code> statement was commonly used for processing CDC records on Databricks. However, <code class="docutils literal notranslate"><span class="pre">MERGE</span> <span class="pre">INTO</span></code> can produce incorrect results because of out-of-sequence records, or require complex logic to re-order records.</p>
<p>By automatically handling out-of-sequence records, the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> API in Delta Live Tables ensures correct processing of CDC records and removes the need to develop complex logic for handling out-of-sequence records.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> API is supported in the Delta Live Tables SQL and Python interfaces, including support for updating tables with SCD type 1 and type 2:</p>
<ul class="simple">
<li><p>Use SCD type 1 to update records directly. History is not retained for records that are updated.</p></li>
<li><p>Use SCD type 2 to retain a history of records, either on all updates or on updates to a specified set of columns.</p></li>
</ul>
<p>For syntax and other references, see:</p>
<ul class="simple">
<li><p><a class="reference internal" href="python-ref.html#cdc"><span class="std std-ref">Change data capture with Python in Delta Live Tables</span></a></p></li>
<li><p><a class="reference internal" href="sql-ref.html#cdc"><span class="std std-ref">Change data capture with SQL in Delta Live Tables</span></a></p></li>
<li><p><a class="reference internal" href="settings.html#cdc"><span class="std std-ref">Control tombstone management for SCD type 1 queries</span></a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This article describes how to update tables in your Delta Live Tables pipeline based on changes in source data. To learn how to record and query row-level change information for Delta tables, see <a class="reference internal" href="../delta/delta-change-data-feed.html"><span class="doc">Use Delta Lake change data feed on Databricks</span></a>.</p>
</div>
<div class="section" id="how-is-cdc-implemented-with-delta-live-tables">
<span id="how-is-cdc-implemented-with-dlt"></span><span id="how-is-cdc-implemented"></span><h2>How is CDC implemented with Delta Live Tables?<a class="headerlink" href="#how-is-cdc-implemented-with-delta-live-tables" title="Permalink to this headline"> </a></h2>
<p>You must specify a column in the source data on which to sequence records, which Delta Live Tables interprets as a monotonically increasing representation of the proper ordering of the source data. Delta Live Tables automatically handles data that arrives out of order. For SCD Type 2 changes, Delta Live Tables propagates the appropriate sequencing values to the <code class="docutils literal notranslate"><span class="pre">__START_AT</span></code> and <code class="docutils literal notranslate"><span class="pre">__END_AT</span></code> columns of the target table. There should be one distinct update per key at each sequencing value, and NULL sequencing values are unsupported.</p>
<p>To perform CDC processing with Delta Live Tables, you first create a streaming table, and then use an <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span> <span class="pre">INTO</span></code> statement to specify the source, keys, and sequencing for the change feed. To create the target streaming table, use the <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">OR</span> <span class="pre">REFRESH</span> <span class="pre">STREAMING</span> <span class="pre">TABLE</span></code> statement in SQL or the <code class="docutils literal notranslate"><span class="pre">create_streaming_table()</span></code> function in Python. To create the statement defining the CDC processing, use the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span></code> statement in SQL or the <code class="docutils literal notranslate"><span class="pre">apply_changes()</span></code> function in Python. For syntax details, see <a class="reference internal" href="sql-ref.html#cdc"><span class="std std-ref">Change data capture with SQL in Delta Live Tables</span></a> or <a class="reference internal" href="python-ref.html#cdc"><span class="std std-ref">Change data capture with Python in Delta Live Tables</span></a>.</p>
</div>
<div class="section" id="what-data-objects-are-used-for-delta-live-tables-cdc-processing">
<span id="what-data-objects-are-used-for-dlt-cdc-processing"></span><span id="cdc-objects"></span><h2>What data objects are used for Delta Live Tables CDC processing?<a class="headerlink" href="#what-data-objects-are-used-for-delta-live-tables-cdc-processing" title="Permalink to this headline"> </a></h2>
<p>When you declare the target table in the Hive metastore, two data structures are created:</p>
<ul class="simple">
<li><p>A view using the name assigned to the target table.</p></li>
<li><p>An internal backing table used by Delta Live Tables to manage CDC processing. This table is named by prepending <code class="docutils literal notranslate"><span class="pre">__apply_changes_storage_</span></code> to the target table name.</p></li>
</ul>
<p>For example, if you declare a target table named <code class="docutils literal notranslate"><span class="pre">dlt_cdc_target</span></code>, you will see a view named <code class="docutils literal notranslate"><span class="pre">dlt_cdc_target</span></code> and a table named <code class="docutils literal notranslate"><span class="pre">__apply_changes_storage_dlt_cdc_target</span></code> in the metastore. Creating a view allows Delta Live Tables to filter out the extra information (for example, tombstones and versions) required to handle out-of-order data. To view the processed data, query the target view. Because the schema of the <code class="docutils literal notranslate"><span class="pre">__apply_changes_storage_</span></code> table might change to support future features or enhancements, you should not query the table for production use. If you add data manually to the table, the records are assumed to come before other changes because the version columns are missing.</p>
<p>If a pipeline publishes to Unity Catalog, the internal backing tables are not accessible to users.</p>
</div>
<div class="section" id="get-data-about-records-processed-by-a-delta-live-tables-cdc-query">
<span id="get-data-about-records-processed-by-a-dlt-cdc-query"></span><h2>Get data about records processed by a Delta Live Tables CDC query<a class="headerlink" href="#get-data-about-records-processed-by-a-delta-live-tables-cdc-query" title="Permalink to this headline"> </a></h2>
<p>The following metrics are captured by <code class="docutils literal notranslate"><span class="pre">apply</span> <span class="pre">changes</span></code> queries:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">num_upserted_rows</span></code></strong>: The number of output rows upserted into the dataset during an update.</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">num_deleted_rows</span></code></strong>: The number of existing output rows deleted from the dataset during an update.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">num_output_rows</span></code> metric, which is output for non-CDC flows, is not captured for <code class="docutils literal notranslate"><span class="pre">apply</span> <span class="pre">changes</span></code> queries.</p>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline"> </a></h2>
<p>The target of the <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span> <span class="pre">INTO</span></code> query or <code class="docutils literal notranslate"><span class="pre">apply_changes</span></code> function cannot be used as a source for a streaming table. A table that reads from the target of an <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span> <span class="pre">INTO</span></code> query or <code class="docutils literal notranslate"><span class="pre">apply_changes</span></code> function must be a materialized view.</p>
</div>
<div class="section" id="scd-type-1-and-scd-type-2-on-databricks">
<span id="cdc-example"></span><h2>SCD type 1 and SCD type 2 on Databricks<a class="headerlink" href="#scd-type-1-and-scd-type-2-on-databricks" title="Permalink to this headline"> </a></h2>
<p>The following sections provide examples that demonstrate Delta Live Tables SCD type 1 and type 2 queries that update target tables based on source events that:</p>
<ol class="arabic simple">
<li><p>Create new user records.</p></li>
<li><p>Delete a user record.</p></li>
<li><p>Update user records. In the SCD type 1 example, the last <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> operations arrive late and are dropped from the target table, demonstrating the handling of out-of-order events.</p></li>
</ol>
<p>The following examples assume familiarity with configuring and updating Delta Live Tables pipelines. See <a class="reference internal" href="tutorial-pipelines.html"><span class="doc">Tutorial: Run your first Delta Live Tables pipeline</span></a>.</p>
<p>To run these examples, you must begin by creating a sample dataset. See <a class="reference internal" href="#generate-data"><span class="std std-ref">Generate test data</span></a>.</p>
<p>The following are the input records for these examples:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 13%" />
<col style="width: 18%" />
<col style="width: 24%" />
<col style="width: 20%" />
<col style="width: 24%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>operation</p></th>
<th class="head"><p>sequenceNum</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> 124</p></td>
<td><p> Raul</p></td>
<td><p> Oaxaca</p></td>
<td><p> INSERT</p></td>
<td><p> 1</p></td>
</tr>
<tr class="row-odd"><td><p> 123</p></td>
<td><p> Isabel</p></td>
<td><p> Monterrey</p></td>
<td><p> INSERT</p></td>
<td><p> 1</p></td>
</tr>
<tr class="row-even"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Tijuana</p></td>
<td><p> INSERT</p></td>
<td><p> 2</p></td>
</tr>
<tr class="row-odd"><td><p> 126</p></td>
<td><p> Lily</p></td>
<td><p> Cancun</p></td>
<td><p> INSERT</p></td>
<td><p> 2</p></td>
</tr>
<tr class="row-even"><td><p> 123</p></td>
<td><p> null</p></td>
<td><p> null</p></td>
<td><p> DELETE</p></td>
<td><p> 6</p></td>
</tr>
<tr class="row-odd"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Guadalajara</p></td>
<td><p> UPDATE</p></td>
<td><p> 6</p></td>
</tr>
<tr class="row-even"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Mexicali</p></td>
<td><p> UPDATE</p></td>
<td><p> 5</p></td>
</tr>
<tr class="row-odd"><td><p> 123</p></td>
<td><p> Isabel</p></td>
<td><p> Chihuahua</p></td>
<td><p> UPDATE</p></td>
<td><p> 5</p></td>
</tr>
</tbody>
</table>
<p>If you uncomment the final row in the example data, it will insert the following record that specifies where records should be truncated:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 12%" />
<col style="width: 12%" />
<col style="width: 26%" />
<col style="width: 32%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>operation</p></th>
<th class="head"><p>sequenceNum</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> null</p></td>
<td><p> null</p></td>
<td><p> null</p></td>
<td><p> TRUNCATE</p></td>
<td><p> 3</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the following examples include options to specify both <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> and <code class="docutils literal notranslate"><span class="pre">TRUNCATE</span></code> operations, but each of these are optional.</p>
</div>
</div>
<div class="section" id="process-scd-type-1-updates">
<span id="type1-queries"></span><h2>Process SCD type 1 updates<a class="headerlink" href="#process-scd-type-1-updates" title="Permalink to this headline"> </a></h2>
<p>The following code example demonstrates processing SCD type 1 updates:</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dlt</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>

<span class="nd">@dlt</span><span class="o">.</span><span class="n">view</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;cdc_data.users&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">create_streaming_table</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">apply_changes</span><span class="p">(</span>
  <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
  <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">],</span>
  <span class="n">sequence_by</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;sequenceNum&quot;</span><span class="p">),</span>
  <span class="n">apply_as_deletes</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;operation = &#39;DELETE&#39;&quot;</span><span class="p">),</span>
  <span class="n">apply_as_truncates</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;operation = &#39;TRUNCATE&#39;&quot;</span><span class="p">),</span>
  <span class="n">except_column_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="s2">&quot;sequenceNum&quot;</span><span class="p">],</span>
  <span class="n">stored_as_scd_type</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Create and populate the target table.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">REFRESH</span><span class="w"> </span><span class="n">STREAMING</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>

<span class="n">APPLY</span><span class="w"> </span><span class="n">CHANGES</span><span class="w"> </span><span class="k">INTO</span>
<span class="w">  </span><span class="n">live</span><span class="p">.</span><span class="n">target</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="n">stream</span><span class="p">(</span><span class="n">cdc_data</span><span class="p">.</span><span class="n">users</span><span class="p">)</span>
<span class="n">KEYS</span>
<span class="w">  </span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="n">APPLY</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">WHEN</span>
<span class="w">  </span><span class="k">operation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;DELETE&quot;</span>
<span class="n">APPLY</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">TRUNCATE</span><span class="w"> </span><span class="k">WHEN</span>
<span class="w">  </span><span class="k">operation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;TRUNCATE&quot;</span>
<span class="n">SEQUENCE</span><span class="w"> </span><span class="k">BY</span>
<span class="w">  </span><span class="n">sequenceNum</span>
<span class="n">COLUMNS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span>
<span class="w">  </span><span class="p">(</span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">sequenceNum</span><span class="p">)</span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span>
<span class="w">  </span><span class="n">SCD</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>After running the SCD type 1 example, the target table contains the following records:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 32%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> 124</p></td>
<td><p> Raul</p></td>
<td><p> Oaxaca</p></td>
</tr>
<tr class="row-odd"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Guadalajara</p></td>
</tr>
<tr class="row-even"><td><p> 126</p></td>
<td><p> Lily</p></td>
<td><p> Cancun</p></td>
</tr>
</tbody>
</table>
<p>After running the SCD type 1 example with the additional <code class="docutils literal notranslate"><span class="pre">TRUNCATE</span></code> record, records <code class="docutils literal notranslate"><span class="pre">124</span></code> and <code class="docutils literal notranslate"><span class="pre">126</span></code> are truncated because of the <code class="docutils literal notranslate"><span class="pre">TRUNCATE</span></code> operation at <code class="docutils literal notranslate"><span class="pre">sequenceNum=3</span></code>, and the target table contains the following record:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 24%" />
<col style="width: 32%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Guadalajara</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="process-scd-type-2-updates">
<span id="type2-queries"></span><h2>Process SCD type 2 updates<a class="headerlink" href="#process-scd-type-2-updates" title="Permalink to this headline"> </a></h2>
<p>The following code example demonstrates processing SCD type 2 updates:</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dlt</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>

<span class="nd">@dlt</span><span class="o">.</span><span class="n">view</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;cdc_data.users&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">create_streaming_table</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">apply_changes</span><span class="p">(</span>
  <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
  <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">],</span>
  <span class="n">sequence_by</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;sequenceNum&quot;</span><span class="p">),</span>
  <span class="n">apply_as_deletes</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;operation = &#39;DELETE&#39;&quot;</span><span class="p">),</span>
  <span class="n">except_column_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="s2">&quot;sequenceNum&quot;</span><span class="p">],</span>
  <span class="n">stored_as_scd_type</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Create and populate the target table.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">REFRESH</span><span class="w"> </span><span class="n">STREAMING</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>

<span class="n">APPLY</span><span class="w"> </span><span class="n">CHANGES</span><span class="w"> </span><span class="k">INTO</span>
<span class="w">  </span><span class="n">live</span><span class="p">.</span><span class="n">target</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="n">stream</span><span class="p">(</span><span class="n">cdc_data</span><span class="p">.</span><span class="n">users</span><span class="p">)</span>
<span class="n">KEYS</span>
<span class="w">  </span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="n">APPLY</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">WHEN</span>
<span class="w">  </span><span class="k">operation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;DELETE&quot;</span>
<span class="n">SEQUENCE</span><span class="w"> </span><span class="k">BY</span>
<span class="w">  </span><span class="n">sequenceNum</span>
<span class="n">COLUMNS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span>
<span class="w">  </span><span class="p">(</span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">sequenceNum</span><span class="p">)</span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span>
<span class="w">  </span><span class="n">SCD</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
</div>
<p>After running the SCD type 2 example, the target table contains the following records:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>__START_AT</p></th>
<th class="head"><p>__END_AT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> 123</p></td>
<td><p> Isabel</p></td>
<td><p> Monterrey</p></td>
<td><p> 1</p></td>
<td><p> 5</p></td>
</tr>
<tr class="row-odd"><td><p> 123</p></td>
<td><p> Isabel</p></td>
<td><p> Chihuahua</p></td>
<td><p> 5</p></td>
<td><p> 6</p></td>
</tr>
<tr class="row-even"><td><p> 124</p></td>
<td><p> Raul</p></td>
<td><p> Oaxaca</p></td>
<td><p> 1</p></td>
<td><p> null</p></td>
</tr>
<tr class="row-odd"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Tijuana</p></td>
<td><p> 2</p></td>
<td><p> 5</p></td>
</tr>
<tr class="row-even"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Mexicali</p></td>
<td><p> 5</p></td>
<td><p> 6</p></td>
</tr>
<tr class="row-odd"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Guadalajara</p></td>
<td><p> 6</p></td>
<td><p> null</p></td>
</tr>
<tr class="row-even"><td><p> 126</p></td>
<td><p> Lily</p></td>
<td><p> Cancun</p></td>
<td><p> 2</p></td>
<td><p> null</p></td>
</tr>
</tbody>
</table>
<p>An SCD type 2 query can also specify a subset of output columns to be tracked for history in the target table. Changes to other columns are updated in place rather than generating new history records. The following example demonstrates excluding the <code class="docutils literal notranslate"><span class="pre">city</span></code> column from tracking:</p>
<p>The following example demonstrates using track history with SCD type 2:</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dlt</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr</span>

<span class="nd">@dlt</span><span class="o">.</span><span class="n">view</span>
<span class="k">def</span> <span class="nf">users</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">spark</span><span class="o">.</span><span class="n">readStream</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;cdc_data.users&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">create_streaming_table</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>

<span class="n">dlt</span><span class="o">.</span><span class="n">apply_changes</span><span class="p">(</span>
  <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span>
  <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">],</span>
  <span class="n">sequence_by</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;sequenceNum&quot;</span><span class="p">),</span>
  <span class="n">apply_as_deletes</span> <span class="o">=</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;operation = &#39;DELETE&#39;&quot;</span><span class="p">),</span>
  <span class="n">except_column_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;operation&quot;</span><span class="p">,</span> <span class="s2">&quot;sequenceNum&quot;</span><span class="p">],</span>
  <span class="n">stored_as_scd_type</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
  <span class="n">track_history_except_column_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Create and populate the target table.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">REFRESH</span><span class="w"> </span><span class="n">STREAMING</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>

<span class="n">APPLY</span><span class="w"> </span><span class="n">CHANGES</span><span class="w"> </span><span class="k">INTO</span>
<span class="w">  </span><span class="n">live</span><span class="p">.</span><span class="n">target</span>
<span class="k">FROM</span>
<span class="w">  </span><span class="n">stream</span><span class="p">(</span><span class="n">cdc_data</span><span class="p">.</span><span class="n">users</span><span class="p">)</span>
<span class="n">KEYS</span>
<span class="w">  </span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
<span class="n">APPLY</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">WHEN</span>
<span class="w">  </span><span class="k">operation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;DELETE&quot;</span>
<span class="n">SEQUENCE</span><span class="w"> </span><span class="k">BY</span>
<span class="w">  </span><span class="n">sequenceNum</span>
<span class="n">COLUMNS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span>
<span class="w">  </span><span class="p">(</span><span class="k">operation</span><span class="p">,</span><span class="w"> </span><span class="n">sequenceNum</span><span class="p">)</span>
<span class="n">STORED</span><span class="w"> </span><span class="k">AS</span>
<span class="w">  </span><span class="n">SCD</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="mi">2</span>
<span class="n">TRACK</span><span class="w"> </span><span class="n">HISTORY</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">EXCEPT</span>
<span class="w">  </span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>After running this example without the additional <code class="docutils literal notranslate"><span class="pre">TRUNCATE</span></code> record, the target table contains the following records:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 19%" />
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>userId</p></th>
<th class="head"><p>name</p></th>
<th class="head"><p>city</p></th>
<th class="head"><p>__START_AT</p></th>
<th class="head"><p>__END_AT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p> 123</p></td>
<td><p> Isabel</p></td>
<td><p> Chihuahua</p></td>
<td><p> 1</p></td>
<td><p> 6</p></td>
</tr>
<tr class="row-odd"><td><p> 124</p></td>
<td><p> Raul</p></td>
<td><p> Oaxaca</p></td>
<td><p> 1</p></td>
<td><p> null</p></td>
</tr>
<tr class="row-even"><td><p> 125</p></td>
<td><p> Mercedes</p></td>
<td><p> Guadalajara</p></td>
<td><p> 2</p></td>
<td><p> null</p></td>
</tr>
<tr class="row-odd"><td><p> 126</p></td>
<td><p> Lily</p></td>
<td><p> Cancun</p></td>
<td><p> 2</p></td>
<td><p> null</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="generate-test-data">
<span id="generate-data"></span><h2>Generate test data<a class="headerlink" href="#generate-test-data" title="Permalink to this headline"> </a></h2>
<p>The code below is provided to generate an example dataset for use in the example queries present in this tutorial. Assuming that you have the proper credentials to create a new schema and create a new table, you can execute these statements with either a notebook or Databricks SQL. The following code is <strong>not</strong> intended to be run as part of a Delta Live Tables pipeline:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">cdc_data</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span>
<span class="w">  </span><span class="n">cdc_data</span><span class="p">.</span><span class="n">users</span>
<span class="k">AS</span><span class="w"> </span><span class="k">SELECT</span>
<span class="w">  </span><span class="n">col1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span>
<span class="w">  </span><span class="n">col2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">  </span><span class="n">col3</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">city</span><span class="p">,</span>
<span class="w">  </span><span class="n">col4</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">operation</span><span class="p">,</span>
<span class="w">  </span><span class="n">col5</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sequenceNum</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">VALUES</span>
<span class="w">  </span><span class="c1">-- Initial load.</span>
<span class="w">  </span><span class="p">(</span><span class="mi">124</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Raul&quot;</span><span class="p">,</span><span class="w">     </span><span class="ss">&quot;Oaxaca&quot;</span><span class="p">,</span><span class="w">      </span><span class="ss">&quot;INSERT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Isabel&quot;</span><span class="p">,</span><span class="w">   </span><span class="ss">&quot;Monterrey&quot;</span><span class="p">,</span><span class="w">   </span><span class="ss">&quot;INSERT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">  </span><span class="c1">-- New users.</span>
<span class="w">  </span><span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Mercedes&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Tijuana&quot;</span><span class="p">,</span><span class="w">     </span><span class="ss">&quot;INSERT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">126</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Lily&quot;</span><span class="p">,</span><span class="w">     </span><span class="ss">&quot;Cancun&quot;</span><span class="p">,</span><span class="w">      </span><span class="ss">&quot;INSERT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">  </span><span class="c1">-- Isabel is removed from the system and Mercedes moved to Guadalajara.</span>
<span class="w">  </span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">       </span><span class="k">null</span><span class="p">,</span><span class="w">          </span><span class="ss">&quot;DELETE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Mercedes&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Guadalajara&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;UPDATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">),</span>
<span class="w">  </span><span class="c1">-- This batch of updates arrived out of order. The above batch at sequenceNum 5 will be the final state.</span>
<span class="w">  </span><span class="p">(</span><span class="mi">125</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Mercedes&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Mexicali&quot;</span><span class="p">,</span><span class="w">    </span><span class="ss">&quot;UPDATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;Isabel&quot;</span><span class="p">,</span><span class="w">   </span><span class="ss">&quot;Chihuahua&quot;</span><span class="p">,</span><span class="w">   </span><span class="ss">&quot;UPDATE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">  </span><span class="c1">-- Uncomment to test TRUNCATE.</span>
<span class="w">  </span><span class="c1">-- ,(null, null,      null,          &quot;TRUNCATE&quot;, 3)</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="add-change-or-delete-data-in-a-target-streaming-table">
<span id="add-change-or-delete-data-in-a-target-st"></span><span id="streaming-tables-dml-cdc"></span><h2>Add, change, or delete data in a target streaming table<a class="headerlink" href="#add-change-or-delete-data-in-a-target-streaming-table" title="Permalink to this headline"> </a></h2>
<p>If your pipeline publishes tables to Unity Catalog, you can use <a class="reference internal" href="../sql/language-manual/index.html#dml-statements"><span class="std std-ref">data manipulation language</span></a> (DML) statements, including insert, update, delete, and merge statements, to modify the target streaming tables created by <code class="docutils literal notranslate"><span class="pre">APPLY</span> <span class="pre">CHANGES</span> <span class="pre">INTO</span></code> statements.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>DML statements that modify the table schema of a streaming table are not supported. Ensure that your DML statements do not attempt to evolve the table schema.</p></li>
<li><p>DML statements that update a streaming table can be run only in a shared Unity Catalog cluster or a SQL warehouse using Databricks Runtime 13.1 and above.</p></li>
<li><p>Because streaming requires append-only data sources, if your processing requires streaming from a source streaming table with changes (for example, by DML statements), set the <a class="reference internal" href="python-ref.html#ignore-changes"><span class="std std-ref">skipChangeCommits flag</span></a> when reading the source streaming table. When <code class="docutils literal notranslate"><span class="pre">skipChangeCommits</span></code> is set, transactions that delete or modify records on the source table are ignored. If your processing does not require a streaming table, you can use a materialized view (which does not have the append-only restriction) as the target table.</p></li>
</ul>
</div>
<p>Because Delta Live Tables uses a specified <code class="docutils literal notranslate"><span class="pre">SEQUENCE</span> <span class="pre">BY</span></code> column and propagates appropriate sequencing values to the <code class="docutils literal notranslate"><span class="pre">__START_AT</span></code> and <code class="docutils literal notranslate"><span class="pre">__END_AT</span></code> columns of the target table (for SCD type 2), you must ensure that DML statements use valid values for these columns to maintain the proper ordering of records. See <a class="reference internal" href="#how-is-cdc-implemented"><span class="std std-ref">How is CDC implemented with Delta Live Tables?</span></a>.</p>
<p>For more information about using DML statements with streaming tables, see <a class="reference internal" href="unity-catalog.html#streaming-tables-dml-statements"><span class="std std-ref">Add, change, or delete data in a streaming table</span></a>.</p>
<p>The following example inserts an active record with a start sequence of 5:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">my_streaming_table</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">__START_AT</span><span class="p">,</span><span class="w"> </span><span class="n">__END_AT</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;John Doe&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="k">NULL</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../_static/js/localized.js"></script>
  <script type="text/javascript" src="../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>