

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-US" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en-US"> <!--<![endif]-->

<head>
  <!-- cookie consent -->
  
    <!-- Combined Onetrust and Rudderstack Implementation Scripts -->
    <!-- Onetrust Initialization -->
    <script type="text/javascript" src="https://cdn.cookielaw.org/consent/92466579-1717-44d3-809d-a05fb02843ed-test/OtAutoBlock.js"></script>
    <script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="92466579-1717-44d3-809d-a05fb02843ed-test"></script>
    <link rel="stylesheet" id="db-onetrust-style" href="https://www.databricks.com/wp-content/uploads/db_onetrust.css" media="all" />
    <!-- Setting Rudderstack Write Key -->
    <script>window.rudderstackKey = "2SOR9fvSr5Fi6tN2ihPbVHnX1SZ" </script>
    <!-- Rudderstack Initialization + Onetrust Integration + Rudderstack Custom Events -->
    <script type="text/javascript" src="https://www.databricks.com/sites/default/files/rudderstack/v1/db-rudderstack-events.js"></script>

  <!-- cookie consent -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <meta content="Learn about SQL user-defined aggregate functions in the SQL language constructs supported in Databricks Runtime." name="description" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <meta property="og:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:title" content="User-defined aggregate functions (UDAFs)">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://docs.databricks.com">
  <meta property="og:description" content="" id="og-description">
  <meta name="twitter:image" content="https://www.databricks.com/wp-content/uploads/2020/04/og-databricks.png">
  <meta name="twitter:site" content="@databricks">
  <meta name="twitter:creator" content="@databricks">
  <meta property="twitter:description" content="">
  
  <title>User-defined aggregate functions (UDAFs) &#124; Databricks on AWS</title>
  
  
  <link rel="canonical" href="https://docs.databricks.com/en/sql/language-manual/sql-ref-functions-udf-aggregate.html">
  <!-- Start hreflang tag -->
  <link rel="alternate" hreflang="en" href="https://docs.databricks.com/en/sql/language-manual/sql-ref-functions-udf-aggregate.html" />
<link rel="alternate" hreflang="x-default" href="https://docs.databricks.com/en/sql/language-manual/sql-ref-functions-udf-aggregate.html" />
  <!-- End hreflang tag -->
  
  
  <link rel="shortcut icon" href="../../_static/favicon.ico" />
  

  

  

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T85FQ33');</script>
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;
j.setAttributeNode(d.createAttribute('data-ot-ignore'));
f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TWTKQQ');</script>
    
  <!-- End Google Tag Manager -->


  <!-- MaxMind / GEO IP -->
  <script src="//js.maxmind.com/js/apis/geoip2/v2.1/geoip2.js" type="text/javascript"></script>
  <!-- End MaxMind / GEO IP -->

  
  
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600&display=swap" rel="stylesheet">
  <link rel="preload" href="../../_static/fonts/DMSans-Bold.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMSans-Regular.ttf" as="font">
  <link rel="preload" href="../../_static/fonts/DMMono-Regular.ttf" as="font">
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/cloud-provider-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/translation-selector.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/searchunify/main.css" type="text/css" />

  
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" />
  <link rel="top" title="Databricks on AWS" href="../../index.html" /> 
</head>

<body class="wy-body-for-nav" role="document">

  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T85FQ33"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TWTKQQ"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  
  <nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
    
<nav class="wy-nav-top header su_header" role="navigation" aria-label="top navigation">
  <div class="container-logo">
    <ul class="mobile-menu-toggle">
        <li class="menu-toggle">
            <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
            
            <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
              alt="Databricks" /></a>   
               
              </li>
    </ul>
    <ul class="su_nav-menu">
      <li class="menu-toggle">
        <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
        
          
        
        <a href="https://www.databricks.com/" class="wy-nav-top-logo"><img src="../../_static/small-scale-lockup-full-color-rgb.svg" width="137" height="21"
            alt="Databricks" /></a></li>
        <!-- 
<li><a href="https://help.databricks.com/s/">Help Center</a></li>
<li class="active"><a href="https://docs.databricks.com/en/">Documentation</a></li>
<li><a href="https://kb.databricks.com/">Knowledge Base</a></li>
 -->
    </ul>
  </div>
  <div class="su_nav-right">
    <ul class="su_link-mobile">
  <!-- Mobile header code can go here -->
</ul>
<ul class="right-try-list">
   
</ul>
  </div>
</nav>
  </nav>

  <div class="su_sub-header">
    <div class="container">
      <div class="su_sub-header-inner">
        <!-- <div class="su_subnav-menu-right">
  <div id="auto" style="width: 100%;">
    <div ng-controller="SearchautoController">
      <div bind-html-compile="autocompleteHtml">
        <form class="su__search-box-1" disabled="disabled">
          <input class="su__search-input" type="search" name="Search box" id="su__search-b" placeholder="Search Documentation" disabled="disabled"/>
          <button class="su__search-button" type="submit" class="button button-success" disabled="disabled">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <path
                d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                fill="#333"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div> -->
        <div class="search-lng-gap"></div>
        <div style="margin-left: 16px; margin-right: 16px;">
          <!-- <select name="lng selector" id="lng-selector">
    <option value="../../../en/sql/language-manual/sql-ref-functions-udf-aggregate.html" class="notranslate">English</option>
    <option value="../../../ja/sql/language-manual/sql-ref-functions-udf-aggregate.html" class="notranslate">日本語</option>
    <option value="../../../pt/sql/language-manual/sql-ref-functions-udf-aggregate.html" class="notranslate">Português (Brasil)</option>
</select> -->
        </div>
        <div class="cloud-selector-container">
          <!-- <select name="cloud provider selector" id="cloud-provider-selector">
    <option value="aws" selected class="notranslate">
        Amazon Web Services
    </option>
    <option value="azure"  class="notranslate">
        Microsoft Azure
    </option>
    <option value="gcp"  class="notranslate">
        Google Cloud Platform
    </option>
</select> -->
        </div>
      </div>
    </div>
  </div>
  <page class="js-page-container">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side su_nav-side">
<div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    

    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home">Databricks on AWS</a>
    

    
      

      
        <p class="caption"><span class="caption-text">Load &amp; manage data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../rag-temp/index.html">RAG Studio</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    
  <p class="build_info notranslate"data-last-edit="December 23, 2023">
    Updated Jan 11, 2024
  </p>
<script>
  window.addEventListener('DOMContentLoaded',function(){
    var h1=document.querySelector('h1');
    var bi=document.querySelector('[data-last-edit]');
    if(h1 && bi){
      var ver = document.createElement('p');
      ver.className = 'version_info';
      ver.textContent = bi.getAttribute('data-last-edit');
      h1.parentElement.insertBefore(ver, h1.nextElementSibling);
    }
  });
</script>

    <p>
      
        <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
      
    </p>
  </div>
</div>
</nav>
    
    
<main class="wy-grid-for-nav su_nav-grid">
  <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
    <div class="wy-nav-content su__nav_content">
      <div class="rst-content">
        





<div role="navigation" aria-label="breadcrumbs navigation" class="wy-breadcrumbs-wrapper">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>User-defined aggregate functions (UDAFs)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
        
        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
          <div itemprop="articleBody">
            
    
  <div class="section" id="user-defined-aggregate-functions-udafs">
<h1>User-defined aggregate functions (UDAFs)<a class="headerlink" href="#user-defined-aggregate-functions-udafs" title="Permalink to this headline"> </a></h1>
<p><strong>Applies to:</strong> <img alt="check marked yes" src="../../_images/check.png" /> Databricks Runtime</p>
<p>User-defined aggregate functions (UDAFs) are user-programmable routines that act on multiple rows at once and return a single aggregated value as a result. This documentation lists the classes that are required for creating and registering UDAFs. It also contains examples that demonstrate how to define and register UDAFs in Scala and invoke them in Spark SQL.</p>
<div class="section" id="aggregator">
<h2>Aggregator<a class="headerlink" href="#aggregator" title="Permalink to this headline"> </a></h2>
<p><strong>Syntax</strong> <code class="docutils literal notranslate"><span class="pre">Aggregator[-IN,</span> <span class="pre">BUF,</span> <span class="pre">OUT]</span></code></p>
<p>A base class for user-defined aggregations, which can be used in Dataset operations to take all of the elements of a group and reduce them to a single value.</p>
<ul>
<li><p><strong>IN</strong>: The input type for the aggregation.</p></li>
<li><p><strong>BUF</strong>: The type of the intermediate value of the reduction.</p></li>
<li><p><strong>OUT</strong>: The type of the final output result.</p></li>
<li><p><strong>bufferEncoder: Encoder[BUF]</strong></p>
<p>The Encoder for the intermediate value type.</p>
</li>
<li><p><strong>finish(reduction: BUF): OUT</strong></p>
<p>Transform the output of the reduction.</p>
</li>
<li><p><strong>merge(b1: BUF, b2: BUF): BUF</strong></p>
<p>Merge two intermediate values.</p>
</li>
<li><p><strong>outputEncoder: Encoder[OUT]</strong></p>
<p>The Encoder for the final output value type.</p>
</li>
<li><p><strong>reduce(b: BUF, a: IN): BUF</strong></p>
<p>Aggregate input value <code class="docutils literal notranslate"><span class="pre">a</span></code> into current intermediate value. For performance, the function may modify <code class="docutils literal notranslate"><span class="pre">b</span></code> and return it instead of constructing new object for <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
</li>
<li><p><strong>zero: BUF</strong></p>
<p>The initial value of the intermediate result for this aggregation.</p>
</li>
</ul>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline"> </a></h2>
<div class="section" id="type-safe-user-defined-aggregate-functions">
<h3>Type-safe user-defined aggregate functions<a class="headerlink" href="#type-safe-user-defined-aggregate-functions" title="Permalink to this headline"> </a></h3>
<p>User-defined aggregations for strongly typed Datasets revolve around the <code class="docutils literal notranslate"><span class="pre">Aggregator</span></code> abstract class.
For example, a type-safe user-defined average can look like:</p>
</div>
<div class="section" id="untyped-user-defined-aggregate-functions">
<h3>Untyped user-defined aggregate functions<a class="headerlink" href="#untyped-user-defined-aggregate-functions" title="Permalink to this headline"> </a></h3>
<p>Typed aggregations, as described above, may also be registered as untyped aggregating UDFs for use with DataFrames.
For example, a user-defined average for untyped DataFrames can look like:</p>
<div class="js-code-language-tabs js-code-language-tabs--literal compound">
<div class="compound-first highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.{</span><span class="nc">Encoder</span><span class="p">,</span><span class="w"> </span><span class="nc">Encoders</span><span class="p">,</span><span class="w"> </span><span class="nc">SparkSession</span><span class="p">}</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="nn">expressions</span><span class="p">.</span><span class="nc">Aggregator</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org</span><span class="p">.</span><span class="nn">apache</span><span class="p">.</span><span class="nn">spark</span><span class="p">.</span><span class="nn">sql</span><span class="p">.</span><span class="n">functions</span>

<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Average</span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="n">sum</span><span class="p">:</span><span class="w"> </span><span class="nc">Long</span><span class="p">,</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="n">count</span><span class="p">:</span><span class="w"> </span><span class="nc">Long</span><span class="p">)</span>

<span class="k">object</span><span class="w"> </span><span class="nc">MyAverage</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Aggregator</span><span class="p">[</span><span class="nc">Long</span><span class="p">,</span><span class="w"> </span><span class="nc">Average</span><span class="p">,</span><span class="w"> </span><span class="nc">Double</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// A zero value for this aggregation. Should satisfy the property that any b + zero = b</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">zero</span><span class="p">:</span><span class="w"> </span><span class="nc">Average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Average</span><span class="p">(</span><span class="il">0L</span><span class="p">,</span><span class="w"> </span><span class="il">0L</span><span class="p">)</span>
<span class="w">  </span><span class="c1">// Combine two values to produce a new value. For performance, the function may modify `buffer`</span>
<span class="w">  </span><span class="c1">// and return it instead of constructing a new object</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span><span class="w"> </span><span class="nc">Average</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">Long</span><span class="p">):</span><span class="w"> </span><span class="nc">Average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">data</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">buffer</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Merge two intermediate values</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">b1</span><span class="p">:</span><span class="w"> </span><span class="nc">Average</span><span class="p">,</span><span class="w"> </span><span class="n">b2</span><span class="p">:</span><span class="w"> </span><span class="nc">Average</span><span class="p">):</span><span class="w"> </span><span class="nc">Average</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">b1</span><span class="p">.</span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b2</span><span class="p">.</span><span class="n">sum</span>
<span class="w">    </span><span class="n">b1</span><span class="p">.</span><span class="n">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b2</span><span class="p">.</span><span class="n">count</span>
<span class="w">    </span><span class="n">b1</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Transform the output of the reduction</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">finish</span><span class="p">(</span><span class="n">reduction</span><span class="p">:</span><span class="w"> </span><span class="nc">Average</span><span class="p">):</span><span class="w"> </span><span class="nc">Double</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reduction</span><span class="p">.</span><span class="n">sum</span><span class="p">.</span><span class="n">toDouble</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">reduction</span><span class="p">.</span><span class="n">count</span>
<span class="w">  </span><span class="c1">// The Encoder for the intermediate value type</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">bufferEncoder</span><span class="p">:</span><span class="w"> </span><span class="nc">Encoder</span><span class="p">[</span><span class="nc">Average</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Encoders</span><span class="p">.</span><span class="n">product</span>
<span class="w">  </span><span class="c1">// The Encoder for the final output value type</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">outputEncoder</span><span class="p">:</span><span class="w"> </span><span class="nc">Encoder</span><span class="p">[</span><span class="nc">Double</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Encoders</span><span class="p">.</span><span class="n">scalaDouble</span>
<span class="p">}</span>

<span class="c1">// Register the function to access it</span>
<span class="n">spark</span><span class="p">.</span><span class="n">udf</span><span class="p">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;myAverage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">functions</span><span class="p">.</span><span class="n">udaf</span><span class="p">(</span><span class="nc">MyAverage</span><span class="p">))</span>

<span class="kd">val</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">read</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;json&quot;</span><span class="p">).</span><span class="n">load</span><span class="p">(</span><span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s">&quot;employees&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT myAverage(salary) as average_salary FROM employees&quot;</span><span class="p">)</span>
<span class="n">result</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
</div>
<div class="compound-middle highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.Dataset</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.Encoder</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.Encoders</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.Row</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.SparkSession</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.expressions.Aggregator</span><span class="p">;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.spark.sql.functions</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Average</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Constructors, getters, setters...</span>

<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyAverage</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Aggregator</span><span class="o">&lt;</span><span class="n">Long</span><span class="p">,</span><span class="w"> </span><span class="n">Average</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// A zero value for this aggregation. Should satisfy the property that any b + zero = b</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Average</span><span class="w"> </span><span class="nf">zero</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Average</span><span class="p">(</span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Combine two values to produce a new value. For performance, the function may modify `buffer`</span>
<span class="w">  </span><span class="c1">// and return it instead of constructing a new object</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Average</span><span class="w"> </span><span class="nf">reduce</span><span class="p">(</span><span class="n">Average</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">newSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">getSum</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">newCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="na">getCount</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="na">setSum</span><span class="p">(</span><span class="n">newSum</span><span class="p">);</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="na">setCount</span><span class="p">(</span><span class="n">newCount</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Merge two intermediate values</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Average</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">Average</span><span class="w"> </span><span class="n">b1</span><span class="p">,</span><span class="w"> </span><span class="n">Average</span><span class="w"> </span><span class="n">b2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mergedSum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b1</span><span class="p">.</span><span class="na">getSum</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b2</span><span class="p">.</span><span class="na">getSum</span><span class="p">();</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">mergedCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b1</span><span class="p">.</span><span class="na">getCount</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b2</span><span class="p">.</span><span class="na">getCount</span><span class="p">();</span>
<span class="w">    </span><span class="n">b1</span><span class="p">.</span><span class="na">setSum</span><span class="p">(</span><span class="n">mergedSum</span><span class="p">);</span>
<span class="w">    </span><span class="n">b1</span><span class="p">.</span><span class="na">setCount</span><span class="p">(</span><span class="n">mergedCount</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">b1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Transform the output of the reduction</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Double</span><span class="w"> </span><span class="nf">finish</span><span class="p">(</span><span class="n">Average</span><span class="w"> </span><span class="n">reduction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="w"> </span><span class="n">reduction</span><span class="p">.</span><span class="na">getSum</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">reduction</span><span class="p">.</span><span class="na">getCount</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// The Encoder for the intermediate value type</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Average</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">bufferEncoder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Encoders</span><span class="p">.</span><span class="na">bean</span><span class="p">(</span><span class="n">Average</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// The Encoder for the final output value type</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Encoder</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">outputEncoder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Encoders</span><span class="p">.</span><span class="na">DOUBLE</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Register the function to access it</span>
<span class="n">spark</span><span class="p">.</span><span class="na">udf</span><span class="p">().</span><span class="na">register</span><span class="p">(</span><span class="s">&quot;myAverage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">functions</span><span class="p">.</span><span class="na">udaf</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyAverage</span><span class="p">(),</span><span class="w"> </span><span class="n">Encoders</span><span class="p">.</span><span class="na">LONG</span><span class="p">()));</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">read</span><span class="p">().</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;json&quot;</span><span class="p">).</span><span class="na">load</span><span class="p">(</span><span class="s">&quot;examples/src/main/resources/employees.json&quot;</span><span class="p">);</span>
<span class="n">df</span><span class="p">.</span><span class="na">createOrReplaceTempView</span><span class="p">(</span><span class="s">&quot;employees&quot;</span><span class="p">);</span>
<span class="n">df</span><span class="p">.</span><span class="na">show</span><span class="p">();</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |   name|salary|</span>
<span class="c1">// +-------+------+</span>
<span class="c1">// |Michael|  3000|</span>
<span class="c1">// |   Andy|  4500|</span>
<span class="c1">// | Justin|  3500|</span>
<span class="c1">// |  Berta|  4000|</span>
<span class="c1">// +-------+------+</span>

<span class="n">Dataset</span><span class="o">&lt;</span><span class="n">Row</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spark</span><span class="p">.</span><span class="na">sql</span><span class="p">(</span><span class="s">&quot;SELECT myAverage(salary) as average_salary FROM employees&quot;</span><span class="p">);</span>
<span class="n">result</span><span class="p">.</span><span class="na">show</span><span class="p">();</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |average_salary|</span>
<span class="c1">// +--------------+</span>
<span class="c1">// |        3750.0|</span>
<span class="c1">// +--------------+</span>
</pre></div>
</div>
<div class="compound-last highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Compile and place UDAF MyAverage in a JAR file called `MyAverage.jar` in /tmp.</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">myAverage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;MyAverage&#39;</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">JAR</span><span class="w"> </span><span class="s1">&#39;/tmp/MyAverage.jar&#39;</span><span class="p">;</span>

<span class="k">SHOW</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">FUNCTIONS</span><span class="p">;</span>
<span class="o">+</span><span class="c1">------------------+</span>
<span class="o">|</span><span class="w">          </span><span class="k">function</span><span class="o">|</span>
<span class="o">+</span><span class="c1">------------------+</span>
<span class="o">|</span><span class="w"> </span><span class="k">default</span><span class="p">.</span><span class="n">myAverage</span><span class="o">|</span>
<span class="o">+</span><span class="c1">------------------+</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TEMPORARY</span><span class="w"> </span><span class="k">VIEW</span><span class="w"> </span><span class="n">employees</span>
<span class="k">USING</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="k">sql</span><span class="p">.</span><span class="n">json</span>
<span class="k">OPTIONS</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">path</span><span class="w"> </span><span class="ss">&quot;examples/src/main/resources/employees.json&quot;</span>
<span class="p">);</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------+------+</span>
<span class="o">|</span><span class="w">   </span><span class="n">name</span><span class="o">|</span><span class="n">salary</span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+</span>
<span class="o">|</span><span class="n">Michael</span><span class="o">|</span><span class="w">  </span><span class="mi">3000</span><span class="o">|</span>
<span class="o">|</span><span class="w">   </span><span class="n">Andy</span><span class="o">|</span><span class="w">  </span><span class="mi">4500</span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">Justin</span><span class="o">|</span><span class="w">  </span><span class="mi">3500</span><span class="o">|</span>
<span class="o">|</span><span class="w">  </span><span class="n">Berta</span><span class="o">|</span><span class="w">  </span><span class="mi">4000</span><span class="o">|</span>
<span class="o">+</span><span class="c1">-------+------+</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">myAverage</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">average_salary</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------------+</span>
<span class="o">|</span><span class="n">average_salary</span><span class="o">|</span>
<span class="o">+</span><span class="c1">--------------+</span>
<span class="o">|</span><span class="w">        </span><span class="mi">3750</span><span class="p">.</span><span class="mi">0</span><span class="o">|</span>
<span class="o">+</span><span class="c1">--------------+</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="related-statements">
<h2>Related statements<a class="headerlink" href="#related-statements" title="Permalink to this headline"> </a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="sql-ref-functions-udf-scalar.html"><span class="doc">Scalar user defined functions (UDFs)</span></a></p></li>
<li><p><a class="reference internal" href="sql-ref-functions-udf-hive.html"><span class="doc">Integration with Hive UDFs, UDAFs, and UDTFs</span></a></p></li>
</ul>
</div>
</div>


    
          </div>
        </div>
        <div  class="suapp-rating">
  <div id="suPageRateApp">
     <su-app></su-app>
   </div> 
 </div>
<hr> 
<footer>
  <div role="contentinfo">
      <p class="copyright">
          &copy; Databricks 2023. All rights reserved. Apache, Apache Spark, Spark, and the Spark logo are trademarks of the <a href="http://www.apache.org/">Apache Software Foundation</a>.
      </p>
      <p> 
        
          <a id='feedbacklink' href="mailto:doc-feedback@databricks.com?subject=Documentation Feedback">Send us feedback</a>
        
     | <a href="https://databricks.com/privacy-policy">Privacy Policy</a> | <a href="https://databricks.com/terms-of-use">Terms of Use</a></p>

  </div> 

</footer>
      </div>
    </div>
  </section>
</main>

  </page>
  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT: '../../',
      VERSION: '1.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      HAS_SOURCE: 'false'
    };
  </script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/language_data.js"></script>
  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  <!-- Select2 (https://select2.org/) -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- End Select2 -->

  
  
  <script type="text/javascript" src="../../_static/js/localized.js"></script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  
 



  <script>
  window.__searchunifyLoaderConfig = JSON.parse('{"clients": {"en": "02c2e804-27e9-11ee-aefb-0242ac120011", "ja": "6a42c3f2-2820-11ee-aefb-0242ac120011", "pt": "6a86badd-2821-11ee-aefb-0242ac120011"}}')
</script>
<script type="text/javascript" src="../../_static/js/search-loader.js"></script>
</body>
<script type='text/javascript'>
  window.onload = function () {
    var description = document.querySelector('meta[name="description"]').getAttribute("content");
    let titleText = document.querySelector('h1').textContent;
    document.querySelector('meta[property="og:title"]').setAttribute("content", titleText);
    document.querySelector('meta[property="og:description"]').setAttribute("content", description);
    document.querySelector('meta[property="twitter:description"]').setAttribute("content", description);
  };
</script>

</html>